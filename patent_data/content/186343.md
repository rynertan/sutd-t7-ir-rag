# TRANSMITTING SEQUENCE NUMBERS OF INFORMATION IN A PACKET DATA TRANSMISSION SYSTEM

## Claims
Verfahren zum Übertragen von Folgenummern 52, 54 von Informationspaketen in einem Paketdaten Sendesystem, in welchem Informationspakete und Steuerpakete gesendet werden, wobei jedes Paket ein Steuerfeld 25 enthält mit einem Bit, dessen Zustand anzeigt, ob das Paket ein Informationspaket oder ein Steuerpaket ist, jedes Informationspaket ein Informationsfeld 28 enthält und eine Folgenummer 50 des Informationspakets in seinem Steuerfeld enthält, das Steuerfeld 40 mindestens einiger Steuerpakete mindestens ein Längenbit L1, L2 enthält, dessen Zustand anzeigt, welche aus einer Vielzahl von unterschiedlichen Größen von Folgenummern 52, 54 benutzt wird, alle Folgenummern die gleiche Größe haben, und das Verfahren dadurch gekennzeichnet ist, daß es den Schritt enthält, daß bei einer individuellen Übertragungsverbindung in dem System beim Errichten der Verbindung die Folgenummergröße bestimmt wird durch Messen der Runddurchlauf Verzögerung D für das Senden eines Pakets über die Verbindung und die Größe in Abhängigkeit von der gemessenen Verzögerung D und der Übertragungs Geschwindigkeit T der Verbindung bestimmt wird.

## Description
This invention relates to packet data transmission system, and is particularly concerned with methods of transmitting sequence numbers of information packets in such systems. It is well known to provide a packet data transmission system in which information is transmitted in packets in accordance with a predetermined framing procedure. For example, HDLC High Level Data Link Control frames may be transmitted, each of which includes an opening flag having a predetermined unique form, control and information fields, a frame check cyclic redundancy check sequence, and a closing flag which is the same as the opening flag. The HDLC protocol is disclosed in the ISO standard TC 97 SC6N 1963, Sept. 1970. With increasing use of an demand for data transmission services, it is desirable to increase the throughput of packets transmitted via a packet data transmission system. This can be achieved by increasing the transmission speed on point to point transmission links, which may be satellite or terrestrial links. This measure, especially when using satellite transmission links involving round trip delays, drastically increases the number of packets which are flight , i.e. have been transmitted but for which an acknowledgement has not been received, at any instant. An analysis of HDLC normal response mode is disclosed by T. Raith and H. L. Tonong in It is known to acknowledge each information packet which is correctly received from the transmission link by sending back a sequence number of the received information packet, this constituting a positive acknowledgement ACK that this packet and all preceding packets have been correctly received. In addition, a negative acknowledgement NAK indicating that a packet has been incorrectly received can be returned so that the transmitting end is advised of any information packet which is unsuccessfully transmitted. Such a packet is subsequently retransmitted. If the retransmitted packet has the sequence number of the original packet, this procedure is only effective if there is not more than one negatively acknowledged outstanding at any time. If more then one packet at any time is in error, the procedure fails and the transmission link must be reset, with retransmission of all packets which have not been acknowledged. If retransmitted packets are assigned new sequence numbers, the procedure fails if there are two consecutive information packets in error. A packet may contain several thousand bits, an error in any one of which results in the frame check at the receiving end failing so that the packet must be discarded and negatively acknowledged so that it can be retransmitted, the packet error rate on a transmission link which is prone to errors can be very high. With a large number of packets in flight, such a transmission link would have to be frequently reset with the above procedure, rendering it very ineffective for data transmission. Accordingly, a need exits for an improved control procedure for protocol for the transmission and acknowledgement of information packets in a packet data transmission system, which is particularly suitable for use with such systems having long round trip delays and or high transmission rates. Furthermore, such a procedure is desired to handle both short and long packets efficiently, and to accommodate unbalanced information rates for the two directions of transmission. At the same time, such a procedure is desirably usable efficiently on all transmission links of arbitrary speed and delay, so that a single procedure can be used consistently on many varied packet data transmission systems. According to one aspect of this invention there is provided a method of transmitting sequence numbers of information packets in a packet data transmission system in which information packets and control packets are transmitted, each packet including a control field including a bit whose state indicates whether the packet is an information packet or control packet, each information packet including an information field and including a sequence number of the information packet in its control filed, the control field of at least some of the control packet including at least one length bit whose state indicates which one of a plurality of different sizes of sequence numbers is used, all of the sequence numbers having the same size, the method including the step of determining the sequence number size by measuring the round trip delay for D for transmission of a packet via the link and determining said size in dependence upon the measured delay D and the transmission speed T of the link. The round trip delay D is conveniently measured by transmitting a first predetermined control packet, transmitting a second predetermined control packet in response to receipt of the first predetermined control packet from the far end, and timing the delay D from the transmission of the first predetermined control packet until receipt of the second predetermined control packet. Advantageously the control field of at least some, and conveniently all, of the control packets includes at least one length bit whose state indicates which one of a plurality of different sizes of sequenced numbers is used, all of the sequence numbers having the same size. Preferably there are at least two length bits for representing at least three different sizes of sequence numbers. This feature results in the advantage that the sequence number size used on any particular packet data transmission link can be adaptively adjusted, on set up of the link, to the transmission speed and round trip delay of the link. Thus a short, slow link can have a small sequence number size for efficient transmission of sequence numbers, while long, fast links can have a large sequence number size to accommodate the large number of packets which may be flight at any instant. To facilitate providing this feature, the method preferably includes the step of determining the sequence number size by measuring the round trip delay D for transmission of a packet via the packet data transmission system, and determining the sequence number size in dependence upon the measured delay D and the transmission speed T of the system. The sequence number size is conveniently determined to be the smallest of said plurality of different sizes which can hold a number T.D B, here B is a predetermined integer. B is preferably an integral power of 2 for convenience, for example B 128, and actually represents a conservative or low value of the average number of bits per packet. The invention will be further understood from the following description of an embodiment thereof with reference to the accompanying drawings, in which Fig.1 shows two packet data noes 10 of a two level datagram under a virtual circuit packet data transmission system to which the invention is applicable. Transmission of packet data in both directions between the nodes 10 is effected via a satellite transmission link, via a satellite 12, as shown in solid lines or via a terrestrial transmission link as shown in broken lines. The bit rate on the transmission links may fall anywhere within a wide range, for example from 9600b s to 44Mb s, and the round trip delay for transmission between the nodes may be from a few milliseconds for a short terrestrial transmission link to about 600ms per hop for a satellite transmission link i.e. more than 1 second for a two hop satellite transmission link . Fig. 2 shows parts of each node 10, and illustrates the transmission of information packets in the two directions on the transmission link. Each node 10 includes transmit and receive packet buffers 14 and 16 respectively, and processing means 18 for cyclic redundancy checking of the received packets and sending a positive acknowledgement ACK in response to each each correctly received information packet. If a received information packet contains an error it is discarded and a negative acknowledgement NAK is subsequently transmitted in respect of the incorrect packet. The manner in which such acknowledgements are transmitted is described in detail below. To facilitate identifying packets for such acknowledgements, each information packet has an assigned sequence number, the sequence numbers being independent for the two transmission directions. Fig. 2 illustrates by way of example information packets having sequence numbers 25 and 26 being transmitted in one direction, and information packets having sequence numbers 12 to 15 being transmitted in the opposite direction, on the transmission link, the packets having arbitrary and varying lengths. Each packet is transmitted on the transmission link in the form of a serial bit sequence forming a frame. The frame format is illustrated in Fig. 3. As shown in Fig. 3, each frame is similar to an HDLC frame in that it is defined by an opening flag 20 and a closing flag 22, each of which is constituted by the 8 bit sequence 01111110 which does not occur in the frame between the flags. The closing flag 22 is immediately preceded by a 16 bit cyclic redundancy check sequence 24, which is produced and serves in known manner to enable errors in transmission of the frame to be detected at the receiving end of the transmission link. The opening flag 20 is followed by a control field 26 which is described in detail below. Except in the case of control packets as described below, the control field 26 is followed by an information field 28 comprising the information which is intended to be transmitted by the packet. In the following description the control fields 26 and information fields 28 are both assumed to have lengths which are multiples of 8 bits, an 8 bit sequence being referred to below for convenience as a byte. These fields, and each of the other fields of each packet, may generally, however, have lengths which need not be multiples of 8 bits. The information field 28, in particular, may have any arbitrary number of bits within the limits imposed by a maximum packet size. In this embodiment of the invention, each control field comprises from 1 to 6 bytes, as described below with reference to Figs. 4 and 5. Fig. 4 shows control fields 26 of control packets, which have no information field 28. A control packet is distinguished in that the first bit, as illustrated in Figs. 4 and 5, of the first byte of the control field is 0. Conversely, Fig. 5 shows control fields 26 of information packets, which have information fields 28 of arbitrary length following the control fields as shown in Fig. 3. The first bit, as illustrated in Fig. 5, of the first byte of each information packet control field is 1. Although reference is made here to a particular order of bits within each byte of the control fields, it should be understood that this order is chosen for descriptive convenience, and the actual order of bits within the bytes can be different from this to facilitate processing of the control fields. Before describing the control fields of the control and information packets in further detail, it is expedient to describe a feature of the invention relating to the sequence numbers of the transmitted packets. As already described, for each transmission direction, each information packet is assigned a sequence number. This sequence number is transmitted as part of the control field of the information packet, and the sequence numbers are cyclically re used. As each packet must be uniquely identifiable, so that it can be retransmitted with a new sequence number if it is received with an error, there must be more sequence numbers than there are packets in flight. The size of the sequence number i.e. the number of bits required to represent the sequence number thus depends on the size of the packets, the transmission rate, and the round trip delay on the transmission link. Clearly, the sequence number size must be much bigger for a high speed satellite transmission link transmitting short packets, on which there are many packets in flight at any instant, than for a short low speed terrestrial transmission link on which very few packets will be in flight at any instant. Whilst it would be possible to determine the sequence number size based on the largest sequence number needed for a high speed multiple hop satellite transmission link transmitting short packets, and to use this sequence number size for all transmission links, this would be inefficient for the majority of cases involving lower transmission rates, shorter round trip delays, and or longer packets. In accordance with this invention, therefore, a variable sequence number size is used, determined for any individual transmission link in the manner described below on set up of the link. In this embodiment, the sequence number is either 5, 13, or 21 bits long, depending on the particular transmission link over which it is used. Thus for a short, low speed transmission link, a 5 bit sequence number is transmitted in 5 bits of one byte of the control field of each information packet. For increasingly faster and longer greater round trip delay transmission links, these 5 bits are supplemented by the 8 bits of one or two additional bytes of the control field, depending on the largest sequence number required. Referring again to Fig. 5, which shows two possible forms of the control field 26 of an information packet, the packet sequence number is identified by asterisks occupying the last 5 bit positions of the first byte of the control field, corresponding to the minimum 5 bit size of the sequence number. The control field 26 is optionally supplemented with one or two further bytes 50, each of which serves to extend the sequence number size by a further 8 bits to 13 or 21 bits respectively to accommodate the larger sequence numbers discussed above. As these further bytes are provided selectively on the basis of need, they are shown in broken lines in Fig. 5, the contents of each byte being indicated by a single asterisk for each byte. The remaining, second and third as illustrated, bits of the first byte of the control field of each information bit are constituted respectively by a type bit, which is either 0 or 1 as illustrated and whose function is explained below, and an extension bit E which is reserved for future extensions and which is not used in this embodiment. For example, the extension bit E could be used to indicate the presence at the end of the control field 26 of an additional field carrying address information for multipoint trunks on a local area network. In general, correctly received packets are acknowledged by each node by piggybacking the acknowledgements onto the control fields of information packets which are being transmitted. However, this piggybacking is effected selectively to provide for efficient transmission of acknowledgements between the nodes. The type bit in the first byte of the control field of each information packet serves to indicate whether or not an acknowledgement is piggybacked onto the control field. In the upper diagram in Fig. 5, there is no piggybacked acknowledgement and this type bit the second bit as shown is 0. Such a situation will occur when, for example, a node is transmitting more information packets than it is receiving, so that not all of the information packets being transmitted need to carry acknowledgements. In the lower diagram in Fig. 5, the type bit is 1 and an acknowledgement, comprising at least one byte 52 and possibly 1 or 2 further bytes 54, is piggybacked onto the control field. The byte 52 comprises three bits P1, P2, and P3 which are discussed below, and 5 bits marked which constitute at least part of the sequence number of the received packet being acknowledged. This is a different number from the transmit sequence number contained earlier in the control field and which represents the sequence number of the information packet which is being transmitted, in view of the independent sequence numbering in the two directions of transmission. However, the size of the sequence number, namely 5, 13, or 21 bits with respectively 0, 1, or 2 further bytes 54, is determined in exactly the same manner as the size of the transmit sequence number. Thus in a piggybacked control field 26 of an information packet there are either 2 bytes with a sequence number size of 5 bits for each direction, or 4 bytes with a sequence number size of 13 bits for each direction, or 6 bytes with a sequence number size of 21 bits for each direction. As any packet which is received with any bit in error is discarded, the sequence numbers of any packets which are to be negatively acknowledged are not known. The receive sequence number in the piggybacked control field is, therefore, a positive acknowledgement of the receipt of the relevant packet. The three bits P1, P2, and P3 in the byte 52 represent the acknowledgement status of the three packets received immediately preceding the received packet whose sequence number is being sent each of these bits is 0 to constitute a positive acknowledgement ACK or 1 to represent a negative acknowledgement NAK for the respective packet. It follows that up to 3 consecutive packets can be in error without the transmission link having to be reset. If a node is receiving more information packets than it is transmitting, then even piggybacking an acknowledgement onto the control field of each trasnmitted information packet may be insufficient to acknowledge all received information packets. It is noted, however, that using the bits P1, P2, and P3 information packets which have been correctly received can conceivably be positively acknowledged without sending their receive sequence numbers . In this case, the node can separately acknowledge received packets by transmitting control packets each of which has a control field 26 and no information field 28 which has the form shown in the middle diagram of Fig. 4, referred to as an acknowledgement control field. As already explained, the first bit as illustrated of the first byte of the control field of a control packet is 0, representing that this is a control packet having no information field 28. The second bit as illustrated is a type bit which is 1, as shown in the middle diagram of Fig. 5, for an acknowledgement control field and is 0, as shown in the upper and lower diagrams of Fig. 5, for other control packets which are discussed further below. The third bit is an extension bit E which is reserved for future extension purposes. This is unused in this embodiment, but for example could be used in acknowledgement control fields to indicate the presence of multiple acknowledgements in a single control packet. The fourth and fifth bits L1 and L2 are length bits which relate to the size of the sequence numbers these are discussed further below. The remaining 3 bits of the first byte of the control field are version bits V, which represent a version number of the protocol and in this case are all 0. The first byte of an acknowledgement control field type bit 1 is followed by 1, 2, or 3 acknowledgement bytes which are formed in exactly the same manner as the bytes 52 and 54 described above, and are accordingly given the same references in the middle diagram of Fig. 4. The first byte of other control fields of control packets, referred to as code control fields, is followed by a byte 40 which may be followed by other bytes, depending on the code which contains four 0 bits which are not used in this embodiment but are reserved for future extensions, followed by a 4 bit control code. The following table lists in order of decreasing precedence various control codes which are used in this embodiment of the invention. It is noted that a code of four 0 bits is deemed illegal and is not used, and that other control codes not listed here may be defined. The upper diagram in Fig. 4 shows a general form of the code control field. The lower diagram of Fig. 4 shows a flow control field in which the 4 bit control code in the second byte of the field is 100M, where as shown by the above table M is 0 for the command and 1 for the response. For this field, this second byte 40 is followed by 1, 2, or 3 further bytes 42, 44, depending on the sequence number size in the same manner as already explained. The first further byte 42 contains three 0 bits which are unused, followed by a 5 bit which may be extended to 13 or 21 bits by the addition of the further bytes 44 window size which is represented by the symbol . The window size is the maximum number of packets which are allowed to be in flight, i.e. transmitted but not yet acknowledged, in the relevant transmission direction at any instant. One or both of the further bytes 44 are provided or not, as the case may be, depending on whether or not the further bytes 50 and 54 are provided for the particular transmission link. Having described the form of the control fields, the manner in which the transmission link is set up and the sequence number size for the link is determined during this set up is described below. The length bits L1 and L2 are present in the first byte of the control field of each control packet, but need not necessarily be checked in each packet. These bits have the values 01, 10, or 11 the values 00 are not valid to represent that the sequence numbers and window sizes are respectively short i.e. no bytes 50, 54, and 44 are present , extended i.e. 1 byte 50, 54, or 44 is added in each case , or long i.e. 2 bytes 50, 54, or 44 are added in each case . As initially the required sequence number size is not known, at the start of the set up procedure described below the length bits are both set to 1 long so that the largest sequence number size is initially used. For set up, each node initially measures the transmission speed of the transmission link in known manner, and subsequently transmits control packets with the UP control code. On receipt of an UP control code packet, each node resets its transmission link control if this has not already been done during its own self testing, and transmits READY control code packets. Receipt of a READY control code packet from the far end means that both nodes are then ready to perform a round trip transmission link delay measurement. For the delay measurement, each node transmits a DMP control code packet, and times the delay until a DMR control code packet is received. In response to receipt of a DMP control code packet, each node returns a DMR control code packet as quickly as possible. A time out period of 1.5 seconds is allowed within which to receive the returned DMR control code packet. Each node then determines a field number F from the equation F T.D B, where T is the measured transmission speed in bits second, D is the measured round trip delay in seconds, and B is a conservative i.e. low value of the number of bits per packet. B is a predetermined integer, selected to be an integral power of 2 for convenience, and for example is selected to be 128. The field number F is used to determine new values for the length bits L1 and L2. If F is not greater than 32, short sequence numbers 5 bits, 2⁵ 32 are used and the length bits L1, L2 are set to 01. If F is greater than 32 but not greater than 8192, extended sequence numbers 13 bits, 2¹³ 8192 are used and the length bits L1, L2 are set to 10. If F is greater than 8192, long sequence numbers 21 bits are used and the length bits L1, L2 remain 11. After each node has determined the length bits L1 and L2 in this manner, it transmits LCC control code packets using the new length bits until it receives an LCR control code packet, in which it checks that the received length bits are the same as those transmitted. In response to an LCC control code packet, it transmits an LCR control code packet using its determined length bits. Thus a length bit check is carried out to ensure that the nodes determine the same length bits. If this check fails, the delay is remeasured by each node and the above process is repeated. After a repeated number of length check failures, the larger sequence number size is adopted. Finally, the set up procedure is completed by each node setting the P1, P2, and P3 bits to 0, representing positive acknowledgements which, when they are received by the far end node, have no effect because the node s transmit buffer is empty at this time. During operation, transient errors may occur which cause a node to stop transmitting information packets and instead to transmit AYT control code packets. On receipt of an AYT control code packet, a node responds with a YIA control code packet. If the first node receives a YIA control code packet in response, it checks the length bits L1 and L2 in the received YIA code control field, restarts its transmit sequence numbering, and retransmits all unacknowledged packets. The traffic flow in the opposite direction is unaffected. If no YIA control code packet is received within a time out period, which is for example 0.3 seconds greater than the measured round trip delay, then the above set up procedure is repeated. Although a particular embodiment of the invention has been described in detail, it should be understood that numerous modifications, variations, and adaptations may be made thereto without departing from the scope of the invention as defined by the claims.