# Electronic postage meter and method and apparatus for controlling erasure and writing of data in non volatile memory

## Claims
Vorrichtung zur Steuerung des Löschens und Schreibens von Daten in einem nichtflüchtigen Speicher 58 einer durch einen Mikroprozessor gesteuerten elektronischen Frankiermaschine, umfassend

## Description
The present invention relates to electronic postage meters, and to a method and apparatus for controlling the erasure and writing of data in non volatile memory of an electronic postage meter. The present application is related to copending European Application EP A 0,111,322 in the names of Pitney Bowes, Inc., which describes one type of postage meter in which the present invention may be utilized. Various electronic postage meter systems have been developed, as for example the systems disclosed in U.S. Patent 3,978,457 for Microcomputerized Electronic Postage Meter Systems, in U.S. Patent 3,938,095 for Computer Responsive Postage Meter and in European Patent Application EP A 0,019,515, filed May 5, 1980 for Electronic Postage Meter Having Improved Security and Fault Tolerance Features. Electronic postage meters have also been developed employing plural computing systems such a system is shown in U.S. Patent 4,301,507 for Electronic Postage Meter Having Plural Computing Systems and assigned to Pitney Bowes, Inc. of Stamford, Connecticut. Electronic postage meters include non volatile memory capability to store critical postage accounting information. This information includes, for example, the amount of postage remaining in the meter for subsequent printing or the total amount of postage already printed by the meter. Other types of accounting or operating data may also be stored in the non volatile memory, as desired. The non volatile memory in electronic postage meters provides a storage function accomplished in prior mechanical type postage meters by mechanical accounting registers. However, postage meters with mechanical accounting registers are not subject to the many problems encountered by electronic postage meters. Conditions do not normally occur in mechanical type postage meters that prevent accounting or a printing cycle or which result in the loss of data stored in the mechanical accounting registers. Moreover, in mechanical postage meters it is not necessary to electronically monitor the position of the mechanical components associated with the printing of postage. The position is however different with electronic postage meters. Conditions can occur in electronic postage meters where information stored in non volatile memory may be permanently lost. Conditions such as a total line power failure or fluctuation in voltage conditions can cause the microprocessor associated with the meter to operate erratically and either cause erasure of data or the writing of spurious data in the non volatile memory. The erasure of data or the writing of spurious data in the non volatile memory may result in a loss of information representing the postage funds stored in the meter. Since data of this type changes with the printing of postage and is not permanently stored elsewhere, there is no way to recapture or reconstruct the lost information. Under such circumstances, it is possible that a user may suffer a loss of postage funds. To minimize the likelihood of a loss of information stored in the non volatile memory, efforts have been expended to ensure the high reliability of electronic postage meters. Some systems for protecting the critical information stored in the meter are disclosed in the above noted patents and applications. An additional arrangement to protect the postage meter accounting information is disclosed in U.S. Patent 4,285,050 for Electronic Postage Meter Operating Voltage Variation Sensing System, assigned to Pitney Bowes, Inc., and in GB A 2,062,311. It will be understood that it is desirable to provide a power supply for electronic postage meters which is physically associated with and part of the meter. In the event of an external power failure, the power supply within the secure housing of the postage meter should continue to generate a sufficient, regulated power, for a long enough time to orderly and accurately transfer critical information from the volatile memory RAM to the non volatile memory. The problem of ensuring proper power during a power down cycle is compounded because certain non volatile memories need several different voltage levels for proper operation. As an example, one type of solid state memory requires the presence of three different voltage levels to accomplish a write or erase operation. While the microprocessors used in electronic postage meters can be reset and become inoperative below a predetermined voltage level, such microprocessors may become active again at even lower voltage levels. The microprocessors may be turned off below a predetermined voltage level and thereafter within a lower range turn on again and be capable of outputting data. The microprocessors will again turn off below the lower predetermined range. Because of this unreliable operation with respect to reset or turn off the accounting information within the postage meter can be destroyed by the inadvertent erasing of data or writing of spurious data during a power down cycle when the microprocessor is believed to be inoperative. Moreover, the cost of carefully testing and selecting microprocessor component for postage meters to avoid this problem can greatly increase the cost of such parts, both because of the cost of testing and because of the rejection of the microprocessor devices that exhibit this characteristic. Systems have been designed to preserve information stored in electronic memory units when power fails. Examples of systems of this type are shown in United States Patent 3,859,638 for a Non Volatile Memory Unit with Automatic Standby Power Supply United States Patent 4,049,951 for Data Detection Apparatus and United States Patent 3,676,717 for Non Volatile Flip Flop Memory Cell. These systems, in part, involve sensing power failure and taking measures to ensure data is not lost such as by employing an auxiliary standby power supply or by loading the data into a non voiatile memory. Other United States patents which show systems to protect stored information are United States Patent 3,801,963 for Method and Apparatus for Transferring Data from a Volatile Data Store Upon the Occurrence of a Power Failure in a Computer United States Patent 3,959,778 for Apparatus for Transferring Data from a Volatile Main Memory to a Store Unit Upon the Occurrence of an Electrical Supply Failure in a Data Processing System United States Patent 3,810,116 for Volatile Memory Protection and United States Patent 3,980,935 for Volatile Memory Support System. Power failure protection systems have been incorporated in electronic postage meter systems. A postage meter power failure protection system is shown and described in United States Patent 3,978,457 for Microcomputerized Electronic Postage Meter System. In this system, when a voltage drops below a threshold level, a signal is generated which initiates a shut down routine. As part of the shut down routine, the contents of a working random access memory are transferred to a non volatile memory. The maximum time to detect the shut down signal and the time to transfer the register contents from the work memory to the non volatile memory is a function of the circuit components including the power supply filter capacitors. It is known that during power up and power down the micro processor may not function predictably and, therefore, that the memory must be protected. The protection is accomplished by gates. Our copending European Patent Application No. 82 108 662.6. filed on September 20, 1982, provides a memory protection circuit which protects against unreliable microprocessor operation when power failure occurs for any reason. The memory protection circuit maintains the integrity of the accounting data stored in the meter by ensuring that information is not inadvertently written into or erased from the non volatile memory during a power down cycle. Further, this patent application describes the various voltage levels necessary for writing into different types of non volatile memories and the requirement to maintain such voltages for a long enough time during the power down cycle to provide an orderly and accurate transfer of critical information from the volatile memory RAM to the NVM. However, in accordance with this patent application, although the NVM is protected during the power down cycle from the writing of spurious data therein, there is no such protection afforded to the NVM during normal meter operation when a fluctuation in voltage conditions may cause the microprocessor to operate erratically, causing the erasure of data or the writing of spurious data in the non volatile memory. In accordance with the above mentioned European patent applocation bias voltages are maintained on the non volatile memory for sufficient time during the power down cycle to provide an orderly and accurate transfer of critical information from the RAM to the NVM if the power supplied has reached its expected output voltage. However, should a power failure occur during power up shortly after the write terminal of the NVM is energized, it is possible that critical information may be lost since the write terminal voltage is removed at the same point on the power supply output voltage curve during the power down cycle as it is applied to the write terminal during power up. In aforementioned United States Patent 4,285,050 an operating voltage variation sensing system is disclosed for an electronic postage meter using hysteresis for the power down and power up cycles. Although such circuit provides control of the application of an enable voltage to the non volatile memory during power up and power down of the meter, it is relatively complex and expensive to implement. Further, such circuit utilizes the architecture of the microprocessor to provide the power down cycle threshold voltage, and does not supply a low voltage warning signal and a power down cycle threshold voltage to the microprocessor external therefrom. GB A 2,062,311 discloses a method for controlling the erasure and writing of data in non volatile memory of an electronic postage meter, comprising the steps of GB A 2,062,311 also discloses apparatus for controlling the erasure and writing of data in non volatile memory of a microprocessor controlled electronic postage meter, comprising However, the non volatile memory of this system is enabled to receive or erase data whenever the source of operating power is above the first threshold value. In some conditions, as discussed above, this may not provide adequate security for memory contents. An object of the present invention is to provide a non volatile memory protection circuit which protects the NVM during power up and power down of an electronic postage meter, as well as during normal meter operation. A further object of the present invention is to provide a non volatile memory protection circuit which interacts with the microprocessor during meter operation. A still further object of the present invention is to provide a non volatile memory protection circuit in which a low voltage warning signal and power down cycle threshold voltage are applied to the microprocessor external therefrom. A further object of the present invention is to provide a non volatile memory protection circuit which is reliable and simple in design, yet inexpensive to implement. According to one aspect of the invention there is provided an apparatus for controlling the erasure and writing of data in non volatile memory of a microprocessor controlled electronic postage meter, comprising In a preferred embodiment of the invention, the apparatus is characterised by low voltage warning means for providing a low voltage warning signal to the microprocessor during the power down cycle when the input voltage has decreased to a preset voltage level, said microprocessor being arranged to supply said memory control signal as a write command subsequent to receiving the low voltage warning signal and prior to removal of said output enable signal, and said non volatile memory switching means being arranged to supply said bias voltage to allow writing of data only during coincidence between said memory control signal and said output enable signal. According to another aspect of the invention, there is provided a method of operating apparatus according to said preferred embodiment of the invention for controlling the erasure and writing of data in non volatile memory of an electronic postage meter, comprising the steps of Other objects, aspects and advantages of the present invention will be apparent to those skilled in the art from the following detailed description of preferred embodiments of the invention considered in conjunction with the accompanying drawings in which Figure 1 illustrates a non volatile memory protection circuit 10 for non volatile memory NVM 58. This circuit 10 includes a comparator generally designated as 12 which receives a 23.9V input from a 24V regulator, see Figure 2. The comparator 12 includes a first voltage divider 14 having a first resistor 16 electrically coupled between the 23.9V input and the inverting input terminal of an operational amplifier 18, and a second resistor 20 connected between the inverting input terminal of the operational amplifier 18 and ground. A second voltage divider 22 includes a resistor 24 coupled between the 23.9V input and one terminal of a Zener diode 26. The Zener diode 26 has a breakdown voltage of 6.8V and its other terminal is grounded. A second resistor 28 is coupled between the resistor 24 and the non inverting input terminal of the operational amplifier 18. Finally, a third resistor 30 is coupled between the resistor 28 and the output of the operational amplifier 18. The resistors 28 and 30 are electrically connected at a reference point designated 31. The output of the operational amplifier 18 is coupled to the base terminal of an NPN transistor 32 through a current limiting resistor 34. The emitter terminal is grounded and the collector terminal is coupled to a 5V bias through a current limiting resistor 36. The output from the collector terminal is applied to a RESET terminal of a microprocessor 38. Also coupled between the collector terminal and ground is a timing capacitor 40. Also coupled to the output of the operational amplifier 18 is a PNP transistor 42. The base terminal of the transistor 42 is coupled to the output of the operational amplifier 18 through a current limiting resistor 44. The emitter terminal of the transistor 42 is coupled to the collector terminal of a PNP transistor 46. The emitter of the transistor 46 is coupled to a 5V bias. A resistor 48 is coupled between the emitter and base terminals of transistor 46. The base terminal of the transistor 46 is coupled to an ERASE or WRITE control terminal of the microprocessor 38 through a current limiting resistor 50. The collector terminal of the transistor 42 is coupled to the base of an NPN transistor 52 through a current limiting resistor 54. The emitter terminal of the transistor 52 is coupled to a negative voltage supply, here 30V, and a biasing resistor 56 is coupled between the emitter terminal of a transistor 52 and the collector terminal of transistor 42. The collector terminal of transistor 52 is coupled to the NVM 58. Also coupled between the collector terminal of the transistor 52 and ground is a filtering capacitor 60. Referring to Figure 2, a low voltage warning circuit is illustrated generally at 70. Initially, unregulated D.C. is supplied to a 24V regulator 72 for regulation. The output of the 24V regulator 72 is applied to a 5V wide range switching regulator 74, such as a SH1605 available from National Semiconductor Corporation, for providing a constant 5V output when the input voltage is within the range of 8 to 35V. An energy storage capacitor 76 is coupled between the output of the 24V regulator 72 and ground. The output of the 24V regulator 72 is coupled to the N terminal of a Zener diode 78 having a breakdown voltage of 20V. The P terminal of the Zener diode 78 is coupled to the inverting input terminal of an operational amplifier 80 through a current limiting resistor 82. Another resistor 84 also couples the P terminal of the Zener diode 78 to ground. Another Zener diode 86 having a breakdown voltage of 3.9V has its N terminal coupled to the P terminal of Zener diode 78 and its P terminal coupled to the 24V regulator 72 to provide feedback control of the output voltage from the regulator 72. A resistor 88 also couples the P terminal of the Zener diode 86 to ground. The non inverting input terminal of the operational amplifier 80 has a 5V bias applied thereto through a current limiting resistor 90. A resistor 92 is also coupled between the non inverting input terminal of the operational amplifier 80 and ground. A feedback resistor 94 is coupled between the output of the operational amplifier 80 and its non inverting input terminal. The output of the operational amplifier 80 is coupled to the low voltage warning terminal of the microprocessor 38. The output of the amplifier 80 is normally held at 5 volts through a 5V bias voltage applied thereto through a current limiting resistor 96. Referring to Figure 3, the D.C. input voltage curve designated 100 is shown with the pertinent voltage signals during power up, power down and normal meter operation related thereto. Specifically, during power up, and with reference also to Figures 1 and 2, the output COMP of the comparator 12 attains its high state as the input voltage rises toward 6.8V. At this point, the Zener diode 26 conducts and holds the output of the operational amplifier 18 at a constant 6.8V. When a high output is present at the output of the operational amplifier 18, the transistor 32 conducts providing a RESET signal true low to the microprocessor 38. The presence of the RESET signal inhibits the microprocessor 38 from generating an ERASE signal until the RESET signal is removed. Further, during this period the transistors 46 and 42 are biased out of conduction so that the transistor 52 does not conduct. Therefore, there is no output applied to the 30V terminal of the NVM 58. This condition is true from the time the comparator 12 becomes operational about 2 3 volts until the input voltage reaches 20.4 volts. However, when the input voltage reaches 20.4V, the output voltage 102 of the operational amplifier 18 abruptly switches to zero as seen in Figure 3. This is caused by the voltage divider 14 which due to the arrangement of resistors 16 and 20 supplies 1 3 of the input voltage or 6.8 volts to the inverting input terminal of the operational amplifier 18. Since the non inverting input terminal is also held at 6.8 volts, the operational amplifier 18 switches to a zero volt output. The output of the operational amplifier 18 then remains at zero during the remainder of the power up cycle and during normal meter operation since the voltage present at the inverting input terminal of the operational amplifier 18 is greater than the voltage present at the non inverting input terminal. The presence of a zero voltage at the output of the operational amplifier 18 turns off transistor 32 allowing the micro processor 38 to come out of the reset condition after a short delay provided by timing capacitor 40. Also, during power up, a low voltage warning signal is supplied to the microprocessor 38 by operational amplifier 80 until the input voltage exceeds 20 volts and Zener diode 78 conducts. The switching regulator 74 supplies a positive bias to the non inverting input of the operational amplifier 80 resulting in a high or warning signal. As the input voltage exceeds 20 volts, Zener diode 78 starts to conduct causing the output of comparator 80 to go low. The microprocessor 38 coming out of the reset condition, loops under program control until the output of the operational amplifier 80 goes low indicating the conclusion of a successful power up sequence. During power up, after the input voltage has surpassed the threshold voltage of 20.4V, the microprocessor 38 under program control applies an During power down, as the input voltage decreases a low voltage warning signal appears at the output of the differential amplifier 80 when the voltage decreases to 20V. At this point, the Zener diode 78 no longer conducts. Since the positive terminal of the operational amplifier 80 is pulled toward 5V, a high output appears at the output of the operation amplifier 80, thereby warning the microprocessor 38 that the voltage is decreasing. At nominally 8V output from the regulator 72, the wide range switching regulator 74 no longer supplies a 5V output. Therefore, the low voltage warning voltage output decays below 8V. However, prior to reaching nominally 8V, but after the D. C. input voltage has fallen below 20V, the microprocessor 38 provides a When the D. C. voltage level falls to another threshold voltage, here 10.2V, the output of the comparator 12 abruptly switches to 6.8V since the voltage on divider 14 falls below the 3.4 volt reference of divider 22. This precludes conduction by the transistors 42 and 52 and thus prevents the application of 30V to the NVM 58. Similar to power up, when the output of the comparator 12 rises to 6.8V, the transistor 32 conducts applying a During the normal operating cycle of the meter, i.e., after the input voltage has stabilized at 24V, the It should be understood for the purpose of the present application that the term postage meter refers to the general class of devices for the imprinting of a defined unit value for governmental or private carrier delivery of parcels, envelopes, or other like application for unit value printing. For example, although the term postage meter is utilized, it is employed in the trade as a general term for devices utilized in conjunction with services other than those exclusively employed by governmental postage and tax services. For example, private, parcel and freight services purchase and employ such meters as a means to provide unit value printing and accounting for individual parcels.