# Attenuation compensated emission reconstruction method and apparatus

## Claims
Verfahren zum Rekonstuieren von Emissions Projektionssignalen, um ein Pixelbild 20 in Figur 1 von verteilten Emissionsquellen in einem Schwächungsmedium zu erzeugen, wobei das Verfahren die Schritte enthält

## Description
The invention relates to a method of reconstructing emission projection signals and an image reconstructor according to the first part of claim 1 and 10, respectively. Such method and apparatus are known from PROCEEDINGS OF THE IEEE, Vo. 67, No. 9, Sept. 1979, pages 1245 to 1272, or IEEE TRANSACTIONS ON BIOMEDICAL ENGINEERING, Vol. BME 28, No.2, Febr. 1981, pages 142 157. Computed tomography embraces the fields of transmission computed tomography TCT and emission computed tomography ECT . In transmission computed tomography, a source of x rays and a detector array having a fixed geometric relationship are used to produce a set of projections for reconstruction. Both the source position and intensity are known, and any of a variety of reconstruction algorithms can be used to reconstruct the attenuation coefficients of a body which was scanned to produce the projections. In emission computed tomography, the problem is more complex in that the source intensity, the source position, and the attenuation characteristics are all unknown. More particularly, in ECT injected or inhaled compounds labeled with radioactive atoms tend to differentially concentrate in particular regions of the body, and the problem is to reconstruct the intensity and location of those concentrations based on projections taken around the body. The attenuation characteristics of the body obviously affect the projections, and since it is desired to quantitatively define the emission sources, the attenuation characteristics must be taken into account for accurate reconstructions. The problem has been recognized and has been discussed in the literature See for example G.T Gullberg, The Attenuated Radon Transform Theory and Application in Medicine and Biology , Ph.D. dissertation, Univ. California, Berkeley, CA also Lawrence Berkeley Lab., Berkeley, CA, Rep. LBL 7486, 1979 G.T.Gullberg and R.H. huesman, Emission computed Tomography , in Image Reconstruction From Projections Implementation and Application , G. Herman, Ed., New York Springer Verlag, 1979, Ch. 5 R.H. Huesman, G.T. Gullberg, W.L. Greenberg, T.F. Budinger RECLBL Users Manual Donner Algorithms for Reconstruction Tomography Tech. Rpt. PUB 214, Lawrence Berkeley Laboratory, 1977 and the references referred to in those treatises. As described in the literature, if the attenuation coefficients within the body are assumed to be constant, both convolution algorithms and iterative algorithms can be used to reconstruct the emission image with attenuation compensation. If the attenuation coefficients are assumed to be variable, iterative algorithms can be used. With respect to both applications of iterative algorithms, however, the attenuation coefficients are not used directly, but instead are used to calculate attenuation factors which are subsequently used in the emission reconstruction process. In short, a set of attenuation coefficients µ In view of the foregoing, it is a general aim of the present invention to provide a method and apparatus for iteratively reconstructing emission images corrected for attenuation, while avoiding the need for a preliminary calculation of attenuation factors. More particularly, it is an object of the present invention to provide a method and apparatus for emission reconstruction which evaluates the attentuation factors as necessary in the actual emission reconstruction process. A subsidiary object is to provide a projector back projector for projecting and back projecting emission data in the reconstruction process, which models the attenuation process in the projection and back projection operation. In that regard, it is a related object to apply the projection and back projection in the context of a least squares approach using iterative techniques to reconstruct the emission concentration while simultaneously compensating for attenuation. According to the invention the objects are solved by the features of claim 1 and 10, respectively. Further embodiments of the invention are claimed in the subclaims. Other objects and advantages will become apparent from the following detailed description when taken in conjunction with the drawings, in which Turning now to the drawings, Fig. 1 illustrates the geometry of the pixelized reconstruction space 20 in which it is desired to reconstruct an image of a body section showing the concentration of radionuclides disposed therein. The pixelized space 20 is comprised of a plurality of pixels 22, 23 into which signals are back projected and from which signals are projected in the iterative reconstruction process. It is understood that in practice, many more pixels will be employed Fig. 1 has been simplified in order to better illustrate the invention. As will be appreciated, prior to reconstruction, the body was scanned by a detector or series of detectors indicated generally at 21 to produce a set of projection signals related to attenuated gamma intensities sensed at a plurality of angles around the body. The projections are then combined as will be described below to produce an image, compensated for attenuation, showing the radionuclide distribution in the scanned slice of the body. The XY axes illustrated in Fig. 1 define the coordinates of the pixelized space in the reconstructed image the axes will typically be horizontal and vertical respectively. It is seen that those axes are rotated by an angle ϑ from the ξ ζ axes which define the coordinates of the particular projection being considered. Each projection will have its own characteristic angle ϑ with respect to the XY axes of the pixelized space. It will be apparent from Fig. 1 that if the scanned body has attenuating characteristics, the effect of that attenuation on the projections will significantly affect the resulting reconstructions if it is not taken into account. For example, for the view illustrated in Fig. 1, and for the ray 24 a source within pixel 25 will be attenuated much more than a source within pixel 26 before reaching the detector because of the significantly greater length of the body through which the radiation must pass. Further, for the activity in pixel 25 as seen in ray 24, the attenuation of pixel 27 will have much less effect than the attenuation of pixel 26 because of the significantly shorter length of travel of ray 24 through pixel 27. For those reasons, in prior reconstruction techniques which took account of the attenuating characteristics of the body, it was necessary to determine a set of attenuation factors for each pixel and for each angular projection prior to the actual reconstruction operation. The attenuation characteristics of the body can be determined by known techniques. In some cases, it is permissible to simply determine the outline of the body, then assign a constant attentuation coefficient to each pixel within the body and zero attenuation without. In other cases, a conventional transmission scan preferably using the same type of gamma source as will be used for the emission scan can be used to specify or assign attentuation coefficients to each pixel. In the emission scan, the attenuated source concentration distribution is measured. The source concentration distribution ρ and the attenuation coefficient distibutior µ in the transverse section can be modeled as where The projection data measured during the course of an emission can be represented by the attenuated Radon transform where The attenuated Radon transform applied to Equation 1 gives In practicing the invention, we have used Equation 1 and 2 to model the image space, and have modeled the attenuation process in accordance with Equation 5 and Equation 6 which is the transformation of the characteristic functions χ ij where µ a The significance of expression 6 can be appreciated with reference to Fig. 1. For a particular projection at angle ϑ, there is shown a typical ray, the Kth ray, and its intersections with the pixelized space. The ray intersects a typical pixel In accordance with the invention, we have adapted that relationship to allow piecewise modeling of the attenuation factors of all the pixels along the ray as part of the projection and back projection process for reconstructing the emission image. More particularly, the line integrals of the attentuation costficients to the respective intersections of the ray with the pixel are built up, beginning with the first pixel intersected by any given ray, and continuing with adjacent pixels, as part of the projection and back projection process. For the projection operation, the relationship can be expressed mathematically as where The resulting P K is the previous P K plus the factors set out in the expression. Similarly, for the back projection operation, the relationship can be expressed as where the elements of the relationship are as defined above except that B i,j is the back projection matrix made up of a map of ρ factors for the pixelized space. It is seen from the foregoing that the projection and back projection operations are very similar and, unless otherwise indicated herein, the term projection is used to generically characterize both. Turning now to Fig. 2, there is illustrated a procedure by which the attenuation factors are evaluated as needed in connection with the projection or back projection operation. The figure is described in terms of the projection operator but is equally adaptable to the back projection operator simply by using expression 8 instead of expression 7. The procedure begins with a step 30 which initializes the system to operate on the first projection ϑ 1. Further initialization is accomplished in step 31 in which for the selected projection ϑ , the system evaluates DXL, DYL, and sets K, the ray index, equal to 1. The significance of DXL and DYL can be appreciated with reference to Fig. 1. DXL is the distance between two successive X axis intercepts in the pixelized space. Similarly, DYL is the distance between two successive Y intercepts. Those lengths are illustrated in Fig. 1 for the Kth ray, but it will be appreciated for any given ϑ the DXL and DYL factors remain the same for all rays, although they vary with ϑ . DXL and DYL are fixed by the geometry and are therefore stored constants in memory which are accessed as needed. The step 32 then initializes conditions for the selected ray in the selected projection. For a particular ray K, the system determines the row and column indices of the first and last pixel intersected by the ray. As in the case of DXL and DYL, that information is determined by the geometry and is stored for ready access when needed. Also stored for ready access are XL and YL for the ray in question. As seen in Fig. 1, XL and YL are the distances from the first intersection 28 of the ray with the pixelized space and the first X and Y intercept, respectively. A series of accumulators is then initialized in step 32. The ATENL accumulator is set to zero in order to begin accumulating information related to the line integrals of the attenuation coefficients for the ray in question. The EX1 accumulator is initialized at 1 since the attenuation prior to entering the pixelized space at the point 28 of Fig. 1 is zero. Finally, the projection accumulator P K is initialized at zero. Having initialized those conditions, the procedure then determines the length L of the ray in question within the first pixel 50 in order to take account of the attenuation characteristics of that pixel in the modeling process. A test is performed at step 33 to determine whether XL is less than YL. If it is, the process branches to the left to perform a step 34, whereas if it is not the process branches to the right to perform a step 35. For the first pixel 50 illustrated in Fig. 1, it is seen that XL is less than YL, so in this example the process first branches to the step 34. The length factor L is then set equal to XL which as will be appreciated with reference to Fig. 1 is the ray length within the first pixel 50. The XL and YL factors are then redefined in preparation for the next pass through the loop. YL is set equal to YL XL which, in effect, subtracts from the original distance YL the ray length within the first pixel. XL is set equal to DXL which is the distance between two X intercepts or, in effect, the distance across the next pixel assuming the ray stays within the same row of pixels. The step 36 is then performed to both determine a partial line integral for the ray through the first pixel 50 and, at the same time, to define a partial projection for that pixel altered by its attenuation characteristics. More particularly, the length L established in step 34 is multiplied by the attenuation coefficient It will be appreciated that the foregoing expression represents a modeling of the image space in dependence on the projections and in addition takes into account the attenuation of the modeled space. Having determined the partial projection, EX1 is set equal to EX2 in preparation for the next pass through the loop. A test 37 is then performed to determine whether there are additional pixels in the ray path by determining whether the i and j indices are equal to the last indices established in step 32. Since they are not, the i or j index is incremented at step 38 and the process returns to the test 33. The system then evaluates the length of the Kth ray within the next pixel 51. Since the new XL is still less than the new YL which had been established in step 34, the step 33 will again branch left to the step 34 to set L equal to the length across the pixel 51 and redefine YL and XL for the next pass through the loop. In step 36, the contents of ATENL accumulator will then be increased in dependence upon the length L just determined and the attenuation coefficient µ Referring to Fig. 1, it is seen that the process then determines the length of the Kth ray within the pixel 52. The ray exits the pixel not at an X intercept as in the previous two cases, but at a Y intercept. In that condition, the tests 33 will determine that the previously defined XL is greater than YL, causing a branch to step 35. Thereupon, L is set equal to YL for purposes of computing the attenuation factor associated with the pixel 52. XL is set equal to XL YL and YL is set equal to DYL in preparation for the next pass through the loop. The process of step 36 is again performed for the new L associated with pixel 52 as well as the attenuation coefficients and emission coefficients associated with that pixel. The process is repeated as described above for each pixel along the Kth ray until the contribution of pixel 54 is added to the projection accumulator, after which the test 37 determines that the last pixel for the given ray has been processed. A test 40 then determines that the Kth ray is not the last ray whereupon a step 41 is accomplished to increment the ray index, following which the entire process is repeated for the new ray. After all rays for a given projection have been processed, a test 42 determines that there are additional projections to be processed, whereupon a step 43 increments ϑ, and the entire procedure beginning with step 31 is repeated for the new projection. After the last projection has been processed, the test 42 produces a positive result, whereupon the projection operation is terminated. The projection operator within the step 36 can then be altered to the back projection operator set out in Equation 8 and the process repeated for a back projection operation. The process alternates between the projection and back projection operations for a predetermined number of iterations to create a model which is a best least squares fit to the projection data. The information within the model is then displayed as on a CRT to produce an emission image corrected for attenuation. The specific details of the application of the projection or back projection algorithm used for the emission reconstruction were not discussed in detail above. Generally, the iterative methods adjust the parameters the reconstructed pixel values such that when the reconstructed values are projected, the resulting projections are as close as possible to the measured signals, generally in a least squares sense. The present invention is useful in connection with a number of different reconstruction algorithms, as will be pointed out briefly below. Simultaneous iterative reconstruction techniques SIRT use information from all the projections to determine a new solution in the iterative process. These types of algorithms include the gradient, conjugate gradient, and iterative convolution methods. The gradient and conjugate gradient methods require the backprojection process to be the transpose of the projection process as given in expression 8. The iterative convolution approach would require a different backprojection operation which one can derive from equation 8 by setting µ The SIRT algorithms can project and back project various types of information based on the requirements of the particular algorithm being employed. For example, in the back projection process the measured projection signals or the difference between the measured projection signals and assumed projection signals can be back projected. In the projection process, among the signals which can be projected are the results of the immediately preceeding back projection operation or the difference between the results of the previous back projection operation and an assumed image space distribution. ART algebraic reconstruction techniques to which the invention can also be applied use the measurements for one or a small number of rays to update all the pixels at each iterative step. This means that the hardware described herein would require one or a small number of ray calculations before updating the new solution for the reconstructed image. These iterative algorithms are designed to give a reconstructed image either which is a maximum likehood estimate for the measured projections or which maximizes entropy subject to the constraints of the measured data and smoothing criteria. It will now be recognized that the attenuation compensation procedure described above does not significantly extend the processing time for any given reconstruction algorithm. The evaluation of the length factors is accomplished by simple additions and comparisons which can be performed very rapidly. The multiplication and division requirements of step 36 can also be rapidly performed, particularly in a hardware floating point processor of the pipeline variety, or in some cases by means of table lookup. Thus, using the present procedure, it is possible to to evaluate the attenuation factors during the actual reconstruction operation, rather than in a preliminary step as has been done in the past. Turning now to Fig. 3, there is shown in block diagram form the general configuraiton of a hardware processor for performing the procedures described in connection with Figs. 1 and 2. Locking first to the elements which are initialized prior to processing a projection, a pair of registers 100, 101 are preset wish the values of DXL and DYL for a given projection. It is seen that the selector signal for the registers 100, 101 is a function of ϑ and thus, at the start of processing a given projection, the registers are loaded with the characteristic lengths for that ϑ . A pair of memories 102, 103 are arranged to store the length through the first pixel for each projection and for each ray in the projection. It is seen that the memories 102, 103 are addressed by both K and ϑ signals to read out the particular XL1 and YL1 respectively associated with the ray and view being processed. A pair of one bit registers 104, 105 are also initialized to control the incrementing and decrementing of the row and column indices, respectively. It will be appreciated that the pixelized space is operated on for purposes of projection and back projection from all angles and thus the pixel indices may require incrementation or decrementation depending on the orientation of a view with respect to the projection space. The registers 104, 105 control incrementing or decrementing in dependence upon ϑ signals defining the particular projection. Finally, it is recalled that it is necessary to evaluate the row and column indices for the first and last pixel associated with any given ray in a given view. Accordingly, first memory registers 106, 107 and last memory registers 108, 109 are preset by the K and ϑ signals then in effect. The first memory registers 106, 107 serve to preset a pair of index counters 110, 111 whereas the last memory registers 108, 109 are coupled to a pair of comparators 112, 113 which serve to produce an output signal when the last indices are reached. When both comparators produce such output signals, indicating the last pixel has been processed for the ray in question, an AND gate 114 is activated to increment a K counter 115. The K counter produces K signals which address the presetting elements discussed above. In addition, the K counter produces a K last signal which increments a projection counter 116 which in turn produces ϑ signals for addressing the presetting elements discussed above. Before discussing the remaining circuitry of Fig. 3, it will be recalled from Fig. 2 that certain of the process steps must be performed in a defined sequence. In the hardware embodiment of Fig. 3, the sequence is controlled by a digital clock comprising an oscillator and associated frequency dividers. While those elements are not illustrated in Fig. 3, clock inputs are shorn for various of the elements and labeled with designator C₁, C₂, C₃ or C₄. That notation is intended to signify a four phase clock where four clocking signals are produced in sequence beginning with C₁ and ending with C₄. The implementation of such a clock will be apparent to those skilled in the art based upon the requirements set out herein. Referring again to Fig. 3, there is provided an XL register and a YL register 120, 121 which are updated in accordance with the procedures set out in steps 34 and 35 of Fig. 2. Upon initialization, the memories 102, 103 are caused to load the first XL and YL into the registers 120, 121, respectively. Those magnitudes are applied to a subtractor 122 which determines the difference XL YL. The subtractor has a plurality of magnitude bits indicated generally at 124 and a sign bit 123. The sign bit is used to control branching left or right based on the decision 33 of Fig. 2. If the result of the subtraction is positive indicating that XL is greater than or equal to YL, the sign bit is set to 0, whereas if the result is negative, indicating that XL is less than YL, the sign bit is set to 1. In the example discussed above, for the first pixel of the Kth ray, the result is negative and the sign bit is 1. The logic 1 is applied to a multiplexer 126 having a pair of multi bit inputs fed from the XL and YL registers, respectively. With the sign bit at logic 1, the XL input is passed to the multiplexer output and presented to an L register 127. In the first phase of the clock signal, the register L is clocked to receive the output from multiplexer 126, in this case, the value of XL. It is also convenient at this time to clock a pair of i and j registers 130, 131 to capture the i and j indices for use in later processing. The contents of the L register 127 are passed to a floating point processor 132 illustrated in greater detail in Fig. 4. In the floating point processor, the contents of the register L are presented to a multiplier 134 along with the attenuation coefficient read out of a memory 135 by the i and j indices stored in registers 130, 131. Thus, the L value is multiplied by the attenuation coefficient for the pixel in question, and the product is passed to an accumulator 133 comprised Of an ATENL register 137 and adder 136. In the second phase of the clock signal c₂, the contents of the ATENL register are added to the product from multiplier 134 and the sum is stored in the register 137. It is also convenient at this time to clock the i or j index counters 110, 111. It will be appreciated from Fig. 1 that usually only one of such indices are incremented or decremented at any given time because the ray usually passes from row to row or column to column but not both. The particular index which is incremented is controlled by the sign bit 123. It is seen that the sign bit is passed to a pair of logic arrays 140, 141 which in turn are coupled to the up and down clocks of the counters 110, 111. With the sign bit being at 1, indicating a negative subtraction result, the array 140 is enabled to clock the counter 110. The logic high or low within the KI register 104 controls whether the gate 140a or 140b will decrement or increment the counter, and the bit within the register 104 is set in dependence on whether the ray is intersecting the pixels from high index to low or low index to high. During the third phase of the clock signal C₃, the registers 120, 121 are updated for a subsequent pass through the loop. It is seen that the sign bit 123 is coupled through a delay element 143 to the control inputs of a pair of multiplexers 144, 145. The multi bit inputs to the multiplexer 144 are derived from the DXL register 100 and the magnitude bits of the subtractor 122. Similarly, the multi bit inputs to the multiplexer 145 are derived from the DYL register 101 and the magnitude bits of the subtractor 122. The multiplexers are controlled to respond in opposite fashion by virtue of the sign bit being coupled directly to the multiplexer 144 and through an inverter 146 to the multiplexer 145. The delay element 143 assures that the multiplexers 144, 145 are controlled in dependence on the sign bit existing in the subtractor 122 at the start of the operation rather than a possible transient created as the registers XL, YL are loaded with new information. For the assumed conditions with the sign bit being at logic 1, the information from DXL register 100 is passed to register XL, while the information from the subtractor, which is the magnitude of YL XL is passed through the multiplexer 145 to the input of the YL register. In the third phase of the clock, that information is loaded into the respective registers in preparation for the next pass through the loop. Returning to Fig. 4, and recalling that in the first phase of the clock signal the ATENL register 137 was updated based on the new pixel, the output of that register is passed to a read only memory 150 which by means of table lookup generates an output signal equal to the result of evaluating the exponential function of the negative of the value within the ATENL register. In the third phase of the clock signal, that information is loaded into EX2 register 151. A subtractor 152 coupled between the EX2 register 151 and an EX1 register 153 determines the difference between those two factors. It is recalled that the EX1 register was initialized at 1 by the step 32 of Fig. 2. A multiplier 154 has presented thereto the difference EX1 EX2 along with the quotient derived from the memory 135, a memory 155 and a divider 156. In the fourth phase of the clock signal, a projection accumulator generally indicted at 157 adds the previous contents of the projection memory 158 to the output of multiplier 154 by way of adder 159 and stores the result. It will therefore be appreciated that the projection accumulator 157 accumulates partial projections as the pixels are processed in turn just as the ATENL accumulator 133 accumulates partial line integrals of the attenuation coefficients. Returning again to the first phase of the clock signal, the EX1 register 153 is clocked to accept the contents of EX2 register 151 in preparation for processing the next pixel. The new values of XL and YL from the third clock cycle are present in the registers 120, 121 and in the example described above again generate a negative result producing a high sign bit. The process is repeated as described above, loading the contents of register XL through multiplexer 126 into the L register 127, and loading the new i and j indices into registers 130, 131. In the second phase of the clock signal, the ATENL accumulator 133 is cycled to add in the product of the new L times the new µ In the example described above, for the third pixel 52 Fig. 1 the subtractor produces a positive result in which the sign bit is 0. In that condition, in the first phase of the clock signal, the multiplexer 126 is switched to load the contents of YL register 121 into L register 127. Just as in the other cycles, the i and j registers 130, 131 are loaded with a new index and the previous contents of EX2 register 151 loaded into EX1 register 153. On the second phase of the clock signal, since the sign bit is now zero, the array 141 will be activated to increment or decrement the j counter 111. As in the case of the previous cycles, the ATENL accumulator will be updated with information from the new pixel. In the third phase of the clock, the multiplexers 144, 145 will work in opposite fashion to load the information from DYL register 101 into the YL register 121 and the result of the subtraction process from the subtractor 122 into the XL register 120. In the same fashion as discussed previously, the magnitude within the ATENL register 137 is used to address the ROM 150 to produce the new EX2 signal to be loaded into register 151. Finally on the fourth phase of the clock signal, the projection accumulator 157 is again updated. That cycle continues until the comparators 112, 113 determine that the last pixel for the given ray has been processed at which point the AND gate 114 is satisfied to increment the ray counter 115. New K signals readdress the memories 102, 103, etc. to load initial values into the XL and YL registers, and to set up the first and list pixel indices in the memories 106 109. The process is repeated for all rays for the given view, then the view is incremented and the entire operation repeated until all views have been processed. The hardware implementation of Figs. 3 and 4 has been described in connection with the projection operation. It will be appreciated that the same hardware can also be used in the back projection operation. To accomplish that, it is simply a matter of interchanging the functions of the projection memory 158 and the image memory 155. That can be accomplished by a memory swap operation or by locating multiplexers at the points X, Y and Z, the inputs and outputs of the projection and image memories of Fig. 4. Expressions 7 and 8 define the projection and back projection for most circumstances. In the special case where µ As noted above, the projection and back projection operations can continue for as many iterations as desired in order to obtain a best fit of the projections to the data. Attenuation is accounted for at each step of the operation without the need for laboriously computing a large array of attenuation factors before beginning the reconstruction, while the method of evaluating attention factors from attenuation coefficients as needed as the ray intersects the pixel of interest efficiently accomplishes the evaluation without substantially slowing the process.