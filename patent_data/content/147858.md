# VECTOR PROCESSING APPARATUS

## Claims
Vektorverarbeitungsgerät mit

## Description
The present invention relates to a vector processing apparatus having a plurality of functional facilities capable of operating concurrently and intended to process vectors including elements more in number than the vector register can store. There has been proposed a vector processing apparatus having a plurality of vector registers, vector arithmetic units and memory requesters for fetching or storing vector data, and capable of fast vector processing through the concurrent operation of these facilities. Such a vector processing apparatus has vector instructions each processing a number of vector elements in the single execution. An example of such vector instructions is the vector addition instruction which adds corresponding elements of vector A i and vector B i . In some cases in executing the vector addition instruction, overflow exception for example, is detected for more than one vector elements. Exceptions which can be detected for each element during the execution of a vector instruction include arithmetic exceptions such as underflow exception, division exception and significance exception, and across exceptions such as address exception, address translation exception and memory protection exception. When such exception is detected, it is not sufficient to notify the software of the type of exception and the instruction address at which the exception has occurred, but it is further necessary to indicate the position of vector element which has caused the exception. However, a plurality of vector instructions are executed concurrently in the vector processor and, therefore, a plurality of exceptions can be detected simultaneously. Furthermore, the execution of instructions does not always terminate in the order of instruction address, i.e., exception of a vector instruction at an earlier instruction address can be detected later than exception of a vector instruction at a later instruction address. It would need a complicated process to determine which vector instruction has detected each exception and to perform an interrupt process for each vector instruction, resulting possibly in a degraded overall performance of the apparatus. Earlier European application EP A 0141232 published on 15.05.85 has the priority date of 24.10.83. Its content as filed is therefore considered, pursuant to Article 54 3 and 4 , as comprised in the state of the art. From EP A 0141232 a vector processing apparatus is known which is attached to a base data processor from which it receives vector instructions and operands for processing. The known vector processing apparatus comprises vector registers for storing vector elements read out from memory addresses of a memory, the vector registers having a plurality of storage positions therein, each storage position being assigned to an internal address, a plurality of functional facilities capable of concurrently processing vector elements from the connected vector registers, In contrast to the present invention there is no plurality of functional facilities which can arbitrarily be connected to different vector registers. Accordingly, in the vector processing unit shown in said document, the exception information stems from only one set of functional elements of the vector processing unit comprising one arithmetic and logic unit and one multiply divide unit only which can be serially interconnected with each other. It is an object of the present invention to provide a vector processing apparatus which can readily find out exception that has occurred first conceptually in dealing with vector elements, without impairing the performance of vector instruction execution. This object is achieved according to the present invention by the features recited in claim 1. In a typical form of the invention, each pipeline arithmetic unit is provided with a stack for the leading vector element number, a stack for the vector instruction address and an address counter for the internal use of the vector register, and upon detection of exception by the arithmetic unit, information held in the stack and counter is read out. This information is used to generate the vector element number at which exception has been detected, and the vector element number and instruction address of a newly detected exception are compared with those already held so as to select information of exception to be held ultimately, thereby enabling the determination of exception which has occurred at first in dealing with vector elements. An embodiment of the present invention will now be described with reference to the drawings. In Fig. 1 showing the general arrangement of the inventive vector processing apparatus, when the instruction of commencing the process of vector instructions is read out of the main storage 4 through the storage control unit 5 to the scalar processing unit 6, the unit 6 activates the vector processing controller 7 with the indication of the vector instruction starting address, the number of elements of vector processing, and the mode of processing parallel or single . The vector processing controller 7 reads a vector instruction in the storage 4 according to the starting address indicated, analyzes the instruction, and then dictates to the vector registers VRO VR7 10 17, memory requesters for fetching vector data FO F3 20 23, memory requesters for storing vector data SO, S1 24 and 25, or pipeline arithmetic units EO E3 30 33, depending on the result of analysis, for the execution of the vector instruction. The fetching memory requesters FO F3 calculate the vector data address in the main storage using the vector address register 2 to read out vector data in the main storage 4 via the storage control unit 5, and transfers the vector data to the vector registers VR0 VR7. Each of the vector registers VR0 VR7 can latch vector elements of TMAX in number, and is operable to read and write simultaneously. The pipeline arithmetic units E0 E3 perform arithmetic operations for vector data in the vector registers VR0 VR7, and leave the results in the vector registers. The storing memory requesters S0 and S1 calculate the vector data address in the main storage using the vector address register 2, and transfer vector data in the vector registers VR0 VR7 via the storage control unit 5 to the main storage 4. All of the fetching memory requesters F0 F3, storing memory requesters S0 and S1, and pipeline arithmetic units E0 E3 can operate concurrently. It is a common practice to control the parallel operations of the memory requesters and pipeline arithmetic units to the extent of retaining the legitimacy of data thereby to speed up the vector processing. The flag flip flop 9 is set by the scalar processing unit 6 to indicate the parallel processing mode when the vector processing controller 7 is initiated. When the flip flop 9 is set to 1 , indicating the parallel processing mode, two of the memory requesters and pipeline arithmetic units are paired to execute one vector instruction, and when the flip flop 9 is reset to 0 , one memory requester or pipeline arithmetic unit is used to execute one vector instruction, the latter being called single processing mode as against parallel processing mode for the former. In the vector processing apparatus, as of this embodiment, where more than one vector instruction is executed concurrently, many exceptions such as, for example, operation exception and specification exception detected during the decoding stage of instruction, access exception detected by the memory requester, and arithmetic exception detected by the arithmetic unit can arise successively. It is rather awkward and less efficient to extract exception information and reexecute the vector instruction by suspending the whole or part of the process at the detection of any exception, and provision of interrupt process for each vector instruction is not always preferrable. Instead, another conceivable method is to run an interrupt process for a series of vector instructions. On this account, the interrupt process controller 8 is provided with functions for selecting the highest ranking exception out of exception signals ℓ30 ℓ33 detected by the pipeline arithmetic units E0 E3, exception signals not shown detected by the memory requesters F0 F3, S0 and S1, and exception signals not shown detected by the instruction decoding unit not shown , all occurring independently during the process of a series of vector instructions, and for sampling and holding necessary exception information from a sourcing arithmetic unit, memory requester or instruction decoding unit. The following describes the process of the vector processing apparatus shown in Fig. 1 dealing with a DO loop of FORTRAN program shown in Fig. 2a. This DO loop is compiled to into vector instructions as shown in Fig. 2b. Instruction 1 is to load vector A i , i 0 1023 in vector register VR0 instruction 2 is to load vector B i , i 0 1023 in vector register VR2 and instruction 4 is to store vector C i , i 0 1023 in vector register VR4. VAR0, VAR2 and VAR4 are registers holding the starting addresses of areas where the vector data is stored, and VIR0, ViR2, VIR4 are registers holding the interval of areas storing vector elements. In this example, 1024 elements of vector A are stored at an interval of 7 byte from address 10000, 1024 elements of vector B are stored at 8 byte interval from address 12000, and 1024 elements of vector C, which is the sum of vectors A and B, are stored at 8 byte interval from address 14000. Instruction 3 is to add corresponding vector elements loaded in vector registers VR0 and VR2, and store the results in the specified vector register VR4. Instruction 5 is a control instruction which indicates the end of a vector instruction list and does not concern any virtual vector processing operation. The operation of the apparatus in single processing mode and in parallel processing mode will be described on the assumption that each vector register has a capacity for storing vector elements of VMAX 256. In single processing mode, 1024 sets of vector elements are added through the four repetitive executions of the vector instruction list shown in Fig. 2b. Each execution cycle will be called one loop . To carry out the cyclic process in a hardware scheme, the vector processing controller 7 is provided therein with a register VLR for holding the number of remaining vector elements to be processed. In case the number of remaining elements is more than 256, 256 sets of vector elements are processed using, for example, the fetching memory requester F0 for the VL instruction in 1 , the fetching memory requester F1 for the VL instruction in 2 , the arithmetic unit E0 for the VEA instruction in 3 , and the storing memory requester S0 for the VST instruction in 4 . Accordingly, when the VEND instruction is decoded, the VLR contains the initial value subtracted by 256, the VAR0, VAR2 and VAR4 contain each initial value added by VIR x 256. If the esult of decrement of VLR is possitive, the process continues from the top of the vector instruction list using the updated, VAR0, VAR2 and VAR4, or if the result becomes negative, the termination process takes place. In parallel processing mode, 1024 sets of vector elements are added through the two repetitive executions of the vector instruction list shown in Fig. 2b. The reduction in execution cycles is made possible through the use of two vector registers, two pipeline arithmetic units and two memory requesters in pair as determined from each vector instruction, that allows 512 sets of vector elements to be processed in one loop. In this mode, the VL instruction in 1 transfers 256 vector data A 0 , A 2 , ..., A 510 to the vector register VR0 using, for example, the fetching memory requester F0, and 256 vector data A 1 , A 3 ..., A 511 to the vector register VR1 using the fetching memory requester F1. Subsequently, the VL instruction in 2 loads even numbered elements of vector B in the vector register VR2 and odd numbered elements of vector B in the vector register VR3 the VEA instruction in 3 produces in the vector register VR4 the sum of the vector registers VR0 and VR2, and in the vector register VR5 the sum of the vector registers VR1 and VR3 and the VST instruction in 4 stores vector data in the vector register VR4 as resultant vector C 0 , C 2 , ..., C 510 , and vector data in the vector register VR5 as resultant vector C 1 , C 3 , ..., C 511 . Thus, 512 sets of vector elements are processed in one loop, and when the VEND instruction is decoded the VLR contains the initial value subtracted by 512 and the VAR contains the initial value added by VIR x 512. The process following the result of subtraction for the VLR is identical to the case of single processing mode. In order to provide a single interrupt process for a series of vector instructions as shown in Fig. 2b for the example of a DO loop shown in Fig. 2a, it becomes necessary to select one of exceptions that can occur in the DO loop shown in Fig. 2a. Among several priority rules of selection conceivable, such as a rule of ranking operation and specification exceptions higher than access exception and arithmetic exception, a rule of ranking higher an exception related to a vector instruction in the earlier address, a rule of ranking higher an exception related to the smaller vector element number, and so on, this embodiment realizes the rule of selecting at the higher priority an exception related to the smaller element number and, at the same time, related to an instruction at the earlier address. The reason of choosing this priority rule is based on the concept that exception which would be detected earliest in executing a DO loop using scalar instructions should be selected first. Fig. 3 shows in block diagram the exception information selecting circuit designed for operating solely in single processing mode. All of memory requesters and pipeline arithmetic units operate to detect exceptions during the execution of a vector instruction. The arrangement for determining the instruction address and element number at which exception has occurred is shown only for the arithmetic units, and the same arrangement for the memory requesters is not shown in the figure. In Fig. 3, the vector process controller 7 analyzes the vector instruction and assigns a pipeline arithmetic unit or memory requester to the instruction if the decision is reached that the vector register specified by the instruction and a pipeline arithmetic unit or memory requester of the type usefull for the instruction are ready for use. The vector process controller 7 is provided therein with a register SIAR 72 for holding the address of the leading vector instruction and a register VIAR 71 for indicating the address of the current instruction. The following describes the updating operation of register VIAR. When the vector process controller 7 is activated, the address of the leading vector instruction indicated by the scalar processing unit 6 is set to register SIAR and, then, to register VIAR. Thereafter, the instruction word length is added to the contents register VIAR through the adder 76 and selector 77 in response to the initiation of the vector instruction. When the VEND instruction is decoded, the leading instruction address held in register SIAR is set to register VIAR. Through the above operation, register VIAR becomes to indicate the address of the initiated vector instruction. The vector process controller 7 is provided therein with a register VER 70 which indicates the number of vector elements that have been processed so that the leading vector element number to be processed by the initiated instruction is indicated. The updating operation for register VER is as follows. Register VER is cleared when the vector process controller 7 is activated. Thereafter, each time the VEND instruction is decoded, the vector register length VMAX is added to the contents of register VER through the adder 78 and selector 79. Through this operation, register VER can indicate the leading vector element number. Next, the operation for obtaining the vector instruction address and vector element number for exception detected by each pipeline arithmetic unit will be described. Upon initiation of a vector instruction by the vector process controller 7, pipeline arithmetic units 30 33 save the address of the vector instruction in the register 306 and the leading vector element number in the register 302. At initiation of the instruction, the vector register internal address counter 301 in each arithmetic unit is set to VMAX. When the first element of vector data to be processed is entered to the first stage of the arithmetic pipeline 300, the contents of register 302 holding the leading vector element number are copied to register 303, and the contents of register 306 holding the vector instruction address are copied to register 307. Thereafter, as the data is moved to the second and, then, third stage of the arithmetic pipeline 300, the leading vector element number is moved to register 304 and, then, to 305, and the vector instruction address is moved to register 308 and, then, to 309. When the first vector element reaches the third stage, i.e., the last stage, process for one vector element completes, and the vector register internal address counter 301 is incremented by one through the adder 310 and selector 311 to become 00 . Namely, when the counter 301 containing VMAX is incremented by one, it returns to 00 count, indicating the first element. If exception has been detected during the arithmetic process, the exception detect signal is issued to the interrupt process controller 8, and at the same time the registers 305 and 309 and the vector register internal address counter 301 are disabled from further updating in response to this signal. The second and following elements are processed in the same way as in the first element, and unless exception is detected the vector register internal address counter 301 is incremented through the adder 310 and selector each time the process for an element completes. The purpose of saving the leading vector element number and vector instruction address in each stage of arithmetic pipeline 300 is the distinction among vector instructions existing concurrently within the arithmetic pipeline 300. For an apparatus of different design where two or more instruction do not exist concurrently in the arithmetic pipeline 300, these registers need not be provided for each stage separately. Through the above operation, the pipeline arithmetic units 30 33 can find the vector instruction address in the register 309 and the vector element number in the registers 305 and 301 for exception which has been detected first. Since the vector process controller 7 initiates vector instructions in the order of their address and the pipeline arithmetic units 30 33 perform processing in the ascending order of element number, exception which is detected first by the arithmetic unit will be one with the smallest element number and earliest address out of exceptions which can be detected by the pipeline arithmetic units 30 33. The following describes the operation of the interrupt process controller 8 for selecting exception with the smallest element number and earliest address out of exception events indicated successively by a number of pipeline arithmetic units. In response to exception detect signals issued by the arithmetic units 30 33, the exception detect signal entry 80 in the interrupt process controller 8 takes one of the detect signals selectively so that a set of exception information is introduced to the interrupt process controller 8. Namely, the vector instruction address is set through the selector 83 to the register 86, the leading vector element number and vector register address are selected by the selectors 81 and 82, respectively, and added together by the adder 89 and set to the exception element number register 84. In the case of exception which is first received by the interrupt process controller 8, the contents of register 84 is set to register 85 and the contents of register 86 are set to register 87 unconditionally. In other case, the register 85 already contains the exception element number and the register 87 already contains the exception instruction address of exception which has been detected earlier, and the contents of registers 84 and 85 are compared by the comparator 90 and the contents of registers 86 and 87 are compared by the comparator 91. If the exception element number in 84 for the newly received exception is smaller than the previous one in 85, the signal line 92 goes 1 and OR gate 93 is enabled to output. If the exception element number of the newly received exception is equal to the previous one and, at the same time, if the exception instruction address in 86 of the newly received exception is earlier than the previous one, AND gate 94 is enabled to output 1 and then the OR gate 93 is also enabled to output. The output of the OR gate 93 causes the register 84 to set its contents to the register 85, and the register 86 to set its contents to the register 87. In this way, the interrupt process controller 8 receives exception detect signals from the pipeline arithmetic units one after another and selects exception with the smallest vector element number and the earliest instruction address based on the comparison with those of the previously detected exception, whereby exception information of the selected exception such as the exception element number, exception instruction address and interrupt code not shown is held in the vector processing apparatus performing computation for vectors with elements more in number than the vector register can store. There are the operation of the exception information selecting circuit operable solely in single processing mode shown in Fig. 3. Next, the operation of the exception information selecting circuit operable in both the single and parallel processing modes will be described with reference to Fig. 4. The arrangement of Fig. 4 differs from that of Fig. 3 in that a selector 73 is provided for switching the count up value of the processed vector element count register 70 in response to the state of the mode flag flip flop 9, and in that an exception element number generating circuit 88 is provided for obtaining the exception vector element number given to the register 84, whereas in the arrangement of Fig. 3 this value is obtained by simply adding the outputs of the selectors 81 and 82. Details of the exception element generating circuit 88 will be described later using Fig. 5. The remaining portions of both arrangements of Figs. 3 and 4 are the same. When the mode flag flip flop 9 is reset to 0 , indicating the single processing mode, the selector 73 selects VMAX as the count up value for VER and the exception element number generating circuit 88 operates as an adder for the outputs of the selectors 81 and 82, and therefore the arrangement works identically to the previous case of Fig. 3. When the mode flag flip flop 9 is set to 1 , indicating the parallel processing mode, the selector 73 selects the duplicate 75 which doubles VMAX, and the exception element number generating circuit 88 operates to modify the vector register address indicated by the pipeline arithmetic units 30 33 and add it to the leading vector element number, whereby exception with the smallest vector element number and the earliest address can be selected, as in the case of single processing mode. The operation specific to parallel processing mode will be described in the following. In parallel processing mode, as mentioned previously in connection with Fig. 2, a vector instruction is processed by a pair of pipeline arithmetic units in such a way that one is asigned to even numbered elements and the other assigned to odd numbered elements, and therefore vector elements of VMAX x 2 in number at maximum are processed in one loop. Accordingly, by summing the contents of processed vector element count register 70 for VMAX x 2 times each time the VEND instruction is decoded, the leading vector element number of vector instruction initiated in one loop can be obtained. The pipeline arithmetic units do not directly access to the main storage, and they operate irrespective of the processing mode to indicate to the interrupt process controller 8 the vector register address of a vector element at which exception has been detected. The interrupt process controller 8 discriminates as to whether the pipeline arithmetic unit which has detected exception is assigned to even numbered or odd numbered elements, and operates on the exception element number generating circuit 88 to add the vector register address multiplied by two in the case of even numbered elements, or multiplied by two and added by one in the case of odd numbered elements to the leading vector element number, and set the result to the exception element number register 84. The following describes in detail the exception element number generating circuit 88 for a particular case of the exception element number register 85 having 4 byte length and the vector register length being VMAX 256, as shown in Fig. 5. Symbols pp, n, i0 2, 0 7, ℓ0 7, e0 3, and 0 7 shown in Fig. 5 correspond to those in the exception element number generating circuit 88. The lowest byte of the 4 byte leading element number to be stacked by each pipeline arithmetic unit is always zero, and each unit issues only the high order three bytes i0 2, 0 7 as the leading element number. Another one byte ℓ0 7 is needed for indicating the vector register address. The signal pp indicates the processing mode, and the signal line n carries the signal indicating that a pipeline arithmetic unit is assigned to odd numbered elements. Addition of the leading element number and the vector register address in single processing mode is realized by simply merging i0 2, 0 7 into ℓ0 7. At this time, the shifter 880 received pp 0, and the shift operation does not take place. Generation of the exception element number in parallel processing mode is carried out in combination of the operation of doubling the vector register internal address indicated by a pipeline arithmetic unit, the operation of adding one to the doubled result in the case of an odd numbered element, and the operation of adding the result to the leading element number. These operations are carried out using the shifter 880 and OR gate 881. Namely, in order to modify duplication and addition by 1 the vector register internal address indicated by a pipeline arithmetic unit, the shifter 880 is arranged for the case of pp 1 such that For the addition of the modified vector register internal address to the leading element number, the shifter 880 is made to provide outputs e30 e37 and, based on i27 0 always in parallel processing mode, an OR gate 881 is provided to obtain e27. Thus, the exception element number generating circuit 88 for the case of VMAX 256 can be realized by a relatively simple circuit arrangement as shown in Fig. 5. According to the present invention, exception which has occurred first conceptually in dealing with vector elements can readily be selected without impairing the performance of vector instruction execution, whereby infomation on exception comparable with the result of the conventional scalar processing apparatus can be offered to the software system.