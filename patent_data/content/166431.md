# AN INFORMATION PROCESSING APPARATUS HAVING AN INSTRUCTION PREFETCH CIRCUIT

## Claims
Informations Verarbeitungsanlage mit einer Instruktions Vorabrufeinheit 22 mit einer Instruktions Registereinrichtung Q0 Q7 zum zeitweiligen Speichern von wenigstens einer Instruktion und einer Lesesteuereinrichtung 32 zum Herauslesen der Instruktion und einer Ablaufeinrichtung 21 zum Ausführen der herausgelesenen Instruktionen dadurch

## Description
The present invention relates to an information processing apparatus comprising an instruction prefetch unit including instruction register means for temporarily storing at least one instruction and read control means for reading out the instruction and an executing unit executing the read out instructions. It is well known in an information processing apparatus referred to as microprocessor hereinafter that controllability of an execution sequence is one of the important features of a microprocessor. The controllability means to stop the execution of a CPU at an arbitrary address. In a debugging operation of a software development, for example, an operator tries to stop the CPU operation after a predetermined instruction has been executed in order to observe the status of the CPU at the timing when the instruction execution is stopped. Thus, the operator can check the CPU operation and can evaluate the developed software effectively. The stop of the CPU operation is usually called break and the address to be stopped is called break address or break point . This break operation is often required in the microprocessor besides the abovementioned debugging operation. It is required, for instance, in an interruption operation, a holding operation, a jump operation, a stand by operation, or the like. On the other hand, a microprocessor is integrated on a single semiconductor chip and is coupled to an instruction memory chip via a signal bus. The microprocessor sends an address to the instruction memory through the signal bus in a program execution sequence and fetches the accessed instruction in an instruction register provided therein. the fetched instruction is thereafter decoded and is applied to a CPU as control signals. The CPU executes the instruction according to the applied control signals and transferres a result of the execution to a designated device, e.g. a memory, a peripheral equipment, another microprocessor. Thereafter, the microprocessor sends a next address for accessing a next instruction to be executed to the instruction memory through the signal bus. A program may be performed by repeating the abovedescribed processing steps. In this case, if the break operation is required at a certain address, a break address at which an instruction execution is to be stopped is preliminarily set in a register means. This register means is coupled to an address comparator which is coupled to the signal bus in order to compare an address transferred to the instruction memory through the signal bus with the break address in the register means. The address comparator generates a break signal when the address on the signal bus concides with the break address and applies it to the microprocessor. The microprocessor stops an execution of an instruction which will be pre arranged in the next step. In a conventional microprocessor, thus, the break operation has been performed. Recently, in order to reduce an instruction memory access period and to use a signal bus effectively, an instruction prefetch technique has been proposed. This technique employs the locality of an instruction and will be applied to a microprocessor integrated on a single semiconductor chip. The locality of an instruction means that an instruction to be executed in the next of the instruction, which is now being executed, is the instruction which is designated by the address subsequent to the address corresponding to the instruction which is now executing. That is, in a program sequence, probability that an instruction designated by the next subsequential address is hit as the instruction to be executed in the next step is the highest. According to this locality of an instruction, a plurality of subsequent instructions can be preliminarily fetched in a microprocessor before an execution of the current instruction is terminated. The prefetch operation can be performed during the current instruction execution by using a signal bus when this bus is in an idle state. Thus, a program processing speed may be remarkably improved by the instruction prefetch technique. However, if the instruction prefetch technique is applied to a microprocessor, the above mentioned break operation becomes very difficult and complex since the break address detected by the comparator is different from the address which has been used to designate the instruction now being executed. In other words, when the break signal is generated from the comparator, the microprocessor is executing an instruction which was previously prefetched. This instruction is not the instruction to be stopped by the break signal. Thus, when the break operation is effected in a microprocessor with an instruction prefetch function, the execution of the program is stopped at the address different from the address to be actually stopped. To avoid this defect, hardware means is required for monitoring the CPU operation and the instruction prefetch operation. Further, a status information indicating the CPU operation is required and must be taken out of the microprocessor chip. In general, production of the status information is very difficult since the CPU operation sequence is very complex. Therefore, many complex circuits are required and must be added to the microprocessor. An information processing apparatus according to the preamble part of claim 1 is disclosed in US A 4 438 492. This document describes how to inform a micro program controller of an interrupt request. EP A 0 094 535 discloses an improvement for avoiding the address conflict in a write after read operation in a pipeline processor. These documents are not related to the stop or break of an operation on a microprocessor equipped with an instruction prefetch unit in a relationship between an instruction to be executed and an instruction address to be stopped or broken. It is therefore the object of the invention to provide an information processing apparatus with an instruction prefetch circuit in which the break operation can be easily performed. This object is achieved by an information processing apparatus comprising an instruction prefetch unit including instruction register means for temporarily storing at least one instruction and read control means for reading out the instruction, and an executing unit executing the read out instructions, wherein said instruction prefetch unit further includes an indication register means for temporarily storing break control information, said read control means being coupled to said indication register means and said instruction register means for reading out said break control information and an associated instruction, and means for stopping the operation of said execution unit in response to the read out break control information. By these means it is possible to provide an information processing apparatus whose execution sequence can be stopped at a desired address. The information processing apparatus is suitable for a debugging operation and applicable to an evaluation processor which can be used to develop software. According to the present invention, the break signal to stop the CPU operation is temporarily stored in the indication register of the instruction prefetch unit in 1 1 relationship with the prefetched instruction. In other words, the break signal is not directly applied to a break means of the CPU when it is generated, but is stored in the indication register once. The stored break signal is thereafter read out of the indication register of the instruction prefetch unit and is actually used to stop the CPU operation at the timing when stop of the CPU operation is desired correctly. As the result, in an information processing apparatus having an instruction prefetch function, the break operation can be correctly performed without monitoring the CPU operation. Further, it may be unnecessary to produce a status information indicating the CPU operation and to take out the status information of the information processing apparatus. In addition the indication register is only used to temporarily store the break signal, so that it can be provided by a simple and small storage circuit, like the instruction prefetch circuit. Here, in the present invention, the break signal may be generated from the comparing means as described in the prior art. The break signal further may be applied to the indication register directly or may be applied to it via a control circuit which receives not only the break signal but also another signal such as an address signal, a bus strobe signal indicating a signal bus utilization condition and generates a plurality of control signals including the break signal according to the received input signals. Further, in the case that a plurality of instruction prefetch registers are employed to prefetch a plurality of instructions, a plurality of indication registers may be employed corresponding to the prefetch registers. In this case, a break signal can be stored in a indication register at the simultaneous timing when an instruction is stored in the respective prefetch register. Further, the break signal stored in the indication register can be read out thereof at the same timing when the instruction is read out of the prefetch register. Therefore, a read write control circuit can be commonly used in both the instruction prefetch register and the indication register. In this case, through the break signal and the instruction are simultaneously read out of the instruction prefetch unit, the break operation can be performed at will. Namely, the break operation may be performed after the execution of the instruction which is simultaneously read out is terminated or may be performed before that instruction execution is started. Of course, when the break signal is read out, the break operation may be performed immediately or after a predetermined period. Furthermore, an interruption circuit can be used to activate the break operation by applying the break signal to the interruption circuit as an interruption signal. While, the break signal read out of the indication register may be applied to a stop control means or anything else employed in an information processing apparatus besides the interruption circuit. Fig. 1 shows a block diagram of a microprocessor system having a conventional microprocessor in which an instruction prefetch unit is not employed. A microprocessor 1 is coupled to an instruction memory 2 by an address bus 3 and a data bus 4. When the microprocessor 1 executes a program, the microprocessor 1 sends an address to the instruction memory 2 through the address bus 3 and fetches a read out instruction in an instruction register through the data bus 4. The fetched instruction is decoded and applied to a central processing unit CPU as control signals. The CPU executes a predetermined processing according to the control signals and transferres a result to the data bus, if necessary. At this state, if an interruption or a branch operation is not required, the CPU sends a next subsequent address to the instruction memory 2 to fetch a next new instruction. Thus, instructions are sequentially executed one by one. In the case that a break operation is required, a data representing the address to be stopped is preriminarily set in a register 5. A comparator 6 always compares adresses on the address bus 3 to which addresses to access the instruction memory 2 is transferred from the microprocessor 1 with the data set in the register 5 according to a read control signal 7 generated from the microprocessor 1 as a timing signal of an instruction fetch operation. When the data of the register 5 coincides with an address on the address bus 3, the comparator 6 applies a break signal 8 to the microprocessor 1. In response to this break signal 8, the microprocessor 1 stops an execution of a program. At this condition an operator can observe the status of the microprocessor by using a well known debugging procedure. In the microprocessor as shown in Fig. 1, however, many instruction fetch operations FET. are required as shown in Fig. 2. Further, when an instruction concists of an operation code and an operand, a read operation RE. of the operand is further required in addition to the fetch operation FET. . It is therefore difficult to execute a program at a high speed. Moreover, the address bus 3 and the data bus 4 are in an idle state when the microprocessor 1 executes an instruction. That is, an efficiency of a bus utilization is poor. To avoid these defects, a microprocessor shown in Fig. 3 is effective. The microprocessor of Fig. 3 includes an instruction prefetch unit 12 in addition to an instruction execution unit, that is a CPU 11. The instruction prefetch unit 12 has been developed on the basis of the aforementioned locality of an instruction which is a feature of von Neumann computer. In general, the prefetch unit 12 is provided within a bus interface unit not shown and is separated from the CPU 11. The instruction prefetch unit 12 has a memory means, such as a queue memory 13, and a queue control circuit 14 controlling a read operation and a write operation of the queue memory 13 by control signals 15 which are produced in response to a control signal 16 from the CPU 11. The queue memory 13 may have a storage function basically. However, since a sequence control of the stored instructions is required, a First In First Out FIFO memory is generally use. The queue memory 13 in Fig. 3 has a four memory stages, and each stage consists of a higher portion coupled to a higher bus 18 of a data bus 17 and a lower portion coupled to a lower bus 19, respectively. That is, two data e.g. an operation code and an operand are simultaneously read out of an instruction memory and are simultaneously stored in the lower portion Q₀, Q₂, Q₄ or Q₆ and the higher portion Q₁, Q₃, Q₅ or Q₇. Q₀ and Q₁, Q₂ and Q₃, Q₄ and Q₅, and Q₆ and Q₇ are used as a pair register, respectively. Thus, a plurality of instructions are prefetched in one bus access cycle. According to the microprocessor 10 in Fig. 3, the data bus 17 can be effectively utilized as shown in Fig. 4 which indicates an operation flow diagram. The operation flow will be described with reference to Fig. 4. Now, it is assumed that instructions X and A have been stored in the queue memory 13 and that the instruction X is read out of the queue memory 13. The CPU 11 executes the read out instruction X. At this condition, the data bus 17 is released from the CPU. Therefore, an instruction B consisting of an operation code B and an address field B as an operand is prefetched into the queue memory in a step 1 . In this step 1 , the operation code B and the address field B are simultaneously transferred through the data bus 11 and are fetched into the queue Q₂ and the queue Q₃ via the lower bus 19 and the higher bus 18, respectively. In a subsequent step 2 , it is not required to output the result of the execution of the instruction X from the microprocessor 11, so that an execution of the instruction X is started. The CPU 11 sequentially reads the operation code A and the address field A out of the queue memory 13 by means of the queue control circuit 14. Since a long execution period is required in this step 2 , an instruction C consisting of an operation code C only and an operation code D of an instruction D are simultaneously fetched into the queues Q₄ and Q₅, respectively. Further, an address field D and a data field D of the instruction D are continuously fetched into the queues Q₆ and Q₇, respectively. Thus, the two instructions C and D can be prefetched in two bus access cycles. When the result of the execution of the instruction A must be outputted from the CPU 11 to an external device, such as a random access memory, a peripheral device, the CPU sends the result to the data bus 17 after the prefetch operation of the instruction D is terminated and starts an execution of the next instruction B in a step 3 . At this condition, since the data bus 17 is used by the CPU, a new prefetch operation is inhibited. Therefore, the read operation of the instruction B is only performed in the prefetch unit 12. Since, however, a long period is required in the execution of the instruction B, a next instruction E consisting an operation code E and an address field E can be fetched after the writing operation of the result of the instruction A is terminated. In the prefetch operation of the step 3 , the operation code E and the address field E are stored in the queues Q₀ and Q₁, respectively, because these queues have been cleared after the read operation of the instruction A is terminated. In a step 4 , the instruction C is executed and the result of the instruction B is transferred to the data bus 17. Therefore, a prefetch operation by which a new instruction is stored in the queues Q₂ and Q₃ is inhibited. As described above, by using the microprocessor with the instruction prefetch unit 12, the bus can be used effectively, thus a program can be performed at a high speed. However, if the microprocessor 10 in Fig. 3 is used instead of the microprocessor 1 in Fig. 1, a correct break operation can not be obtained. Namely, the instruction prefetch operation is performed independent on the CPU operation as described above, so that the CPU 11 is executing an instruction which was fetched in the past when the brak signal 8 is generated. Therefore, the break signal obliges the CPU 10 to stop at undesired address. As the result, an incorrect break operation is performed. On the other hand, even if an operator tries to set an address different from the address to be actually stopped, the CPU operation sequence and a bus address sequence are very complex and are variable according to instructions to be executed as shown in Fig. 4, and therefore setting of a correct break address is very difficult for the operator. Also, monitoring of the CPU operation and of the instruction prefetch operation is not easy, so that if the monitoring means is added, its structure becomes very complex and many hardware elements are necessarily required. In contrast, according to an improved microprocessor 20 shown in Fig. 5, a correct break operation can be easily performed with a simple hardware means. The microprocessor 20 includes an instruction execution unit CPU 21 and an instruction prefetch unit 22 on a single semiconductor chip. The CPU includes an instruction decoder 23 decoding instructions to be executed, an interruption control circuit 24 and an instruction execution circuit not shown . The instruction prefetch unit 22 includes an instruction prefetch register means 31, a queue control circuit 32, and a decoder 35. The instruction prefetch register means 31 may be a queue memory comprising four stage, that is, a first stage Q₀ and Q₁, a second stage Q₂ and Q₃, a third stage Q₄ and Q₅ and a fourth stage Q₆ and Q₇. The instruction prefetch register means may be the conventional queue memory 13 in Fig. 3. It will be noted in this embodiment that an indication register means T₀ to T₇ are added to the queue memory. The indication register corresponds to the queue in 1 1 relationship, e.g. Q₀ T₀, Q₁ T₁, Q₂ T₂, Q₂ T₃ ..., Q₇ T₇. Elements employed in the indication registers T₀ to T₇ are the same elements as that of the queue memory. That is, the indication registers are the queue memory can be constituded by flip flop circuits. The queues Q₀, Q₂, Q₄ and Q₆ positioned at a lower part are coupled to a lower bus 40 of a data bus 38, while the queues Q₁, Q₃, Q₅ and Q₇ positioned at a higher part are coupled to a higher bus 39 of the data bus 38. The indication registers T₀, T₂, T₄ and T₆ corresponding to the queues Q₀, Q₂, Q₄ and Q₆ are coupled to an output end The decoder 35 may be constructed by logic gates as shown in Fig. 6, in which two inverters 60 and 61 and three NOR gates 62, 63 and 64 are employed. An operation of the decoder 35 is executed according to Table 1. As shown in table 1, when the coded signals 0, 0 are received, the decoder 35 generates an interruption signal 28 at the output end As described above, since the indication registers T₀ to T₇ are added to the instruction queue memory Q₀ to Q₇, the break signal can be easily stored in the indication register, e.g. T₃, when the instruction detected as the break point is prefetched in the selected queue, e.g. Q₃. Thereafter when the instruction is read out of the queue Q₃, the break signal is simultaneously read out of the register T₃ in response to the read signal 33. The read out break signal is applied to the interruption control circuit 24 through the OR gate 25 as an interruption signal. As the result, the break operation can be correctly performed at the desired address according to an interruption operation employed to stop a program sequence. This interruption operation is well known as, for example, a holding operation, a stand by operation, a wait operation. That is, in this embodiment, the break operation can be easily performed by using the break signal read out of an indication register as an interruption signal. In other words, more additional complex circuit for the break operation is not required. Of course the break signal may be applied to another circuit provided to stop a CPU operation. Thus, according to the embodiment, the correct break operation can be performed at will without a complex monitoring means. Further, the break operation may be controlled such that the break operation is performed after the instruction stored in the queue, e.g. Q₃, corresponding to the register T₃ in which the break signal is stored has been executed, or before the execution of the instruction in the queue Q₃ is started. Namely, the start timing of the break operation can be controlled by the interruption operation and can be varied by changing a timing of the interruption operation. Moreover, in order to control the start timing of the break operation, the break signal read out of the indication register may be applied to the OR gate 25 via a delay circuit. Further, the microprocessor in Fig. 5 is designed such that the break operation can be directly performed regardless of the indication registers T₀ to T₇. That is, when the coded signals 0, 0 are applied to the decoder 35, a break signal 28 is immediately generated and applied to the interruption circuit 24 via the OR gate 25. Therefore, the break operation can be set independent on the instruction prefetch operation. This break signal 28 can be also used when a miss break signal is set in an indication register. That is, when the miss break signal was stored in an indication register by an operator, the operator may input the coded signals 0, 0 to the decoder 35. As the result, the CPU operation can be immediately stopped before the CPU executes an undesired break operation. In other words, the undesired break operation according to the indication register can be easily masked by the break signal 28. Moreover, if necessary, an external break signal 27 may be applied to the OR gate 25 as same as the break signals 28 and 29. Fig. 7 shows a block diagram of a microprocessor system in which the microprocessor 20 in Fig. 6 is employed. The microprocessor 20 is coupled to the instruction memory 2 by the address bus 4 and the data bus 3 as shown in Fig. 1. The data bus 38 also can be used as the data bus 3. Further, an external RAM 74 and a peripheral device 73 can be coupled to the data bus 3. The comparator 6 and the register 5 which are required to generate the break signal 8 are provided. Here, the break signal 8 is not directly applied to the microprocessor 20 but is applied to a control circuit 72 which receives an LSB of an address on the address bus 3 and a bus status signal 71. The control circuit 72 generates the coded signals 36 and 37 according to the Table 1. As shown in Fig. 7, by adding a simple circuit 72 to the outside of the microprocessor 20, an improved microprocessor system can be provided. Furthermore, in the case that the break signal 28 in Fig. 5 is not required, the decoder 35 can be modified as shown in Fig. 8. The decoder in Fig. 8 operates according to Table 2. The decoder in Fig. 8 includes three inverters 81 to 83 and two NOR gates 84 and 85 and generates a break signal only when the signals 1, 0 and 0, 1 are received. Therefore, when the LSB of an address on the address bus 4 and the break signal 8 in Fig. 7 are applied directly to the input ends a and b , respectively, a correct break point can be set in the indication registers. While, when the coded signals 0, 0 or 1, 1 is applied to the decoder, no break point is set in the indication registers, so that the CPU operation, the bus interface operation and the instruction prefetch operation can be performed according to the flow in Fig. 4. Of course, when the coded signal 1, 1 is applied to the decoder in Fig. 5, the operation flow in Fig. 4 is also executed. In the case that the break signal 8 is directly applied to the indication registers, a microprocessor system may be modified as shown in Fig. 9. In this Fig. 9, it will be noted that the break signal 8 must be stored in a selected indication register in synchronous with an instruction prefetch operation of the queue memory.