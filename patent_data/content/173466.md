# MICROPROGRAM CONTROL

## Claims
Mikrobefehlsgesteuerte Datenverarbeitungseinrichtung, bei der Maschinenpegelinstruktionen in eine Vielzahl von Phasen unterteilt sind, deren jede durch eine Folge von Mikroinstruktionen ausgeführt werden, die mit Parametern kombiniert werden, welche aus den Maschinenpegelinstruktionen abgeleitet werden, um Steuersignale für die Einrichtung zu erzeugen,

## Description
This invention relates to microprogram control and, more specifically, is concerned with microprogram controlled data processing apparatus. United States Patent No. 3979729 describes a data processing apparatus in which each machine level instruction is divided into a number of phases, such as operand address formation, operand fetch, and execute, and each of these phases is implemented by means of a suitable microprogram sequence. An advantage of dividing the instruction into phases is that, in many cases, the same microprogram sequence can be used for corresponding phases of two or more different instructions this reduces the number of different microprogram sequences required and hence reduces the overall size of the microprogram. For example, a number of different machine instructions may require the address of the operand to be generated in the same way, e.g. by adding a value to a particular base register, and hence these instructions can all share the same microprogram sequence for the address generation phase. British Patent Specification No. 1433076 shows a microprogrammed data processing system in which machine level instructions macroinstructions are executed by sequences of microinstructions, and in which each microinstruction is modified by data derived from the machine level instruction. In this way, the same sequence of microinstructions can be shared between a number of different machine level instructions. This also reduces the total number of different microprogram sequences required. However, in spite of the reductions achieved by these techniques, it is still desirable to achieve even greater reductions in the size of the microprogram. This is particularly important where it is desired to implement a complete processor on a single very large scale integrated circuit VLSI chip. The object of the present invention is therefore to provide a way of reducing the size of a microprogram still further, without loss of flexibility in the system. The invention provides a microprogram controlled data processing apparatus in which machine level instructions are divided into a plurality of phases, each phase being executed by a sequence of microinstructions, the microinstructions being combined with parameters derived from the machine level instructions to generate control signals for the apparatus, characterised by It can be seen that the parameters qualify the effects of the microinstructions, so that the same microprogram sequence can perform different actions in different instructions. This leads to further possibilities for sharing microprogram sequences between different instructions, and hence leads to a further reduction in the number of microprogram sequences required. For example, the operand address generation phases of two instructions may be the same except that one instruction uses one base register whereas the other uses a different base register. With the present invention, both these instructions can be handled by means of a single microprogram sequence, which receives the identity of the required base register as a parameter. The invention also allows the microinstruction width i.e. the number of bits in each microinstruction to be reduced, since some of the necessary control information is provided by the parameters instead of by microinstructions. The parameters may, for example, be derived from the current machine level instruction. In a preferred form of the invention, the apparatus comprises a plurality of separate functional units, each unit having a separate microprogram store and decoder associated with it, and the parameters are fed to all the decoders in parallel over a parameter bus. One data processing apparatus in accordance with the invention will now be described by way of example with reference to the accompanying drawings. The processing apparatus to be described is a microprogrammed processor designed to obey the ICL 2900 order code i.e. machine level instructions and is constructed as a single VLSI chip. Details of the 2900 order code are described in The ICL 2900 series by J.K.Buckle, published by the Macmillan Press Ltd, 1978. Referring to Figure 1, the processor comprises a number of functional units, constituting the main data flow 10 of the unit. These functional units include a register file 11, working store 12, shifter 13 and arithmetic and logic unit ALU 14. The working store 11 contains certain registers used by the order code, including a local name base register LNB , extra name base register XNB , program counter PC , linkage table base LTB , top of stack register TOS , accumulator ACC , and descriptor register DR . Each of the functional units has a separate microprogram read only memory ROM 15 and local decoder 16 associated with it, in close physical proximity on the chip. This layout facilitates an orderly design of the chip, avoiding unnecessary crossovers of signal lines. All the ROMs 15 are addressed in parallel by a microprogram address from a microprogram sequencer circuit 17, so as to read out a microinstruction from each of the ROMs 15 in parallel. The functional units 11 14, the ROMs 15, the decoders 16 and the microprogram sequencer 17 may all be conventional in construction and operation and so need not be described further herein. The processor has an instruction register 18 which holds the machine level instruction currently being executed. The execution of each instruction is broken down into a number of phases, and each of these phases is executed by a particular sequence of microinstructions held in the ROMs 15. The phases are controlled by a phase control unit 19. As will be described in detail below with reference to Figure 2, this unit is a finite state machine having a discrete state for each instruction phase. In each state, the unit 19 produces a set of PHASE signals, which indicate the current phase to be executed. These signals are applied to a look up table 20, to read out the microprogram start address for this phase. The start address is fed to the microprogram sequencer 17, so as to initiate the corresponding sequence of microinstructions. When the last microinstruction in a sequence is executed, the sequencer 17 produces a STEP signal. This is applied to the phase control unit 19 and causes it to step on to its next state, thereby initiating the next phase of execution. The contents of the instruction register 18 are decoded by a decoder 21, to produce a set of steering signals for the phase control unit 19. As will be described in more detail below, these signals indicate the type of instruction read, write, jump etc. and type of operand literal, register, virtual etc. associated with the instruction. These signals are used to steer the phase control unit to its next state at each STEP signal. Thus, it can be seen that for each machine instruction, the phase control unit will be steered through a predetermined succession of states, corresponding to the sequence of phases required to execute the instruction. The contents of the instruction register 18 are also decoded by another decoder 22 to produce a set of microprogram parameters. These parameters are applied to a parameter selection circuit 23. The parameter selection circuit 23 is controlled by the PHASE signals from the phase control unit 19, so as to select a predetermined combination of the parameters in each phase. In general, a different sub set of parameters is selected in each phase although in some cases different phases may share the same parameters. The selected parameters are applied to a bus 24 which broadcasts them to all the decoders 16 in parallel. Each decoder 16 decodes the microinstruction received from the corresponding ROM 15, in combination with the parameters on the bus 24, to produce a set of control signals for the corresponding functional unit 11 14. It can be seen that the parameters modify the effects of the microinstructions, thereby enabling a single microprogram sequence to be used for different phases. Referring now to Figure 2, this shows the phase control unit 19 in detail. The unit comprises flip flops bistable circuits FF1 FF13. At any given instant, only one of these flip flops is set, the others all being unset. Each flip flop, when set, signifies a particular instruction execution phase, as follows The outputs of the flip flops represent the PHASE signals mentioned above which define the current phase of execution. As described above, these PHASE signals are used to select the appropriate microprogram sequence for executing the phase in question. They also control the parameter selection circuit 23 to select the appropriate microprogram parameters for this phase. Details of the microprogram sequences form no part of the present invention and so need not be described herein. The flip flops FF1 FF13 are interconnected by AND gates A1 A15 and OR gates 01 05 as shown, to form a finite state machine. The AND gates also receive the steering signals from the decoder 21. These steering signals are as follows For example, an instruction that performs a direct write to an operand specified by a virtual address will be decoded to produce signals W and VA all the other steering signals will be false. The phase control unit also receives a further steering signal SUCC which indicates a successful jump, i.e. that the jump condition specified in the case of a conditional jump instruction is satisfied. This is derived from a conventional condition testing circuit, not shown. Each of the flip flops FF1 FF13 is clocked by the STEP signal from the microprogram sequencer 17. It can be seen that, at each STEP signal, the output of the currently set flip flop, in combination with the steering signals, causes another one of the flip flops to be set at the same time, the first flip flop is reset. This steps the phase control unit to a new state, so as to indicate the next phase of execution. For any given instruction, the unit is stepped through a succession of states, indicating the successive phases of that instruction. For example, consider the case of an instruction that performs a direct read of an operand specified by a virtual address. In this case, the steering signals R and VA are true, and the other steering signals are all false. Assume that initially the phase control unit is in the END INSTRUCTION state i.e. the flip flop FF13 is set and all the other flip flops are unset. The AND gates A1 and A6 are therefore enabled. Hence, at the first STEP signal, the flip flop FF3 is set. This initiates the PRIMARY ADDRESS phase. In this phase, the microprogram adds a displacement value N, derived from a predetermined field of the instruction register 18, to a specified base register LNB, XNB, PC or LTB, to form the operand address. Since W is false, the gate A8 is now enabled. Hence, at the next STEP signal, the flip flop FF4 is set. This initiates the PRIMARY READ phase, in which the operand is read, using the address calculated in the previous phase. Since INDOP is false, the AND gate A10 is now enabled. Hence, at the next STEP signal, the flip flop FF8 is set. This initiates the UPDATE 1 phase, in which the program counter PC is updated to point to the next machine level instruction. At the next STEP signal, the flip flop FF11 is set. This initiates the READ EXECUTE phase, in which a specified computational operation e.g. add, subtract, compare, shift etc. is performed on the operand and the result placed in a specified register. Finally, at the next STEP signal, flip flop FF13 is set again. This initiates the END INSTRUCTION phase, in which the next machine level instruction, at the address indicated by the program counter PC, is fetched and placed in the instruction register 18. Referring now to Figure 3, this shows the parameter selection circuit 23 in more detail. As described above, the circuit receives a set of microprogram parameters, derived from the current machine level instruction, from the decoder 22. These parameters include the following The parameter selection circuit consists of a number of sets of AND gates A31 A35, controlled by the PHASE signals from the phase control unit 19. Whenever one of these sets of AND gates is enabled, the corresponding parameter is applied to predetermined lines of the parameter bus 24. For example, in the PRIMARY ADDRESS phase, the AND gates A31 are enabled, causing the parameter BASE to be applied to the parameter bus. This is used by the microprogram to select the appropriate base register for calculating the operand address. At the same time, the AND gates A32 are enabled, causing OP SIZE to be applied to the bus. This is used to check for address range violations. In the PRIMARY READ phase, OP SIZE is again applied to the parameter bus, and is used by the microprogram to determine the number of words to be read from the main store. In the UPDATE phase, gate A33 is enabled, which causes I SIZE to be applied to the bus. This is used to control the amount by which the program counter is incremented to give the next instruction address. In the READ EXECUTE phase, the parameters ALU OP and REG are applied to the parameter bus to control the ALU operation in this phase. The selection of parameters for the other phases is similar, and need not be described in detail. It can be seen that a different sub set of parameters is selected and placed on the parameter bus in each of these phases. The number of lines making up the parameter bus is determined by the maximum number of bits required to specify the parameters for any one phase. For example, if no phase requires more than sixteen parameter bits, then the parameter bus can comprise just sixteen wires. The parameters for one phase can be placed on the same lines as those for another phase if required. For example, in this case, the four bits indicating the arithmetic operation in the READ EXECUTE phase occupy the same bus lines as those used to specify the base register in the PRIMARY ADDRESS phase. In conclusion, it can be seen that each phase of the machine level instruction is executed by a sequence of microinstructions held in the ROMs 15. In previously known arrangements, there would have been a separate microprogram sequence for each variant of a particular phase for example, there would be a number of different microprogram sequences for the PRIMARY ADDRESS phase, one for each possible base register. In contrast, in the present invention, a single microprogram sequence is able to handle all variations of a particular phase. For example, a single sequence deals with all the variants of the PRIMARY ADDRESS phase the sequence merely specifies that some base register is to be used, the choice of the base register being determined by the parameter which appears on the parameter bus during this phase. It should be noted that although in the example described above all the parameters are derived from the current machine level instruction, in other forms of the invention some or all the parameters may come from other sources, such as from a status register.