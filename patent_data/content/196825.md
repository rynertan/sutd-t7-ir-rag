# SCALING CIRCUITRY WITH TRUNCATION OFFSET COMPENSATION

## Claims
Skalierschaltung zum Skalieren von pulscodemodulierten PCM Signalabtastwerten,

## Description
This invention relates to circuitry for compensating for the effects of quantization and truncation rounding errors in signal processing systems. The invention will be described in the environment of a recursive filter in a video signal processing system, however, it is to be understood that it is not limited to such applications. In video systems recursive filters may be used to reduce noise in the frequency band of the video signal. From frame to frame there is a relatively high degree of signal correlation. Thus, if a video signal from successive frames is summed, the correlated video signal will add linearly, but random noise accompanying the signal will not. The summed signal is generally normalized to a desired amplitude range and the signal to noise ratio of the averaged signal is enhanced by the processing. A typical video recursive filter includes a delay device coupled in a recirculating loop with circuitry for combining a fraction of delayed signal with a fraction of incoming signal. The combined signal is applied to the delay device which delays the combined signal by the time period necessary to insure that constituent parts of each combined video signal samples are from corresponding pixels of successive video frames. The fractional parts of the incoming and delayed signals are obtained by scaling the two signals by factors K and 1 K respectively. If the amplitude of the incoming signal is equal to the amplitude of the averaged signal from the delay device, the new combined signal will be normalized to equal the input signal. In a digital processing system, the normalization tends to minimize the sample bit size required of the delay device. Thus, if the incoming signal consists of 8 bit samples, the sample size in the delay device can be held to e.g. 9 or 10 bits. This is an important design aspect in reducing the manufacturing costs of recursive filters for consumer applications.. Scaling circuits for use in recursive filters in e.g. consumer television receivers are required to be of relatively simple construction to be cost competitive. One of the simplest scaling circuits and, thus, one which is desirable for use in a digital television receiver, is a bit shifter. The bit shifter, or barrel shifter, shifts the bits of a sample rightward to less significant bit positions to perform division and shifts sample bits leftward to more significant bit positions to perform multiplication. In the divide mode, which mode is appropriate to effect scaling by factors less than one, after the sample bits are right shifted, the shifted sample is truncated by discarding a number of least significant bits equal in number to the number of significant bit positions the sample bits were shifted. Truncation without e.g. rounding and truncation with improper rounding will tend to generate significant anomalies in the processed signal. See B. Gold and C.M. Rader, Scaling by bit shifting and truncation is illustrated in Table I. For illustrative purposes a three bit binary input signal is utilized. All possible three bit binary input values are listed in the leftmost column labelled Binary Input Value and their decimal equivalents are listed in the second column labelled Decimal Equiv. The three bit input values are written with a decimal point and three trailing zeroes for the pupose of indicating the significance of the bit positions. The third column labelled Right Shift 3 Bit Pos., lists binary values corresponding to the values in the first column which have been right shifted three significant bit positions, i.e. the column one values divided by 8. Typically a scaling circuit will truncate or drop off the trailing bits and the resulting binary values are listed under the column labelled Binary Truncated Value and their corresponding decimal equivalents are shown to the right thereof under the column labelled Decimal Equiv. It is seen that all the right shifted and truncated values have a decimal value of zero. The rightmost column labelled Desired Decimal Equiv. indicates the values that would be produced if the truncated values were properly rounded. The values in this column are determined by assuming that all values having dropped bits, which are equal to or greater than one half the least significant bit of the truncated value, should have the least significant bit of the truncated value raised by one unit. J.K. Moore in U.S. Patent No. 4,195,350 entitled Method And Apparatus For Eliminating Deadband In Digital Recursive Filters discloses a method and apparatus for reducing the effects of truncating scaled samples in a recursive filter. In this system samples are scaled by bit shifting. Then the absolute value of the scaled sample is truncated by dropping a number of least significant digits determined by the value of the scale factor. If any of the dropped bits is a logic one value, the value of the truncated sample is incremented by one unit. The incremented, truncated sample is then complemented or not depending on whether the scaled sample was negative or positive respectively. U.S Patent No. 4,236,224 entitled Low Roundoff Noise Digital Filter issued to T.L. Change describes recursive filters wherein the sample sums from the combining means are truncated by dropping a number of least significant bits. The effect of truncation is reduced by scaling the dropped or roundoff bits, delaying and subtractively combining the scaled roundoff bits with the incoming signal and the delayed combined signal samples. The foregoing systems tend to reduce anomalies produced by sample truncation, however, the corrections applied are constrained to the quantization value of the processed samples. In accordance with an aspect of the present invention truncation errors are reduced by introducing correction factors with effective higher resolution than the quantization value of the processed samples. The present invention is a scaling circuit for scaling binary samples by a factor of one or less. The scaling circuit includes a bit shifter for bit shifting applied samples by N significant bit positions to scale the applied samples by a factor of 1 2 The invention will now be described by way of example with reference to the accompanying drawings in which In the Figures, broad arrows interconnecting circuit elements represent multiconductor connections for passing parallel bit samples. Narrow arrows interconnecting circuit elements represent single conductor connections for serial bit digital samples or analog signals. FIGURE 1 is a motion noise adaptive recursive filter for processing video signals. The circuitry circumscribed by the dashed line boxes 21 and 31 defines the more general system. The entire circuitry shown in FIGURE 1 is directed toward the more specific application of separating a luminance component from composite video signal. The circuitry circumscribed in the dashed box 21 is a recursive filter of the type generally described in U.S. Patent No. 4,485,403, and is adaptive by virtue of the capability to change the scale factor K Briefly, circuit 21 operates as follows. Video signal samples, V The samples V Assuming that the input signal is a composite video signal and no provision is made for chrominance phase inversion. The samples V The value of the scale factor K The circuitry circumscribed by the dashed box 31 generates the appropriate sequences of scale factors for the scaling circuits on a pixel by pixel basis. The scale factors or control signals corresponding to scale factors are programmed in a read only memory ROM 38 . ROM 38 produces the scale factors on its output bus responsive to signals indicative of image motion and noise applied as address codewords to its address input port. The address codewords are supplied from Logic 46, comparator 30 and motion memory 34. Circuitry 31 is responsive to the sample differences from subtractor 12. The luminance components of input samples V Output samples from low pass filter 32 are applied to one input of the comparator 30 which compares them to a reference value from adder 42. If the samples from low pass filter 32 exceed the reference value, comparator 30 provides a motion signal for the respective pixel sample, on output connection 13. Low pass filter 32, smooths the sample differences from circuit 28, to preclude the comparator from developing a jittering motion signal for successive samples. The motion no motion signals from comparator 30 are applied to a motion memory 34 which delays them by one or more frame periods. The motion no motion signals and delayed motion no motion signals from comparator 30 and motion memory 34 are coupled as partial address codewords to ROM 38 which outputs the desired sequences of scale factors for scaling the respective circuits on a pixel by pixel basis. Table II shows illustrative scale factors output by ROM 38 for the possible combinations of current and delayed motion no motion signals. A 1 indicates motion has been detected and a 0 indicates no motion has been detected. In Table II it is presumed that the motion signal is delayed by two frame periods and that signals delayed by one and two frame periods are available from motion memory 34. Element 36 coupled to low pass filter 32 detects the smallest image sample difference in each field or frame of video signal. The amplitude of this sample is presumed to be a measure of the noise in the video signal. The minimum differences from detector 36 are smoothed in low pass filter 40 which is a digital filter clocked at the field or frame rate. The output of low pass filter 40 is applied as one input to adder 42 and provides the base line for the reference values coupled to comparator 30. Onto this baseline is added a motion threshold value V The noise related signal from low pass filter 40 is also coupled to the address input of a range logic circuit 46. Range logic circuit 46 which may consist of a priority encoder or a read only memory, generates partial address codewords for ROM 38, which codewords correspond to amplitude ranges of the noise related signals applied to its input. For each successively larger range of noise related samples circuit 46 develops a codeword to condition ROM 38 to select a different set of scale factors. The selected set of scale factors will be used for the entire field or frame period to determine the scale factor sequences for each pixel according to the state of image motion involving each pixel. If the difference samples indicate that the noise content of the input signal is relatively large, the scale factors K In addition to providing the sets of scale factors which are sequenced responsive to the motion signals, ROM 38 provides the control signals to connection 59 of the FIGURE 3 scaling circuit and connection 49 of the FIGURE 5 circuit. ROM 38 provides a 0 value on connection 59 when the address codewords from ROM 46 indicate that the current range of noise values is other than the smallest range, and a 1 value when the noise value is within the smallest noise range. The number of noise ranges will nominally be determined by user preference but it is anticipated that for most purposes three ranges will be sufficient. ROM 38 produces a logic one value on connection 49 FIGURE 5 for the first frames of no motion and zero values at other times. Referring to FIGURE 2, a scaling circuit 62, is shown which embodies the present invention and may be substituted for the scaling circuits 16 and 24 of the FIGURE 1 system. Scaling circuit 62 consists of a bit shift and truncate scaler, 61, e.g. a barrel shifter, and an adder, 60, coupled in series with its input port. Samples to be scaled are applied to one input port, 15, of the adder and scaled and rounded samples are produced at the output 25 of the bit shifter. A value equal to 1 2K, supplied from the motion adaptive circuitry 31, is applied to the second input port of the adder 60 where K is the scale factor by which the scaling circuit alters the applied samples. A shift control signal corresponding to the scale factor K is applied to the bit shifter from circuit 31. Referring to FIGURE 4A, the graph illustrates the output produced by a bit shift and truncate circuit in dividing respective input values by 8. The ordinate corresponds to the value in units of scaled and truncated values, and the abscissa corresponds to input values in units. FIGURE 4A corresponds in part to the values listed in Table I. It is apparent from the graph of FIGURE 4A that the simple bit shift and truncate function produces a result which is biased negatively. The adder 60 in the scaling circuit of FIGURE 2, adds an amount to offset the input values that are applied to the bit shift and truncate circuit, by an amount approximately equal to the bias introduced by the truncation. The amount added is equal to 2 Adding the values 2 FIGURE 4B illustrates the output values of the FIGURE 2 scaling circuit where the bit shift and truncate circuit is conditioned to scale applied samples by 1 8 and a value of four units is added to the respective input values in adder 60. Each output level corresponds to an input level extending approximately half way on either side of each corresponding multiple of the scale factor. This corresponds to, within a one half least significant input bit value, a properly rounded, truncated scaled input value. FIGURE 3 illustrates the details of a scaling circuit 16 which operates in accordance with the principles of the FIGURE 2 scaling circuit but which provides more accurately rounded output values. The FIGURE 3 circuit may be substituted for the scaling circuit 16 of FIGURE 1. In FIGURE 3, element 56 is a scaling circuit and may be of the type illustrated in FIGURE 2. In addition, elements 53 and 54 correspond to a scaling circuit such as the one illustrated in FIGURE 2 with the exception that the offset value applied to the adder 53 is a dithered value rather than a constant equal 30 to 2 The recursive filter 21 of FIGURE 1 tends to average the samples applied to the circuit. Therefore, the samples processed by the scaling circuit 16 will tend to be averaged. Thus, if different offset compensation values are added to the scaling circuit consisting of adder 53 and bit shift circuit 54 the truncated values output by the bit shifter will tend to be averaged. Refer to FIGURE 3 and in particular elements 53, 54, 56 and 57. Samples to be scaled from bus 15 are applied to one input port of adder 53, the output of which is coupled to the input port of bit shift and truncate circuit 54. Bit shift control signals corresponding to the requisite scale factor are applied to circuit 54 from the motion adaptive circuitry 31. Truncation offset compensation values are applied to a second input port of adder 53 from scaling circuit 56. Input values are applied to scaling circuit 56 from a dither signal generator 57. In the illustrated circuit, dither generator 57 randomly generates values from zero to 15, i.e. it produces sixteen four bit values. These values are scaled in circuit 56 by a scale factor equal to 1 16K As an example assume K In relation to FIGURE 4B, on the average, the output levels provided by the FIGURE 3 circuit will tend to be shifted rightward by 0.5 input units which corresponds to a rounding to within one quarter the input quantization level. An alternative circuit for providing dithered offset compensation values to adder 53 consists of a further adder with its output connected to adder 53 and one input port connected to ROM 38. To the second input of this adder, a value of minus one unit is applied for alternate difference samples applied to bus 15. ROM 38 applies values equal to 1 2K The foregoing process applies if the scale factor applied to the circuitry 16 is held constant for a length of time sufficient to allow sample averaging. If the motion adaptive circuitry 31 applies a sequence of scale factors to the circuitry immediately after motion stops, in order to cause the recursive filter to converge rapidly, and each scale factor in the sequence is applied for only e.g. one or two frame periods until the steady state scale factor is applied, then during the application of the sequence of scale factors it may be desirable to apply alternate offset compensation values to adder 53. These alternate offset compensation values may all be selected to equal a zero value. The compensation value during this time is somewhat arbitrary because the system is not expected to converge during the sequencing of scale factors but only to tend toward convergence. To generate the zero valued offset compensation values the scale factor K Scaling circuit 16 includes additional circuit elements 50, 51, 52 and 55 to add the values 1, 0 and 1 to the scaled output values from the bit shift and truncate circuit 54, when less noise reduction is required on the current signal. The values 1, 0 and 1 are added when the sample differences from subtractor 12 applied to the input of the scaling circuit 16 are positive, zero and negative respectively. The effect of adding 1 to the scaled output values is to lessen the effect of the scale factor, i.e. to increase the scale factor. The value of the scale factor modified in this manner is equivalent to the applied scale factor K A signal on connection 59 from the motion adaptive circuit 31 enables the circuit elements 50, 51 and 52. When the signal noise level is low or high the signal on connection 59 is high and low respectively. The 1, 0, 1 values are coupled to adder 55 on bus 58. The least significant bit of these values is supplied from AND gate 52. The remaining bits are supplied by AND gate 50 and all have the same value. Assuming that the signal samples are processed in two s complement form a negative one is represented by all ones , a positive one is represented by a one least significant bit and all zeroes in the more significant bit positions and a zero value is represented by all zeroes. The control signal on connection 59 is applied to respective inputs of AND gates 50 and 52. If the noise level is high, the signal on connection 59 is low and both AND gates 50 and 52 produce zero outputs producing all zero bits on bus 58. Alternatively if the noise level is low and the control signal on connection 59 is high the output of AND gate 50 will be controlled by the sign bit of the sample differences which is connected to its second input. If the sample difference is negative its sign bit is a one value and AND gate 50 will develop all ones on the more significant bit lines of bus 58. If the sample difference is positive, its sign bit is a zero value and AND gate 50 will produce all zeroes on the more significant bit lines of bus 58. AND gate 52 and consequently the least significant bit of bus 58 is determined by the output of OR gate 51 when the control signal is high. All of the bits of the difference samples are applied to respective inputs of the OR gate 51. If any one of the sample bits, including the sign bit, is non zero, indicating a non zero sample difference, OR gate 51 produces a one value at its output which in turn conditions AND gate 52 to produce a one on the least significant bit of bus 58. The bus 58 will have all zero bit values for the condition that the control signal is low or for the condition that the control signal is high and all of the bits, including the sign bit, of the sample difference are zero. Elements 24 and 26 are added and coupled with recursive filter 21 in order to process composite video to produce a noise reduced luminance component with complete cancellation of the chrominance component. To accomplish this, the chrominance component V Noise reduced luminance, with the chrominance component cancelled, is available at the output port of adder 26. Samples from delay element 22 are coupled via compensation delay element 23 to one input port of adder 26. Scaled sample differences from scaling circuit 24 are coupled to a second input port of adder 26. Sample differences from subtracter 12 are applied to the input of scaling circuit 24. Output samples, V In the first frame of no motion, K In the second and all succeeding frame periods in which there is no motion the scale factor K For the above system the motion adaptive circuit 31 provides the scale factors to scaling circuits 16 and 24. However, each set of scale factors will contain only three values as indicated in Table III. The value K The scale factor 1 2 K The scaling circuit 16 shown in FIGURE 5 is a variation of the FIGURE 3 circuit with additional elements 90, 91 and 92 to provide scaling by reciprocal binary multiples and by a scale factor which approximates the factor 1 2 K During intervals that the scaling circuit 16 is conditioned to scale input samples by 1 or the reciprocal of a binary multiple, elements 53, 54, 56 and 57 in FIGURE 5 operate as described with reference to FIGURE 3. Gate 91 is disabled effectively disconnecting elements 90 and 91 from the circuitry. The output of the scaling circuit which corresponds to the output of adder 92 is equal in value to the output of bit shift and truncate circuit 54. When it is desired to scale by the factor 1 2 K Scaling circuit 24 may be realized with e.g., a FIGURE 2 type circuit or a FIGURE 3 type circuit. The FIGURE 3 circuit is applicable even if there is no subsequent circuitry to average the output samples from elements 24 and 26 if the signal will be used to create a display on a kinescope. In this instance, the persistence of the kinescope phosphor coupled with the relatively slow response time of the human eye tend to perform the integration or averaging. FIGURE 6 is a psuedorandom number generator 57 which may be substituted for the dither generator 57 of FIGURE 3. The random number generator 57 is of conventional design and consists of the cascade connection of five one sample period delay stages 72 76. The delay stages 72 76 are clocked synchronously at the input sample rate f