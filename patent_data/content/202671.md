# Method of storing and retrieving image data

## Claims
Verfahren zum Speichern von Abbildungsdaten eines Originaldokuments 12 in einem Dateispeicher 5 eines Dateisystems durch

## Description
The present invention relates to a method of storing and retrieving image data. More specifically, the invention relates to a method of storing secondary data such as memos added to document image as index data of a document image and to a method of retrieving the document image by utilizing the secondary data. Accompanying the recent trend toward putting into practice the optical disc device which is capable of storing large amounts of data, attention has been given to a document image filing system as a new document control means to electronically file the document data and to retrieve the data by using a display device. If the content of a document is treated as an image, the document which includes figures and photographs in addition to characters can be electronically filed. Therefore, a wide range of documents such as general literatures, books and slips, design drawings, written contracts, and the like can be stored in a memory device. According to a conventional retrieval system, index data such as names of the documents, classification codes, keywords and the like are registered in correspondance with the document images. To retrieve the data, a user designates these index data so that the contents of the corresponding document are produced on the display device. A system of this type has been disclosed, for example, in a journal NIKKEI COMPUTER published by Nikkei McGrawhill Co., December 26, 1985, pp. 62 64. As a method to facilitate the retrieval of the document image, the applicant of the present invention has proposed a method of retrieving an image in JP A 59 183 458 according to which secondary reference data such as memos specific to the image data are registered, and the image data is specified with reference to the thus registered data at the time of retrieval. Further, a device for filing an image in which the user has to indicate regions in the image which contain information used for file management is described in EP A 0 117 336. The image information used for file management is encoded and stored in a file management memory. The encoding process converts the image data of a text into character codes. The data in the file management memory may be used by the user for retrieving the desired document. This system has the disadvantage that the retrieval data is necessarily a part of the original document. The region containing this data has to be indicated by a user. Only the remaining part of the image area may be used for the desired picture. It is therefore an object of the invention to provide a method for storing and for retrieving document data in a filing system which is easy and convenient to use. Starting from the method known from the above mentioned EP A 0 117 336, this object is achieved by the method defined in claim 1. The memo data may include memos written by the user on the document, and or marks such as underlines and boxes or surrounding marks attached to particular words and description in the document. The data that represents the local region includes position coordinates of the local region, document image in the local region, and character codes obtained by discriminating the characters contained in the local region. The data that represent the local regions are rearranged for every classification section of the secondary data, and are stored in the second memory region. According to the method of retrieving a document image of the present invention, the user designates a classification section of the secondary data, so that the contents of local region in the document image or the contents of memo data corresponding to the underlined portion are displayed in the form of a look up table or list on the display device, and the user then selects one of the secondary data that are displayed. Through the select operation, a document image corresponding to the selected secondary data is read from the first memory region and is displayed. According to the present invention, the user inputs the processed document to easily prepare a secondary data file that corresponds to the document which has been registered in the filing system. The largest portion of the image of the processed document has been stored in the file of the original document. In the secondary data file the information added by the user or the image of a portion of the original document related thereto needs to be stored. Therefore, the secondary data file may be a personal file such as a floppy disc having a small memory capacity. According to the present invention, a plurality of users are allowed to have their own secondary data files without changing the contents of the common file in which are stored images of the original documents, and are hence allowed to quickly take out desired document images from the common image file with reference to their own memo data stored in the secondary data file. The foregoing and other objects, advantages, manner of operation and novel features of the present invention will be understood from the following detailed description when read in connection with the accompanying drawings. The invention will now be described by way of embodiments. Fig. 1 shows a system for retrieving document image data to which the present invention is adapted, wherein reference numeral 1 denotes a microprocessor CPU , 2 denotes a main memory MM , 3 denotes a keyboard KB , 4 denotes an image scanner IS , 5 and 5 denote filing devices FD , 6 denotes a bit map memory BM , 7 denotes an image processor IP , 8 denotes a display controller DC , 9 denotes a CRT display, and 10 denotes a printer PR . First, described below is the processing for extracting the secondary data memo portion only from the processed image hereinafter referred to as image with memo to which secondary data such as memo is added. Fig. 2 is a diagram which schematically illustrates the process for extracting the secondary data. First, an original document 11 is taken from the image scanner 4 into the bit map memory 6 to obtain an original image 12. The original image 12 is stored in the file 5 which consists, for example, of an optical disc. In order to align the positions of two images that will be described later, the image processor 7 writes a rectangular frame FR at a predetermined position on the original image 12 depending upon the instruction from the CPU 1 to thereby prepare an image 13 with frame which will be produced by the printer 10 as an original paper 14 for processing the document. A memo e.g., underline is added onto the original paper 14 to prepare a processed document 15 with memo. The processed document 15 is read by the image scanner 4 and is input as an image with memo 16 to a region different from the region where the image 13 with frame has been stored on the bit map memory 6. With an ordinary image scanner, it is difficult to completely convert the paper surface into an image thereof without rotation or skew. The printer 10 and the image scanner 4 usually have different picture element densities. In order to bring the skew and size of the image 16 with memo into agreement with those of the image 13 with frame, therefore, the normalization is effected by using, for example, the rectangular frame FR to obtain a normalized image 17. Then, the image 13 with frame and the normalized image 17 are matched with each other, to obtain a differential image 18 in which are left non coincident portions only. The differential image contains, in addition to memo data, deterioration data of the original image caused by passing the image 13 with frame through the processor 10 and the image scanner 4. Finally, the deterioration data is removed from the differential image 18 to obtain a memo image 19 which contains memo data only. The above mentioned processing is wholly controlled by the CPU 1, and the individual image processings are performed by the image processor 7 according to the instruction from the CPU 1. When the image 13 with frame is to be prepared from the original image 12, the rectangular frame FR that serves as an indication of reference position is described at a position maintaining a predetermined distance a from the edge of the original image 12. The rectangular frame FR may be replaced by other mark that indicates the position. To draw straight lines or the rectangular frame FR on the bit map memory 6, the element patterns of the lines should be written successively in the up and down direction and in the right and left direction. In the write processing of the rectangular frame, black picture elements of the regions outside the frame FR on the original image 12 are all converted into white picture elements so that the normalization processing can be carried out conveniently as will be described later. In the processing for preparing the normalized image 17 from the image 16 with memo, a step is carried out to find the skew of the image 16 with memo by detecting four straight lines that constitute the rectangular frame FR, and a step is further carried out to convert the coordinates of the whole image in order to correct the skew of the image 16 with memo and to correct, depending upon the cases, the size thereof, such that the rectangular frame of the image 16 with memo and the rectangular frame of the image 13 with frame are brought into agreement with each other. Straight lines constituting the rectangular frame FR can be detected by a variety of known methods. As one of such methods, sue is made here of a known algorithm of Hough conversion. Fig. 3 is a program flow chart for detecting a vertical line located on the left side among the four straight lines of the rectangular frame FR, and Fig. 4 is a diagram to explain the detection of the line. In Fig. 4, γ and x sin and y cos and is an equation of the straight line that is to be found, wherein γ and denotes a distance from the origin 0, and and denotes a skew of the straight line. The feature of Hough conversion is that the straight lines can be detected irrespective of partial noise data in the image. The outline of this algorithm is as described below. That is, in the flow chart of Fig. 3, a candidate of a point such as a black picture element P Left upper, right upper, left lower and right lower corner points of the rectangular frame FR are found from the intersecting points of these four straight lines, and are denoted as 0, 0 , M A coordinate x, y corresponding to a lattice point X, Y is found according to an equation, Generally, however, the coordinate x, y does not serve as a lattice point on which a picture element exists. Therefore, fraction over 1 2 is counted as one and the rest is disregarded to find an integer in order to use a value of lattice point which is closest thereto, or the logical sum of concentrations of the surrounding lattice points is interpolated to find a concentration that is to be used as the concentration at x, y . In the foregoing was described an embodiment to utilize the outer frame constituted by four lines as a mark for aligning the position. However, methods can further be contrived to achieve the matching by attaching characteristic points to the four corners, and to achieve the matching relying upon the characteristic points of the original document without adding any particular marks. In the foregoing was described the case based on the prerequisite that the distortion caused by the difference in the picture element density between the printer 10 and the image scanner 4 was linear. With an apparatus of the type in which a line sensor of the image scanner 4 is driven by a motor, however, there may develop non linear distortion being caused by the drive speed which is not constant. In this case, use is made of a sectionalized frame FR as shown in Fig. 5, change in the distance is detected relying upon a plurality of parallel lines forming the sections, and the aforementioned conversion is performed with a small region as a unit, in order to obtain a normalized image maintaining a high precision. Described below is a process for preparing a differential image 18 from the image 13 with frame and the normalized image 17. The differential image can be easily prepared by comparing the image 13 having frame with the normalized image 17 with a picture element as a unit, and rendering the non coincident portions to be black and the coincident portions to be white. To distinguish the memo data over the noise, however, the procedure should be carried out as described below. In Fig. 6, reference numeral 13 denotes an image with frame having a pattern S1, 17 denotes a normalized image having a pattern S1 that is deformed by noise and having a pattern S2 added as memo data, 13 denotes an image 13 with frame which is processed to expand the pattern S1, 18 denotes a differential image obtained from the images 13 and 17, and 18 denotes a differential image obtained from the images 13 and 17. Now, if the concentrations of given picture elements x, y of the image 13 with frame and of the normalized image 17 are denoted by f x, y and g x, y , the image being supposed to be binary image, the concentration of the black picture element being denoted by 1 and the concentration of the white picture element being denoted by 0 , then the image 13 is obtained by performing the operation, By using the image 13 with frame in which the black picture element region is expanded as mentioned above, if the region of black picture elements is found in the normalized image 17 and the region of white picture elements is found in the expanded image 13 , there is obtained the differential image 18 which contains memo data S2 only. The above processing is expressed by the following equation, As will be obvious from the comparison of the image 18 with the differential image 18 which indicates noncoincident portions between the image 13 and the normalized image 17, the expansion processing makes it possible to make the differential image free from noise region S3 added to the initial pattern S1 or the portions missing from the initial pattern, that are caused as the image is passed through the printer 10 and the image scanner 4. In the above embodiment, the expansion processing was performed based upon the logical sum of the neighboring four picture elements. It is, however, allowable to expand the logical sum to include the neighboring nine picture elements, the neighboring 16 picture elements, and so on. Depending upon the kind of memo to be treated, furthermore, the expansion processing can be eliminated. A process for preparing a memo image 19 from the differential image 18 will now be described. This process is to remove noise from the memo data that has noise which could not be removed by the above mentioned process. Here, it is presumed that the noise has a line width smaller than that of the memo data, and the noise is removed by the contraction conversion, and the line width of the memo data is restored by the expansion conversion. The differential image 18 is denoted by h x, y . First, the black region of the differential image 18 is contracted. The contraction is realized by effecting the operation. Described below is a process which discriminates the kind of memo data to prepare a secondary data file depending upon the kind of memo data. Fig. 7 shows a relationship among a processed image 16 to which memo data is added, wherein X represents arbitrary characters, a memo image 19, and a divided region image 20 in which a circumscribing rectangle is found for each region of continuous black picture elements in the memo image 19. Here, the memo data includes three types of data, i.e., underline M1, box or surrounding mark M2, and notes M3. In addition to these memo data, the memo image 19 contains noise N that was not removed from the differential image by the conversion into memo image 19. The noise component N is discriminated and removed by the step of classifying the memo data that will be described later. First, described below is a process for preparing the divided region image 20 from the memo image 19. Here, the image is divided into units of regions of continuous black picture elements. Memo number is attached to each of the regions. A variety of algorithms have heretofore been proposed to cut out the continuous region. The continuous region can be cut out, for example, by the labelling algorithm disclosed in a paper entitled Pattern Data Processing by Makoto Nagao, the Japanese Association of Electronic Communications, 1983, p. 84. Labels 1 to 6 attached to the individual regions are corresponded as memo numbers to a clolumn 40 of region table TB1 as shown in Fig. 8. The heights of the regions are calculated from the coordinates of the uppermost and lowermost portions of the regions, and are written onto a column 41 of the table. The widths are also calculated from the coordinates of the leftmost and rightmost portions, and are written onto a column 42. The region table TB1 is prepared in a work area in the main memory 2. The memory data are classified by calculating a variety of parameters based upon the data of circumscribing rectangles found by dividing the region, and comparing them with predetermined classification standards. In this example, there are three classification parameters that are stored in the columns 43 to 45 of the table TB1. A first parameter stored in the column 43 is defined by the width height of the region and represents a ratio of the height to the width of the region. In the case of the underline , the value of the first parameter becomes greater than that of other memo data. Depending upon the value of the first parameter, therefore, the underline can be discriminated from other memo data. A second parameter stored in the column 44 is defined by the width plus height, and represents the size of the region. In the case of the noise, the value of the second parameter becomes smaller than that of other memo data. Therefore, the noise can be discriminated from the memos. A third parameter stored in the column 45 represents a ratio of black picture elements that occupy the area of the region in the original image 12 at a position that corresponds to the region. The box or surrounding mark contains the original image that exists in the corresponding region. Therefore, the third parameter has a large value i.e., the value is small in the case of other memo data. Namely, the box or surrounding mark can be discriminated from other memo data. Fig. 9 is a flow chart of a program for classifying the memos using the above mentioned parameters, wherein Q The secondary data file for retrieving the document image is then prepared based upon the memo data that are classified as described above. For instance, the underline M1 is presumed to be a sign that is drawn under the keywords in a sentence, and a train of characters above the underline in the document image is cut out so as to be used as a retrieval data. To cut the train of characters designated by the underline, a rectangular region 83 having, as a base, the base 82 of a circumscribing rectangle 81 of the underline M1 and having a predetermined height H, is set in a processing region on the original image 12 or on the image 13 with frame as shown in Fig. 10A. The image in the rectangular region is then projected in the lateral direction as shown in Fig. 10B in order to find a distribution 84 of black picture elements. From this distribution, a boundary 85 of character train 86 of the lowermost line in the rectangular region 83 can be found, thereby to obtain the position and size of the local region where the character train 86 exists. The box or surrounding mark M2 can be treated as a sign that represents the number of an important drawing quoted in the document. In this case, characters in a local region in the original image specified by the circumscribing rectangle of the box or surrounding mark are recognized. The recognition can be performed by adapting a variety of algorithms that have heretofore been used with the existing OCR apparatus, or can simply be performed by the method of pattern matching disclosed in the aforementioned literature compiled by the Japanese Association of Electronic Communications, p. 98. The recognized result is used as a retrieval data together with a pointer of from the sentence to the drawing number, as has been disclosed, for example, in JP A 61 151 890 entitled A system for retrieving document image data filed by the same applicant as the present application. The note M3 is extracted as a circumscribing rectangle on the divided region table TB1 with a character as a unit. In order to collect a series of characters into a local region, therefore, the neighboring rectangular regions are collected together. This process is realized by expanding the individual circumscribing rectangles at a predetermined ratio, and collecting the regions that are overlapped into one. Fig. 11 shows a data format of the thus extracted secondary data file 90, wherein reference numeral 91 denotes a code data such as image number that serves as a pointer tb the original image, and reference numerals 92, 93, and 94 denotes columns for storing the secondary data that correspond to the note M3, underline M1, and box or surrounding mark M2. A coordinate x The data in the secondary data file 90 consist chiefly of coordinates that specify the local region in the original image. When the document image is to be retrieved, the local region is extracted from the document image based upon the coordinate data to display the contents thereof. Since the amounts of secondary data corresponding to the document images are not so large, the secondary data file 90 may be comprised of a magnetic memory device having a relatively small memory capacity, i.e., may be comprised of a filing device 5 such as a floppy disc, that is separate from the filing device 5 of a large capacity such as an optical disc which stores document images. The secondary data may be stored in the file 5 consisting of an optical disc, as a matter of course. In the above mentioned embodiment, furthermore, the local region designated by the underline M1 is stored by way of position coordinates, and the contents of the local region are extracted from the file of original images. This, however, may be so modified that a keyword contained in each of the local regions is stored as a character code in the column 93 of the secondary data file, and is used for attaining the matching with respect to a designated keyword at the time of retrieving the image. In the above description, the underline was cut out mark, and the box or surrounding mark was recognition mark. It is, however, also allowable to define the underline as a recognition mark and the box or surrounding mark as a cut out mark. Further, in the foregoi was described to recognize the drawing number. However, it is also allowable to recognize the literature number, to cut out the name of the corresponding literature from the end of the literature, in order to store and display it. It is further possible to provide a correcting function relying upon the interactive processing to cope with the situations where the classified results are not correct. Described below is a method of retrieving the document image according to the present invention by utilizing the contents of the above mentioned secondary data file. Fig. 12 shows a retrieval screen displayed on the CRT 9 in retrieving the document image, wherein reference numeral 50 denotes an ordinary retrieval screen which depicts the results of when a classification code is designated. If the user requests the display of underlined portion under the condition where the data such as the name of document or its number has not been clearly stored, the underlined portion only is displayed with a document as a unit as designated at 51 in Fig. 12. Further, if the user requests to display the drawings or the notes, the contents are displayed as designated at 52 or 53 in Fig. 12. The drawing numbers have been recognized and corresponded to the description. Therefore, the retrieval system of the aforementioned application that has been filed already can be utilized to compare the description with the drawings after the retrieval to display them. It is allowable to display, at the time of retrieval, a plurality kinds of memos in the form of a list as a matter of course. Fig. 13 shows a whole procedure for storing and retrieving the document image data executed by the document image processing system of Fig. 1. The image processing can be roughly divided into four processes that are executed depending upon the command inputs step 100 sent from the keyboard 3. A first process is to store a document image through steps 110 to 118. In the step 110, the image of the original document is input from the image scanner 4 to a predetermined area in the bit map memory 6, and the input image is displayed on the CRT 9 step 112 . If the input image is not perfect, and the operator instructs to input the image again, the process returns to the step 110. The operator who has confirmed the image quality then inputs the document number corresponding to the document, classification code and keyword step 116 using the keyboard 3. The input document image is therefore stored in the filing device 5 together with these codes. A second process is to print out the original paper for a processed documant through steps 120 to 132. As the document number or the keyword is input step 120 through the keyboard 3, a corresponding document image is retrieved step 122 out of the documents stored in the filing device 5, read into the bit map memory 6 and is displayed on the CRT 9 step 124 . To the document image is added a rectangular frame FR step 126 to indicate the reference position mentioned earlier. The region surrounding the rectangular frame is cleared step 128 , and the document image is sent as an image with frame to the CRT 9 and the printer 10 steps 130 to 132 . A third process is to store the secondary data through steps 140 to 162. In this process, a processed document consisting of the document with frame produced previously onto which is writen memo data, is input from the image scanner 4 step 140 , and whereby the skew is corrected and, as required, the size is corrected step 142 . Next, as the operator inputs the document number or the keyword of the document, the corresponding original image is retrieved from the filing device 5 and is displayed steps 144 to 146 . If the memo data and the original correspond to each other, the memo data are extracted and classified through steps 150 to 156, and the results are displayed. If the operator who has confirmed the displayed contents inputs an OK sign, the memo data are stored in the aforementioned secondary data file 5 step 162 . If the displayed contents are not correct, the error is corrected at a step 160, and the corrected result is stored in the secondary data file. A fourth process is to retrieve the document image through steps 170 to 176. As the operator designates the classification code of memo data, the document data file 5 is accessed in accordance with the data of a corresponding classification section in the secondary data file 5 . For example, the image of a local region in the document corresponding to the underline is displayed in the form of a list step 172 . When the note is designated, the image of note characters are read out from a separate region of the secondary data file 5 , and is displayed in the form of a list. If the operator selects any one of the memory data step 174 with reference to the contents of the list that is displayed, the document image of a corresponding image number is retrieved from the file 5, and is displayed on the CRT steps 176 and 178 . In the above mentioned flow chart, the operator inputs the image number of the original image in storing the secondary data. This, however, may be eliminated by automatically outputting the image number 91 to the processed document in the second process as shown in Fig. 14, and by automatically recognizing the image number 91 at the step 144. In the above embodiment, the secondary data were displayed depending upon the kinds. However, the system may be so designed that two or more kinds of secondary data are displayed simultaneously. According to the present invention as will be understood from the foregoing description, the user stores the notes written onto the document, as well as principal words and sentences in the document specified by a mark such as an underline, in the form of secondary data and memo data that are to be retrieved. Therefore, even when the user does not remember the correct name of the document or the keyword or even when he remembers them vaguely, the desired document can be efficiently retrieved with reference to the secondary data file. By utilizing the secondary data, a plurality of documents can be displayed at one time in a compact form, making it possible to greatly reduce the time for retrieval compared with the method by which the contents of the whole documents are successively displayed and retrieved one by one from the file of the original documents. Moreover, each user is allowed to possess the secondary data file as his own file and is, hence, permitted to store and utilize his own memo data irrespective of other users. In the above embodiment, although the document file 5 is made up at user side through the first process, an existing document file supplied by a publishing firm may be available to produce the original paper 14.