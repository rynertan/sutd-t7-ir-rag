# Demodulators.

## Abstract
A high quality demodulator uses software techniques to recover digital data from an FSK or PSK modulated signal. A Software Costas loop is utilised to convert representative samples of the incoming signal to a baseband signal which is further software processed by a second software loop to provide I and Q output signals with associated timing information. The representative signal samples are derived by Sub Nyquist sampling under control of a microprocessor 100 which provides control values to a digitally controlled oscillator 102 . The digitally controlled oscillator 102 controls a sample and hold circuit 103 to select representative signal samples of the in phase and quadrature phase modulation.

## Claims
Claims. 1. A demodulator for recovering digital data from a frequency shift keyed FSK or phase shift keyed PSK modulated signal characterised in that an incoming signal is applied to an input of a microprocessor 100 which is programmed to subtract a mathematical function 1 representative of the carrier signal from the incoming signal to provide a baseband signal containing the data to be recovered, said microprocessor lOO also being arranged to derive from said baseband signal a value representative of the apparent phase difference between the actual carrier and said mathematical function and to vary said mathematical function in dependance upon said derived value, and said microprocessor 100 is further arranged to recover the digital data from said baseband signal and to derive timing signals from said baseband signal in respect of said recovered data and to provide signals at an output 108, 109 representing the recovered data and timing related thereto. 2. A demodulator as claimed in Claim 1 further characterised in that said microprocessor 100 is arranged to provide signals at a first output 108 representing the data and timing for data if any which is in phase with the carrier signal and to provide signals at a second output 109 representing the data and timing for data if any which is in quadrature phase with the carrier signal. 3. A demodulator as claimed in Claim 2 further characterised in that the data at each of the outputs 108, 109 is in respect of a plurality of independant data channels. A A demodulator as claimed in Claim 1, Claim 2 or Claim 3 further characterised in that a sampling circuit 103 is controlled by a variable function derived by the microprocessor 100 to sample an incoming signal at periodic intervals, said circuit being arranged to hold a value representative of the incoming signal at the instant of sampling and to provide a signal to the microprocessor 100 representing the value held. 5. A demodulator as claimed in Claim a further characterised in that the sampling circuit 103 samples in the manner known as sub Nyquist sampling. 6. A demodulator as claimed in Claim a or Claim 5 further characterised in that the control signals from the microprocessor 100 control the frequency of an oscillator 102 which in turn controls the sampling circuit 103 . 7. A demodulator as claimed in Claim 6 further characterised in that the oscillator 102 is a digitally controlled oscillator. 8. A demodulator as claimed in Claim 6 or ClaIm 7 further characterised in that the sampling circuit 103 Is an analogue sample and hold circuit. A A demodulator as claimed in Claim 1, Claim 2 orClaim 3 further characterised in that a sampling circuit 103 is controlled by a function derived by the microprocessor 100 to sample an incoming signal at periodic intervals and to provide a signal to the microprocessor 100 representing the value held and an oscillator 300 is responsive to signals from the microprocessor 100 to vary the synthesised carrier frequency mixed with an incoming signal prior to sampling. 10. A demodulator as claimed in Claim 7 or Claim 8 further characterised in that the digitally controlled oscillator 102 comprises a first divider 309 arranged to divide an input reference frequency Fr by a first fixed function N and to provide an output signal to cause a second divider 311 to divide the input reference frequency Fr by a variable function f Ng determined by the microprocessor 100 to provide a first sampling signal to the sampling circuit 103 and to provide a start signal to a third divider 310 arranged to divide the reference frequency Fr by a further fixed function C and to provide a second sampling signal to the sampling circuit 103 .

## Description
Demodulators The present invention relates to demodulators and more particularly but not exclusively to demodulators for demodulating frequency shift keyed FSK and phase shift keyed PSK signals which carry digital data. One form of FSK signalling is known as minimum shift keyed MSK or fast frequency shift keyed FFSK signalling. MSK signals, in which the frequency difference between the upper frequency and and lower frequency is substantially equal to half the data rate, lead to an economic use of frequency bands but require high quality demodulators to ensure accurate determination of the received data. Two principal forms of PSK signalling known as bi phase shift keying BPSK and quadrature phase shift keying QPSK are commonly used in radio communications and demodulation of these signals is also discussed herein. In implementing the present invention with respect to MSK signalling use is made of a suppressed carrier synchronisation loop known as a Costas loop. A full description of such a loop appears in the Proceedings of the IRE Volume 44, December 1956 at pages 1713 to 1718. In In PSK demodulation a known carrier tracking loop which is described by Spilker J.J. in the book Digital Communications by Satellite published by Prentice Hall Inc. of New Jersey at pages 308 to 310, is used.Reference is also made to a digital transition tracking loop DTTL , a description of which appears at pages 437 to 443 of the above mentioned book. In a modification of the apparatus hereinafter described reference is also made to a long loop con figuration which configuration has been described byBiswas et al in an article entitled HeterodynePhase Locked Loops Revisited at pages 1164 to 1170 of the IEEE Transactions on Communications, VolumeCom 25, No. 10, October 1977. Provision of conventional high quality radio communications receivers for example for decodingMSK signals is often hampered by a lack of available space in which to mount the equipment. This is particularly so when the receiver is used in for example a vehicle, vessel or aircraft. It is an object of the present invention to provide a high quality demodulator which requires less space than a conventional demodulator of similar quality by using digital demodulation techniques. According to the present invention in a demodulator for recovering digital data from a frequency shift keyed FSK or phase shift keyed PSK modulated signal, an incoming signal is applied to an input of a microprocessor which is programmed to subtract a mathematical function representative of the carrier signal from the incoming signal to provide a baseband signal containing the data to be recovered, said microprocessor alsd being arranged to derive from said baseband signal a value representative of the apparent phase difference between the actual carrier and said mathematical function and to vary said mathematical function in dependance upon said derived value1 and said microprocessor is further arranged to recover the digital data from said baseband signal and to derive timing signals from said baseband signal in respect of said recovered data and to provide signals at an output representing the recovered data and the timing relating thereto. Preferably said microprocessor is arranged to provide signals at two separate outputs said signals representing respectively the data and timing for data if any which is in phase with the carrier signal and the data and timing for data if any which is in quadrature phase with the carrier signal. The in phase and quadrature phase data timing may each be in respect of a plurality of independent data channels. The demodulator may be arranged to demodulate frequency shift keyed FSK signals, more particularlyMSK signals, or phase shift keyed PSK signals, more particularly bi phase shift keyed BPSK or quadrature phase shift keyed QPSK signals. A demodulator in accordance with the invention will now be described by way of example only with reference to the accompanying drawings of which Figure 1 is a block schematic diagram of the demodulator Figure 2 is a schematic of a part of an algorithm used by the microprocessor of Figure 1 to recover data and timing from an FSK signal Figure 3 is a schematic of a part of an algorithm used by the microprocessor of Figure 1 to recover carrier information from an FSK signal Figure 4 is a schematic of a part of an algorithm used by the microprocessor of Figure 1 as an alternative to that shown in Figure 3 for recovery of carrier information using sub Nyquist sampling Figure 5A and B show respectively how to assemble Figures 3 and 2 and Figures 4 and 2 to show the complete algorithm used by the microprocessor ofFigure 1 Figure 6 is a block schematic of demodulator phase locked loops Figure 7 shows how to assemble Figures 8 and 9 Figures 8 and 9 when assembled as shown in Figure 7 is a flow chart for the program of the microprocessor of Figure 1 when using the algorithm of Figures 4 and 2 when assembled as shown in Figure 5B, Figure 10 is a schematic diagram of an algorithm used by the microprocessor of Figure 1 to recover data from a PSK signal Figure 11 shows how to assemble figures 12 to 14 Figures 12 to 14 when assembled as shown inFigure 11 is a flow chart for the microprocessor ofFigure 1 when using the algorithm of Figure 10 Figures 15 and 16 are explanatory timing diagrams relating to the algorithm of Figure 10 Figure 17 is a block schematic diagram of a demodulator modified to counteract frequency skew which occurs in satellite communications systems and Figure 18 is a block schematic diagram of a practical implementation of digitally controlled oscillator hardware for the demodulator of Figure 1. A known variation of an analogue suppressed carrier synchronisation loop known as a Costas loop is shown for MSK at the left of Figure 6 to which reference is now made. A voltage controlled oscillator VCO 1 is controlled to oscillate at the same frequency as the carrier of a modulated signal received at an input 2.After filtering by a filter 1 the modulated signal is converted to a baseband signal by a mixer 3 with the output signal of the oscillator 1 and is similarly converted to a baseband signal by a mixer 4 with the output signal phase shifted by 900 by a phase shift circuit 5. The two baseband signals referred to respectively as I in phase and Q Quadrature signals appear at respective outputs 6 and 7. The signals at the outputs 6 and 7 may be applied to an integrate and dump circuit not shown to recover digital information.The dump timing which is recovered by a further loop shown to the right of Figure 6 appears at outputs 8 and 9, in the case of the Q signal, the timing signal being phase shifted by 90 by a respective phase shift circuit 10. The carrier oscillator control voltage is derived by combining the I and Q signals after filtering by respective arm filters 11 and 12. The I and Q signals present after filtering are mixed by a mixer 14 and combined with a clock signal from a clock voltage control oscillator 16 in a mixer 15. The signal from the mixer 15 is applied to the loop filter 1 and thence to the VCO 1. The timing signals at the outputs 8 and 9 are locked to the incoming signal in the second phase locked loop in which the I and Q signals are squared 17, 18 and mixed together, 19 with a control signal derived from the quadrature channel clock 20. Squaring of the channel data results in the timing signals being at twice the data rate. Thus before being output, the frequency of the clock signals is halved by respective dividers 21 and 22. Referring also to Figures 2 and 3 when assembled as shown in Figure DA, the Cost as loop of Figure 6 may be digitized as shown. To assist understanding those parts of the algorithm which correspond to integers of the analogue costas loop are similarly designated with the addition of a prime . The received signal at the input 2 may be rePresented as EMI5.1 In the multipliers 3 , 4 the cosine and sine respectively of the regenerated carrier references from a controlled oscillator function 1 gives in the I channel EMI5.2 and in the Q channelEMI6.1 after filtering at 11 and 12 these produce respectively EMI6.2 The modulating data may now be recovered by respective integrate and dump functions 20, 21 in accordance with the following equations for the I channel EMI6.3 and for the Q channel EMI6.4 It is here noted that Cos t 2T andSin rt T are the recovered clock references. The identities set out above are of course related to optimum demodulation in which the recovered carrier references are exact. There may be some phase error 0c in the carrier reference thus the regenerated carrier references may be more accurately shown for the to channels as ri t Cos UCt c and rq t Sin wct c Considering only the I channel after multiplication 3 and filtering 11 EMI6.5 Similarly the Q channel givesEMI7.1 Multiplying these together 14 givesEMI7.2 This is multiplied by the imperfect timing referenceCos t s , the derivation of which is explained hereinafter, 15 and results asEMI7.3 which when yi yq 1 gives a low pass component of 16 Sin 2 c and when yi yq 1 gives a low pass component of 1 Sin 2 c s 16Thus the composite low pass component may be expressed as 1 Sin 2 c yi yq s 16A loop filter 22 removes the data dependant term leaving an error term of tThe timing reference Cos T s is derived from If2 18 Qf2 17 which givesEMI7.4 which simplifies toEMI7.5 This when multiplied 23 y the timing oscillator 16 EMI8.1 A symbol loop filter representation 24 reduces this term toError Value s 1 8 Sin s Cos 2 c Thus this Error Value s may be seen to be interdependent with the carrier phase error value c of 1 16 Sin 2 c Cos s. For small phase errors s and c apToaching zero Error Value c 1 16 Sin 2 c and Error Value t 1 8 Sin as The data signals yi and yq are obtained from the arm signals If and Qf assuming that the generated carrier reference is in lock, therefore c G from the equations EMI8.2 These are premultiplied by the recovered timing reference signals and applied to the integrate and dump circuit 20, 21 as for recovery in the optimum procedure. The algorithm of Figures 2 and 3 as described and shown may be implemented in a microprocessor.However, even at very low frequencies the microprocessor is required to be very fast. In one practical example tested taking 5,200 samples of the input signal per second the microprocessor was required to operate at only twenty eight microseconds per multiplication to achieve real time processing of the incoming signal. It was realised that since the whole of the incoming signal was not required to achieve oftinum data recognition that if some of the functions could be incorporated in a hardware unit so that the signal was pre sampled, then a slower microprocessor could cope with the principal work of carrier, timing and data recovery. Thus the inventor applied a technique known as sub Nyquist synchronous sampling to the algorithm ofFigures 2 and 3 to produce the algorithm of Figures 4 and 2 when assembled as shown in Figure 53. Thus referring to Figures 4 and the timing recovery is identical with the timing recovery of Figures 2 and 3. Carrier error correction is achieved in a similar manner except that a scaled control signal is supplied from the carrier recovery function 22 to a hardware digitally controlled oscillator which is discussed hereinafter. The demodulator equations of the algorithm are as follows EMI9.1 Cos B os Cos Dosk Sin Dos Sin Iosk Cos Ios 2 Cos Iosk 2 Sin Ios 2 Sin Dosk 2 y3k 1 A4y2k A5y2k 1 y2k ylk Sin os ylk ik2 gk2 xlk ikQk x2k x1k Cos Ios x3k x3k 1 A0x2k A1x2m 1 tk 1 tk Tsa A7x3kEMI9.2 k ylk Cos IosCk Ck 1 A6 lk C where K sample number Tsa sample period 2 bit period kvs symbol loop VCO gain Ios symbol shaping frequency 2T kvc carrier loop DCO gain Ax various filter coefficients These equations are not in the most suitable form for implementation in a microprocessor and have therefore been re arranged to give the following equations with some variables re named U Iosk, yyang kvs Tsa y3k, dtl A7x3k x x2k, 9 Y2k wl y1k, w2 The microprocessor implemented equations areU U 2wsTsa 2os dt yyangSin U Sin U Cos U Cos U Sin U 2 Sin U 2 Cos U 2 Cos U 2 yyang yyang kvsEsa A5y w1 i2 g2 y u1 Sin U wl Cos UC C A6 l C yyang yyang kvsTsaA4y dtl dtl A7A1x iq x w2 Cos U dtl dtl A7A0x dt dtl rounded to most significant 8 bits yio yio i Cos U 2 yqo yqo q Sin U 2 The result dt is added to a constant f for fine tuning the digitially controlled oscillator and output thereto. The constants in the above expressions are as follows,EMI11.1 tb Ap SEP SEP T4 T3 SEP SEP symbol SEP loop SEP filter tb SEP SEP Tsa SEP SEP t4 SEP t3 SEP SEP B s SEP SEP 1 SEP SEP 5 SEP SEP SEP S SEP r tb A4 SEP SEP Tsa SEP SEP t4 SEP SEP SEP 4 tb A1 SEP SEP rl SEP SEP carrier SEP loop SEP filter tb SEP tb Ao SEP SEP ist SEP SEP cf2 Y1 SEP tb A7 kvc Tsa2 DCO equation. 2m A6 Tsa 6 a.g.c. filter F s 1 1 s The preceding equations are implemented in a microprocessor appropriately scaled. A comprehensive analysis of wordlengths and variable ranging has revealed the following scaling as appropriate.6.3 x 10 5 U 32 bits 2.5 x 10 10 yyang 0.25 32 bits 1.1 x 10 11 dtl 5.5 x 10 6 32 bits 2.5 x 10 3 x 1.1 3 16 bits 2.5 x 10 3 4 y 4 1 1 3 16 bits w5,w2,c,1 16 bits dt,f 8 bits Sin U, Cos U, Sin U 2, Cos U 2 8 bits i,q 8 bits The above give successful loop operation for carrier loop bandwidths greater than or equal to one herz nominal and symbol loop bandwidths to 0.1 herz. I,oop bandwidths for the symbol and carrier loops are determined using the following procedure for small phase errors, damping factor, t and natural frequency of the carrier and symbol loops are given by, respectively,EMI12.1 carrier loop symbol loopFor both loops, the loop configurations give rise to phase detector gains of Kdc Kds 0.125 Evs c are set at 1000 rads volt. Toop noise bandwidth is calculated usingEMI12.2 The damping factor is set to 0.7 but may be programmed to any desired value. A flow chart showing these operations as carried out by the microprocessor is shown in Figures 8 and 9 when assembled as shown in Figure 7. It is here noted that on exit from the program in Figure 9 the microprocessor will loop back to the commencement of the program of Figure 8 to await a further I input. Referring now to Figure 1 the apparatus for implementing the invention comprises a microprocessor 100 which is programmed to conform with the flow chart ofFigures 8 and 9. The scaled carrier oscillator control signal is returned on an output 101 to digital clock hardware 102 arranged to control a sample and hold circuit 103. An incoming signal on a lead 104 is limited by a hard limiter 105 and filtered by a coarse filter 106 before being passed to the sample and hold circuit 103. Thus at periodic intervals the analogue value of the incoming signal is held under control of the digital clock hardware 102 and an analogue digital convertor 107 is enabled to pass a digital representation of the signal sample to be processed to the microprocessor 100. The microprocessor demodulates the samples as hereinbefore described and outputs the I and Q channel data on leads 108 and 109 respectively. To facilitate monitoring of the microprocessor function an output may be provided to display circuitry 110 which may be an oscilloscope for example. A suitable microprocessor for use as the microprocessor 100 is a 6 NHz Zilog Z 8000 16 bit micro processor which has been found satisfactory for operation using a seven kiloherz intermediate frequency, a digital clock reference of twenty megahertz for the digitally controlled oscillator and a one kiloherz sampling rate. A 20 NHz reference gives a frequency quantization qf in the digitally controlled oscillator of 0.35 herz, carrier loop bandwidths down to one herz may be accommodated whilst the one kiloherz sampling rate is satisfactory for minimum shift keyed data rates of up to 200 baud. At these data rates the 6 MHzZilog Z 8000 is loaded for between 60 and 70 of the time. A 1200 Hz sampling rate is within the capability of the microprocessor and would satisfactorily accommodate rates of up to 300 Baud. Referring now to Figures 1 and 10 the microprocessor 100 may be programmed to demodulate binary and quadrature phase shift keyed signals BPSK QPSK using the algorithm of Figure 10. The algorithm comprises a known carrier tracking loop, a known clock recovery loop and data recovery operation. The sub Nyquist sampling technique as hereinbefore described with reference to figures 4 and 2 is used to provide in phase signal and quadrature phase for QPSK only signal samples. In the QPSK mode the in phase and quadrature phase signals are proportionally combined using two mixers 201, 202 and a summer 203 to provide a signal x2 for application by way of a loop filter 204. The loop filter 204 is identical to the loop filter of the algorithm of Figure 4 hereinbefore described the output signal of which is applied to the digitally con trolled oscillator DCO hardware 102 in the same manner. The in phase signal samples are processed by a digital transition tracking loop which comprises program implemented in phase and mid phase sum anddump elements 205, 206, a limiter 207 which acts as a decision element for the in phase data and a mid phase delay element 208. The in phase and mid phase values are mixed in a mixer 209 to control a program implemented digitally controlled oscillator DCO 210.The output of the digitally controlled oscillator 210 is used to provide a dump indication to the sum anddump element 205, 206 and for QPSK also provides a dump indication to a corresponding sum and dump element 211. The DCO 210 additionally provides timing immediately before dump of the sum from the sum anddump elements 205, 206 and 211 as indicated by the switch elements 213 215. It will be appreciated that the values to be mixed by the multiplier 209 S I must be of correct relative polarity. Accordingly the I bit polarity is corrected by an element 216 in which I i bit old i bit 2 It will be appreciated that x2 applied to the loop filter 204 for QPSK i.e. with switch element 217 in the operated position is given by X2 k m whilst for BPSK with k effectively tied to zero X2 m The output of the algorithm for BPSK is taken from the limiter 207 and for QPSK is taken from the limiter 207 and from a corresponding limiter decision element 212 in the quadrature arm of the algorithm.The outputs represent a non return to zero NRZ pulse train which corresponds to the modulated data of the input signal. The digitisation of the algorithm of figure 10 may be seen clearly from the flow chart of figures 12 to 15. In particular it will be noted that Figure 12 represents the carrier tracking algorithm for bothQPSK and BPSK signals. As previously described with reference to figure 8 and MSK, the I and Q samples may be read sequentially from the analogue to digital converter 107 of Figure 1 . However, for increased timing efficiency of the microprocessor 100 the I andQ samples may be read in simultaneously as a sixteen bit word of two eight bit bytes. Simultaneous reading of the samples is assumed for the flow chart ofFigure 12. In the microprocessor 100 the carrier tracking variables are resolved as follows i q eight bits k m eight bits x2 l x2old sixteen bits dtl thirty two bits and A1, A2, A7 f sixteen bits The clock tracking loop is digitised as shown in figures 13 and 14. As will be appreciated from the description of the algorithm of Figure 10 the clock tracking loop uses the same in phase samples i as are used in the carrier tracking loop. The function of the variables in the clock tracking loop are illustrated in figure 15 to which reference is now also made. Figure 15 shows the effect of perfect synchronisation in which as may be seen the mid phase sum is formed from an equal number of samples on each side of a transition. Thus, for perfect synchronisation, when the m count is incremented to zero the value of m sum is also zero and the loop generates a zero error count which does not alter the timing of the DCO 210 of figure 10 . However if the DTTL is not synchronised, as demonstrated by reference to figure 16, when m count increments to zero, m sum has a positive or negative value which generates an error value for S . This errorvalue when multiplied by I multiplier 209 of figure 10 to account for positive, negative or zero transition is used to adjust the t variable of the DCO 210 which specifies the time to the next expected transition. As will be seen from figure 16 significant adjustments to t may be effected, in the case of the second examplary data transition t being reduced from ten to nine samples only. The i count and m count samples are accordingly adjusted to be one sample interval closer to perfect synchronisation.The rate of correction may be controlled using the gain parameter As as shown in Figure 14. Whilst the flow chart shows only a first order DTTL it will be realised that a second order loop may be used if variable ty is processed using a clock loop filter of the type previously described for MSK. The sub Nyquist sampling MSK BPSK QPSK demodulator hardware of Figure 1 requires modification prior to use in, for example, satellite communications systems. Such a modification is necessary because the local oscillator, satellite frequency and Doppler frequency drifts in combination cause skew signal transmissions through IF filters. Thus, referring to Figure 17 the demodulator may be reconfigured in a long loop to overcome such problems. In this arrangement a control output from the microprocessor 100 is provided to control a carrier frequency VCO 300 prior to band pass filtering of an incoming signal. Thus the signal through band pass filter 301 is of a substantially constant and known frequency and passes through the filters 301 and 305 symmetrically once it is acquired. The control output from the microprocessor 100 is that previously used to control the DCO hardware 102 of Figure 1 , the DCO being fixed tuned to the centre frequency. In this configuration dt is not rounded to eight bits, a full twelve bit word being output for application by way of a digital to analogue convertor 302 to the VCO 300. Loop gain may be adjusted by altering parameter A7 of the flow charts previously maintained. In the long loop configuration the demodulator has sufficient resolution for tuning over a range of plus or minus two kilohertz at the VCO 300. For 2400 bit sec QPSK or 1200 bit sec BPSK the filter values are for the filter 301, ten kilohertz, filter 305, four kilohertz, and for filter 301, three kilohertz. Referring now to Figures 1 and 18, a practical circuit for the DCO hardware 102 is supplied at an input 307 with a reference frequency signal Fr of twenty megahertz. Fr is divided by 16 by a prescaler circuit 308 and then by N by a hard wired divider 309. The divider 309 triggers a software controlled divider 311 which receives the eight bit control word from the microprocessor 100. The divider 311 divides Fr by K N to determine the I sample time which is passed to the sample and hold circuit 103. The I sample time output triggers a third divider 310 which receives Fr from the prescaler 108 which divides by a fixed hardwired ratio to implement a quarter cycle delay to output the Q sample time signal.