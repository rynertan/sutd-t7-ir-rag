# BUFFER MEMORY CONTROL SYSTEM

## Claims
Ein Pufferspeichersteuersystem mit einer zentralen Verarbeitungseinheit und einem Hauptspeicher 2 ,

## Description
The present invention relates to a buffer memory control system in a data processing apparatus. The system according to the present invention is applicable to a data processing system including a main memory and a central processing unit having a buffer memory for storing a copy of a portion of the information stored in the main memory, wherein speed up of the access process to the buffer memory is needed when executing an immediate instruction. As a prior art of the present invention, a buffer memory control system for executing a so called immediate instruction is known see Japanese Unexamined Patent Publication No. 60 123944 . The immediate instruction carries out a fetch operation, a store operation, or a so called fetch and store operation hereinafter referred to as FCH ST . The FCH ST carries out, successively, a read out from and write in to the same address of the main memory. In general, in a data processing system, a buffer memory is provided in a central processing unit, and data obtained by fetching a main memory from the central processing unit is stored in the buffer memory. The buffer memory has a smaller capacity but a shorter access time than the main memory. In the subsequent memory fetching, when the desired data is stored in the buffer memory, memory accessing is carried out to the buffer memory, whereas when the desired data is not stored in the buffer memory, one block of data including the desired data is moved in from the main memory to the buffer memory, and the buffer memory is then accessed to execute an instruction, whereby a seeming improvement is made in the speed of the memory accessing. An example of such a buffer memory control arrangement is disclosed in IBM TDB Vol 25, no. 11B, April 1983. In such a data processing system having a buffer memory, when read out and write in are to be successively effected at the same address of the main memory, for example, to execute an immediate instruction, if the data at the same address is not stored in the buffer memory, one block for example, 64 bytes of data including the data in question is moved in from the main memory to the buffer memory. The one block of data includes Conventionally, the execution of the immediate instruction is effected only after the move in operation of one block is fully completed. However, in view of the before mentioned circumstances, if the above mentioned immediate instruction is executed on the data during the move in operation, the immediate instruction could be executed at an even earlier stage. It is an object of the present invention to provide a buffer memory control system, defined in claim 1, which can shorten the processing time of the immediate instruction by executing a fetch access or a store access after the move in of the heading or the first subblock of, for example, 8 or 16 bytes, and before the completion of the block fetch of 64 bytes. The above object and features of the present invention will be more apparent from the following description of the preferred embodiments with reference to the accompanying drawings, wherein Figure 1 is a block diagram illustrating a buffer memory control system according to an embodiment of the present invention. In the figure, the buffer memory control system includes a central processing unit CPU 1 and a main memory 2. The CPU 1 includes a set associative type buffer memory 3 for storing a copy of a portion of the main memory 2, an instruction unit 4 for providing an instruction of a type such as the FCH ST instruction for reading data from an address in the buffer memory 3 and subsequent writing of the results of a calculation into the same address, an executing unit 5 for executing the above mentioned calculation, and a buffer memory control unit 6. The buffer memory 3 includes a comparison unit 31 for detecting whether or not the data in question is stored in the buffer memory 3. The comparison unit 31 is, actually, a tag portion, or in other words, an address portion, in the buffer memory 3. The buffer memory 3 is both a set associative type and a store through type. If the data in question is not stored in the buffer memory 3, the comparison unit 31 generates a block fetch request signal MM REQ which is transferred to the main memory 2. Then, a block including subblocks of data including the data in question is moved in from the main memory 2 to the buffer memory 3. In this embodiment, the block of data consists of 64 bytes and the subblock consists of 8 bytes. The move in operation is effected successively unit by unit, each unit consisting of one of the subblocks. The buffer memory control unit 6 includes a block fetch control unit 61 and an operation code and address unit 62. The block fetch control unit 61, in response to a data out warning DOW signal from a memory control unit 10 generates a first move in complete FMC signal indicating that the move in of the first subblock from the main memory 2 to the buffer memory 3 is completed. In response to the first move in complete FMC signal, the operation code and address unit 62 accesses the buffer memory so that the executing unit 5 starts to execute a fetch access or a store access from the buffer memory 3. The executing unit 5 includes an operand word register hereinafter referred to as an OWR 51. A move in register hereinafter referred to as a MIR 7, a multiplexer 8, and a buffer data in register 9 hereinafter referred to as a BDIR are connected in series between the memory control unit 10 and the buffer memory 3. A store data register 11 hereinafter referred to as an SDR and a store buffer 12 hereinafter referred to as an STB are connected in series between the memory control unit 10 and the executing unit 5. The pipe line control is well known and, therefore, is not specifically shown. In the buffer memory control system shown in Fig. 1, the transfer of one block n x m bytes of move in data from the main memory 2 to the buffer memory 3 is carried out unit by unit with each unit consisting of Therefore, in a transfer of, for example, an 8 byte unit, when one block of data consisting of 64 bytes is to be transferred, write in to the buffer memory BS 3 is executed a total of eight times. Examples of the format of the instruction IMMEDIATE , fetched from the main memory 2 to the instruction unit 4, will be described with reference to Figs. 2A, 2B, and 2C. An AND INMEDIATE instruction is shown in Fig. 2A. The numerals 0 to 31 indicate bit positions. The AND IMMEDIATE instruction consists of ANDI as the operation code, I 2 as the data, and B 1 and D 1 as the address. B 1 is the number designating the base register B 1 , and D 1 is the displacement with regard to the base address. The logical product of the content of 1 byte in the address defined by the content of the base register B 1 and the value of D 1 and the content of I 2 is stored in the same operand address. An OR IMMEDIATE instruction is shown in Fig. 2B. The OR IMMEDIATE instruction consists of ORI as the operation code, I 2 as the data, and B 1 and D 1 as the address. B 1 is the number designating the base register B 1 , and D 1 is the displacement with regard to the base address. The logical sum of the content of 1 byte in the address defined by the content of the base register B 1 and the value of D 1 and the content I 2 is stored in the operand address. An EOR IMMEDIATE instruction is shown in Fig. 2C. The EOR IMMEDIATE instruction consists of EORI as the operation code, I 2 as the data, and B 1 and D 1 as the address. B 1 is the number designating the base register B 1 , and D 1 is the displacement with regard to the base address. The exclusive logical sum of the content of 1 byte in the address defined by the content of the base register B 1 and the value of D 1 and the content I 2 is stored in the same operand address. In general, in the case of an instruction for carrying out a fetch and store operation to the same address using a format such as shown in Figs. 2A, 2B, and 2C in the buffer memory control system shown in Fig. 1, first the central processing unit CPU 1 is operated to check if the block including this operand address is stored in the buffer memory. When stored, the operand is fetched, the logic operation instructed by the instruction is carried out, and the result of the calculation is stored in the buffer memory 3. Since the buffer memory 3 is a store through type buffer memory, the result is stored in both the buffer memory 3 and the main memory 2. If the block including this operand address is not stored in the buffer memory 3, a read out request for the block including this operand address is made to the main memory 2, and the read out block is registered in the buffer memory 3. If one word is registered by one registration operation in the buffer memory 3, It is common knowledge that control is carried out in such a manner that the sequence of registration operation from the main memory 2 to the buffer memory 3 is started from the word subblock including the required operand address. According to the present invention, if the block including the operand address in question is not stored in the buffer memory 3, calculation is carried out when the registration of the operand data with regard to the beginning word is completed so that the time of waiting until the full block is registered can be reduced. These instructions are fetched from the main memory 2 into the instruction unit 4. The instruction unit 4 analyses these instructions and generates an operation code and an address for executing an FCH ST operation, i.e., for successively executing fetch read out and store write in operations by pipe line processing. If the above mentioned immediate instruction is used when data is to be fetched stored from into the buffer memory 3, the operation is as follows. If the necessary data is not stored in the buffer memory 3, that is, when a Line Missing Detection LMD signal is generated, the move in operations for an 8 byte unit are executed eight times from the main memory 2 through the buffer memory control unit MCU 10 into the buffer memory 3 so that a total 64 bytes block fetch is executed. The specific feature of the embodiment of the present invention can generally be described as that, in the above mentioned move in operation, at the time point when the heading or the first 8 bytes of one block data have been moved in from the main memory 2 through the BDIR 9 into the buffer memory 3, that is, at a first move in complete time point FMC , the access from the executing unit 5 to the buffer memory 3 is started to execute the FCH ST operation. More details of this operation are described with reference to Figs. 3A and 3B, which are time charts of examples of the operation regarding the FCH ST instruction when the fetch and store operand is not stored in the buffer memory 3, according to the embodiment of the present invention. In Figs. 3A and 3B, the sequence of the cycles for the pipeline timing consists of a priority cycle P for accessing the buffer memory 3, a tag access cycle T for reading the address portion of the buffer memory 3, a buffer read cycle B for reading the data portion of the buffer memory 3, a result cycle R of post processing, a write tag cycle W for writing into the address portion of the buffer memory 3, and a store data cycle S for writing into the data portion of the buffer memory 3. The process illustrated in Fig. 3A is carried out as follows. Simultaneously with the writing operation, the calculated result is also sent out from the SDR 11 through the STB 12 to the memory control unit 10, because the buffer memory 3 is a store through type. The operation of fetching the remaining subblocks in the block to be fetched is successively executed by a pipe line processing. In Fig. 3A, the fetch operation is executed during the P, T, B, and R cycles at the timings 6 , 7 , 8 , and 9 and the store operation is executed during the P, W, and S cycles at the timings 9 , 10 , and 11 . Therefore, the fetch and store operations are carried out successively. If the priority P of the store operation for the FCH ST is in conflict with a priority P of the MOVE IN operation, however, the store operation of the FCH ST must wait for one machine cycle τ, as illustrated in Fig. 3B, because the priority of the MOVE IN is higher than the priority of the store operation in the FCH ST. Figure 4 is a block diagram illustrating the buffer memory 3 and the buffer memory control unit 6 of Fig. 1 in more detail. In Fig. 4, the buffer memory 3 includes an address portion 31a and a data portion 32. The address portion 31a has substantially the same function as the comparison unit 31 in Fig. 1. The buffer memory control unit 6 includes a block fetch control unit 61a, an operation code address unit 62a, a wait state control unit 63, a main memory request control unit MM REQ CONT 64 and a priority control unit 65. The block fetch control unit 61a has substantially the same function as the unit 61 in Fig. 1. The operation code address unit 62a has substantially the same function as the unit 62 in Fig. 1 and includes a multiplexer MPX 621, a latching unit LU 622, three ports 623 1 to 623 3, and a multiplexer MPX 624. The process of the FCH ST operation in the circuit shown Fig. 4 is carried out as follows. The reason for the provision of the three ports 623 1, 623 2, and 623 3 is as follows. The latch into the port 623 1 is carried out during the B cycle. The LMD signal is generated during the R cycle. The FCH ST request is held in the port 623 1 until the LMD signal is generated. Therefore, are provided three ports 623 1, 623 2, and 623 3 for respectively latching different requests, i.e., FCH ST, FCH, and ST. Figure 5 is a block diagram illustrating a buffer memory control system according to another embodiment of the present invention. In Fig. 5, a move in of one block is executed by a transfer of The main differences between the embodiments shown in Fig. 1 and Fig. 5 are that, in Fig. 5, there are provided two move in registers MIR EVN 7a and MIR ODD 7b, two multiplexers 8a and 8b, and two buffer data in registers BDIR EVN 9a and BDIR ODD 9b, in place of the single MIR 7, single multiplexer 8, and single BDIR 9 in Fig. 1. The other portions are the same as in Fig. 1 and are denoted by the same reference numerals. The operation of the system shown in Fig. 5 will be described with reference to Fig. 6. At first, the first 8 bytes of the block fetch data are set in the MIR EVN 7a or MIR ODD 7b during the P cycle of the storing pipe line process. Next, the second 8 bytes of the block fetch data are set in the MIR ODD 7b or MIR EVN 7a see Fig. 6 4 , 5 . Once the 16 bytes are arranged in order, they are moved in to the buffer memory 3 so that the before mentioned FMC is established, as in the first embodiment. At this time, a priority P for processing the FCH ST operation to the buffer memory 3 is established, and, in the B cycle, the necessary data, i.e., X bytes 1 X n , is sent out to the executing unit 5. The executed result is set, in the next R cycle, into the OWR 51 in the executing unit 5 is transferred, in the W cycle, to the SDR 11 and in the S cycle, is written through the BDIR EVN 9a or BDIR ODD 9b into the buffer memory 3 see Fig. 6, 6 . Simultaneously, the above mentioned executed result is sent out through the STB 6 to the memory control unit MCV 10. Also, the second and the subsequent block fetches accompanied by the detection of the LMD signal are successively executed. In both of the above mentioned embodiments, the priority P of the storing pipe line process for executing a move in of subsequent block fetch data is higher than the priority P for the FCH ST operation that is, the immediate instruction process . Therefore, if there is any conflict, the FCH ST operation will be delayed by 1 τ as described before. However, since the move in operation is not always effected regularly, it is sufficient to shorten the processing time of the immediate instruction, according to the present invention. Figure 7 is a block diagram illustrating a part of the block fetch control unit 61a shown in Fig. 4 of the first embodiment or in Fig. 5 of the second embodiment. In Fig. 7, the block fetch control unit 61a includes an up counter 611 which can count up to at least eight, latch units 612 1 through 612 x, and latch units 613 1 through 613 y. When the 8 bit counter 611 receives the data out warning DOW signal from the memory control unit 10 Fig. 1 or Fig. 5 , the count value is incremented. Each time the count value is incremented in the first embodiment, or when the count value is even in the second embodiment, the control signal MI for MOVE IN is sent to the buffer memory 3 see Fig. 4, 6 2 . When the count value is one in the first embodiment or two in the second embodiment, the first move in complete FMC signal is generated and transferred to the priority control unit 62 see Fig. 4, 6 3 . When the count value is eight, that is, when the move in of all data of one block is completed, a move in complete MIC signal is generated. In the conventional technique, the FCH ST operation did not start until the MIC signal was generated, so that the time of waiting for the MIC signal was wasted for the FCH ST operation. Conversely, according to the embodiment of the present invention, the FCH ST operation can start immediately after the first move in operation of the first subblock. As described above, in the present invention, the feature resides in that, when a Line Missing signal is detected during the execution of an immediate instruction, a priority P for processing the immediate instruction is established to the buffer memory at a time i.e., the FMC time point when the first block fetch data 8 bytes is set in the MIR 7, or when the first block fetch data 8 byte and the next second block fetch data 8 bytes are set in the MIR EVN 7a and the MIR ODD 7b, respectively, without waiting for completion of the 64 byte block fetch. Accordingly, an effect of shortening the processing time for the immediate instruction is obtained.