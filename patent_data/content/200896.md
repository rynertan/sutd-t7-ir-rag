# DIGITAL FLOW METER CIRCUIT AND METHOD FOR MEASURING FLOW

## Claims
1. Verfahren zum Erzeugen eines Signals, das proportio nal ist zu der Strömungsgeschwindigkeit V eines Fluids in axialer Richtung durch ein Rohr 11 , welches Verfahren enthält

## Description
The invention relates generally a method and apparatus for measuring fluid flow through a pipe or conduit utilizing ultrasonic signals. A basic ultrasonic flow meter is shown and described in Lee, U.S. Patent No. 3,935,735, issued February 3, 1976, and assigned to the assignee of the present inven tion. This meter uses a pair of transducers mounted on opposite sides of a diametrical section of a pipe, with one of the transducers being positioned downstream from the other. This sets up a diagonal ultrasound path from one transducer to the other. Each transducer is both a transmitter and a receiver of an ultrasonic pulse train. In transmission, electrical signals are converted by the transducers to sound waves, while in reception, the transducers convert sound waves to electrical signals. Two pulse trains are transmitted simultaneously at oppo site ends of the ultrasound path and are received a short time later at their opposite destinations. The electrical signals that are used in generating the ultrasonic waves are generated at a relatively higher carrier frequency signal f The ultrasonic pulse train at the carrier frequency f As further explained in the Lee patent, a mathe matical relationship has been developed in which the flow rate is expressed as a function of the elapsed travel times for the two ultrasonic pulse trains, and further as a function of the difference between the travel times in the upstream and downstream directions, respectively. The flow rate V can be expressed in terms of some constant k , the difference between the two travel times T₁₂ T₂₁ and the two travel times T₁₂ and T₂₁ as follows In a pipe with a diameter of one foot, and a medium in which the speed of an ultrasonic wave is 5000 feet second when the full scale fluid flow is 2.5 feet second, the difference between the two travel times T The Lee patent discloses that the difference in the two travel times can be detected by 1 extracting two analog signals f Herzl, U.S. Pat. No. 4,468,971 and Drost, U. S. Pat. No. 4,227,407 disclose analog sample and hold circuits to capture analog signals at the receiving end of ultrasonic transmissions and a comparison of analog signals to detect phase difference in a manner similar to the Lee patent. Another device of the prior art used analog sampling methods to analyze the phase shift of lower frequency signals extracted from ultrasonic transmissions. In this device each of two analog signals was sampled at eight intervals. The signals were stored in banks of switched capacitor circuits. The stored signals were read out and compared to produce a pulse width proportional to phase difference. The circuit did not use a microcomputer or digital sampling methods. International Publication No. WO 86 02722 discloses an ultrasonic flow meter in which the transmission of the two ultrasonic pulse trains is simultaneous. The present invention utilizes successive transmissions originated from the same transmitter, so a method must be developed to capture and hold the data generated at two different times for synchronization during later processing. Potzich et al., Long Wave Acoustic Flowmeter I.S.A. Transactions, volume 22, number 3, Research Triangle Park, NC, USA 1983 , pages 9 15 discloses conversion of analog signals to digital data and storage of the digital data in memories. Potzich et al. discloses a low frequency sonic flow meter which does not use the transmission techniques and frequency mixing techniques of ultrasonic flow meters. Potzich et al. discusses the detection of a phase difference but does not disclose the problem or solution to synchronizing data which is captured at very high speed in an ultrasonic flow meter. Johnson, U.S. Pat. No. 4,162,630, shows the conversion of analog signals to digital signals for reading by a data processor. Johnson also shows a counter for measuring elapsed time intervals proportional to elapsed time intervals T The availability of microprocessors provides an opportunity for greater resolution of phase differences using Fourier mathematical methods. To implement these methods, a method must be devised for digital sampling of the high speed ultrasonic signals and saving the signals for later processing and synchronization. The known art does not suggest how to store digitized phase information for later synchronisation and determination of phase differences. The invention is defined in claims 1 and 6. A particular feature of the invention is generating sequences of multibit groups of digital sampling data in response to two pulse trains and associating the digital sampling data with timing marks in memory to form two groups of time related digital sampling data. The timing marks are used as a reference to synchronize the digital sampling data, and the synchronized data is used to determine a phase difference between the respective ultrasonic pulse trains. This phase difference is then used to determining velocity flow rate. The invention is more particularly embodied in a signal processing circuit for a flow meter. This circuit includes a signal generator for generating two ultrasonic pulse trains that are transmitted across the flow stream from probes at opposing points, and a signal receiver for receiving the two pulse trains. The circuit also includes a first timing subcircuit for generating elapsed time signals that mark the time from transmission to receipt of each ultrasonic signal. Other circuitry is coupled to the signal receiver to generate and store digital sampling data corresponding to each of the two ultrasonic reception signals. A second timing subcircuit is coupled to the signal generator and to the sampling circuitry to gener ate the timing marks that are associated with the sampling data. Lastly, the signal processing circuit includes a digital processing circuit, which may be a microelectronic computer, and this circuit reads the elapsed time signals from the first timing subcircuit and also reads the digital sampling data and associated timing marks from the second timing subcircuit. With this data the digital processing circuit then calculates flow rate and generates a proportional output signal which is used in indicating flow rate on some type of visual display on the meter. The invention will enable one to provide a flow meter which can be used with sensors strapped on the exterior of a pipe. While the invention enhances the flow meter by permitting its use with strap on sensors, the invention can also be used with sensors that penetrate the pipe wall. The invention will further enable one to provide such a flow meter for pipes as small as two inches in diameter. The invention will further enable one to provide a microprocessor based signal processing circuit that can resolve phase differences on the order of 0.01 out of 360 . The invention will further enable one to provide a high speed digital sampling circuit which can store at least one wavelength of a phase shifted signal and store it with timing data for later processing by a micro electronic processor. The invention will further enable one to measure short differences in signal travel times which are present in transmission type flow meters with a circuit that is very sensitive, but is independent of drift in circuit components. The invention will further enable one to detect small differences in signal travel times with a method and a circuit that do not rely on timing stability of signal receiver and detector components. The invention will further enable one to provide a digital circuit for controlling and measuring the times of transmission and reception of the ultrasonic signals transmitted through the pipe and the flow stream. These and other objects and advantages of the inven tion will become apparent from the following description and from the drawings and appendices, which form a part hereof and which are referred to in the description. These disclose a preferred embodiment which is but one example of the invention. In the drawings The invention is incorporated in a signal processing circuit 10 for an ultrasonic flow meter as illustrated in Fig. 1. The flow meter in this example is of the type that can be mounted or strapped on the exterior of a longitudinal section of pipe 11, although the invention can also be employed with sensors that penetrate the pipe wall. The flow meter also includes a pair of transducers, referred to as PROBE 1 and PROBE 2, positioned halfway around the pipe 11 from each other and on opposite sides of a diametrical section of the pipe 11. The probes are therefore spaced apart by the outer diameter D of the pipe 11. PROBE 1 is located upstream and PROBE 2 is located downstream by a distance S measured longitudinally along the pipe 11. A fluid is flowing through the pipe 11 with a velocity V along the longitudinal axis of the pipe 11. Each of the transducers is both a transmitter and a receiver of ultrasonic waves that travel between PROBE 1 and PROBE 2 at a velocity V along a diagonal path of length L. The angle between diameter D and the path L has been desig nated ϑ, and a sonic pulse train traveling from PROBE 1 to PROBE 2 travels at the speed of sound in the par ticular medium, that speed being designated c, plus the component of axial flow velocity taken along the signal path c V sin ϑ . A sonic wave traveling in the opposite direction, from PROBE 2 to PROBE 1, travels at c V sin ϑ . The time of travel can then be expressed as the length of the path L divided by the speed of travel in each respective direction to provide the following two equations The travel times T₁₂ and T₂₁ have been developed with reference to travel through the medium. If the travel times are expanded to include the time from trans mission of an electrical signal to one of the probes to the time of reception of an electrical signal from one of the probes by a signal receiver, certain delay factors are algebraically summed with equations 2 and 3 to arrive at the total travel time. As explained in Lee, U.S. Patent No. 3,935,735, issued February 3, 1976, the average flow velocity in axial direction, V , can be expressed in terms of these travel times, and independent of the velocity c, in the following manner In this equation the delay factors have cancelled in the numerator on the assumption that they are of equal magnitude in either direction of travel. The delay factors would still be present in the denominator, but they will not be considered here, as they are not required for an understanding of the present invention. The difference in travel time is further related to a phase shift in the ultrasonic waveform. The mathe matical expression for an ideal voltage transmission signal V t coupled to one of the probes is as follows Also, the angular velocity of the wave ω is equal to 2π f The above analysis can also be applied to a wave traveling in the opposite direction from PROBE 2 to PROBE 1 except that the change in phase angle will have an opposite sign ΔΦ relative to the phase at zero flow. If the difference is taken between the phase angle Φ₁₂ corresponding to T₁₂ and the phase angle Φ₂₁ corresponding to T₂₁, and a constant is factored out to proportion the phase angle to the travel time, equation 4 can be rewritten as follows To make the detection of phase changes less difficult, it is preferred that these changes be detected with reference to the difference frequency, f The signal processing circuit 10 of Fig. 1 includes a pulse train generator 12 that generates a digital signal at a frequency k f Returning to Fig 1, the output from the generator 12 is sent to a clock input C on a transmitter 14 that is essentially a gated power amplifier. The transmitter 14 generates a generally sinusoidal wave XMIT in Fig. 5 at the frequency of the clock signal for a period in which the transmitter 14 is enabled at its XEN input. This provides a train of pulses at the carrier frequency, and this signal burst is routed to either PROBE 1 or PROBE 2 through an FET field effect transistor switch bank 15 having P1 and P2 outputs connected to PROBE 1 and PROBE 2, respectively. The transmitter 14 is turned on and off by a micro computer 16 which is the primary controlling element in the circuit 10. The microcomputer 16 sends data over a data bus 17 to control registers in a VIA Versatile Interface Adapter . Specific control registers in the VIA are addressed through an address bus 18. When the microcomputer 16 outputs 10 hex to the port A register in the VIA, a signal is coupled from the A4 output on the VIA to a reset R input on a D type flip flop FF 1. The D and S inputs are not shown, but the D input is pulled to a logic high state and the S input is pulled to ground to allow the flip flop FF 1 to be con trolled at its reset input. The logic high signal from the A4 output is changed to a logic low signal by an inverter 50 in the line going to the reset input on the flip flop FF 1. This logic low signal removes the reset and allows the flip flop FF 1 to respond to clock signals. The switching of the flip flop FF 1 is synchronized to the difference frequency signal f After the train of pulses has been transmitted to one of the probes, and has been received by the other, it is routed back through the FET switch bank 15 to a block of circuitry 20 in Fig. 1 that includes a signal receiver, a mixer and a signal detector. The received RCV signal is illustrated in Fig. 5 as a train of pulses similar to the XMIT signal From this RCV signal, the circuitry 20 extracts an analog signal of frequency f As seen in Fig. 1, the memory 22 is enabled at an enable EN input by a signal from a pair of NAND gates 23. The NAND gates 23 in turn are enabled by a signal from the receiver mixer detector circuitry 20 when the pulse train has been transmitted and received through the switch bank 15. To synchronize the storage of converted digital values, the NAND gates are clocked by the same signal of frequency 8f In measuring flow rate, a first pulse train is transmitted from PROBE 1 to PROBE 2 in Fig. 1 and a second analog signal of frequency f The analog signals are sampled and compared to detect a difference in phase angle corresponding to the effect of the fluid flow on the respective travel times. The receiver detector circuit 20 may exhibit timing instability or drift due to the effects of temperature and electrical noise. If this occurs, there could be a delay in the response of the detector that is variable from one reception to the next. To enable the signal processing circuit 10 to operate independent of such conditions a reference is provided. This reference is the clock signal of frequency f Although the sampled analog signal and the reference clock signal in the preferred embodiment are of frequency f Besides determining a phase difference between signals transmitted and received in opposite directions, the actual travel times from transmission to reception, T₁₂ and T₂₁, are also monitored to provide the quantities for the denominator of equation 9 above. The travel times are accumulated in the first instance by a high resolution counter 25 in Fig. 1 which is enabled at a CEN input when the transmission of a signal is confirmed by a flip flop FF 2. This flip flop receives a logic high signaI at its D input at the same time that the reset is removed from flip flop FF 1. A clock signal is provided at the C input on the flip flop FF 2 by a leakage current signal fed from the switch bank 15 to the receiver mixer detector 20 as a transmission signal is transmitted to one of the probes. This signal is detected and coupled to the clock input C to generate a logic low enabling signal at the Q output, which will enable the counter 25. The logic signal from the Q output is shown in Fig. 5. The counter 25 receives clock signals at a frequency of 8 k f The counter 25 is an eight bit binary counter that accumulates 256 counts, and on the last count turns over to zero. When this occurs, a signal is transmitted from an RCO reset counter to zero output to an input B6 in I O Port B of the VIA. Input B6 is connected to a low byte portion of a T2 counter in the VIA as seen in Fig. 3. Thus, each time the high resolution counter 25 turns over to zero, the T2 counter counts one at an effective frequency of 10.24 MHz 256 or 40 kHz. The high resolution counter 25 and the T2 counter act as the low byte and high byte, respectively, of a 16 byte counter that counts pulses at a frequency of 10.24 MHz. At the end of a transmission, the signal to the D input of the flip flop FF 2 switches to a logic low with the reassertion of the reset signal to the flip flop FF 1. When the next RCV signal is detected as represented by the DETECTOR signal n Fig. 5, a clock signal to the flip flop FF 2 resets the Q output to a logic high state to terminate accumulation of time by the counter 25 and the VIA T2 counter. The travel time is thus defined by the switching of the Q output of the flip flop FF 2 as seen in Fig. 5. During this time the FIFO s are enabled FIFO EN to receive sixteen data samples as shown in Fig. 5. The microcomputer 16 allows a certain time for reception to occur and then reads the travel time FIFO READ in Fig. 5 from the VIA counter and the counter 25, using the control bus 24 to signal the counter 25 to couple its data to the data bus 17. The circuit elements of Fig. 1 shall now be examined in more detail as illustrated in Figs. 2 4. Fig. 2 shows the circuit 19 for generating digital timing signals of frequency f The outputs of the OSCILLATOR 1 and OSCILLATOR 2 circuits are coupled to the inputs of a mixer 26, which in this embodiment is an ex OR gate. When the inputs to the mixer 26 are at different logic states, the rising edge of a pulse will be generated at its output. When the inputs become the same again, the falling edge of the pulse will be generated. The pulses will therefore be generated at about twice the frequency of either input, but the pulses will be of varying pulse width. This signal will contain components representing the sum and the difference of the two input signals. By coupling this composite signal through a low pass filter and square wave generator circuit 27, a digital signal of frequency 8 f Still referring to Fig. 2, the signal from the OSCILLATOR 2 circuit is also coupled to a clock input C on another divide by eight counter 29. This produces a digital signal of frequency k 1 f Also seen in Fig. 2 are other details of the receiver detector mixer circuitry 20. The reception signal is routed from the switch bank 15 in Fig. 1 to an RF radio frequency gain amplifier 32. The gain of this amplifier 32 is controlled from the microcomputer 16 through a gain control circuit 33, which will be described in more detail below in relation to Fig. 3. The output of the amplifier is sent to the input of a presence detector 34, which converts a radio frequency signal in a certain frequency range to a DC signal. Such a circuit is also known as a coherent detector. The output of the presence detector 34 is connected to the input of a threshold detector 35 for detecting a reception signal of suitable magnitude for conversion and storage. It is the output from this presence detector that clocks the flip flop FF 2 and enables the NAND gates 23 in Fig. 1. Fig. 3 shows how the microcomputer 16 interfaces to the gain control circuit 33 and to the FET switch bank 15, as well as the details of those two circuits 15 and 33. The microcomputer 16 transmits control information to the VIA, which uses outputs C B1 and CB2 as a serial output port. Serial clock signals are transmitted from output CB1 to a clock input C on a shift register 36. Data signals are transmitted from output CB2 to a DATA input on the shift register 36. When a byte of data has been transferred, a STROBE signal is sent to the shift register 36 from the microcomputer 16 to transfer the data to an output latch included in the shift register circuit 36. The outputs of the shift register are always enabled, so the data will then be coupled to the inputs of a digital to analog converter 37. The output of this circuit 37 is a DC signal, which is coupled through a voltage following amplifier that serves as a signal buffer 38. The output of this buffer 38 becomes the input to the RF gain amplifier 32 in Fig. 2. Also seen in Fig. 3 are the details of the FET switch bank 15. Each of the switches S1 S8 includes a pair of field effect transistors and a protective diode. The switches S1 S8 have control inputs not shown by which they are switched on closed and off open . The signals to these control inputs are the outputs from the NAND gate drivers 39 and voltage following drivers 40. The output from the NAND gate driver 39 labeled S7, for example, controls the switching of switch S7. The micro computer 16 turns individual switches in the switch bank 15 on and off by transmitting control data to the VIA. This data appears at outputs A0 A7 in I O port A of the VIA. Some of the switches S1 S8 operate in tandem. Switch S2 is always switched to the same on or off state as switch S4. Similarly, switches S5 and S6 are operated together. The signal from the transmitter 14 is coupled along one signal path through switches S1 and S2 to output P1, assuming that both of these switches are closed. This signal can also be coupled through switches S3 and S6 to output P1. If it is desired to route the transmission signal to output P2, this can be accomplished by closing switches S1 and S5, or by closing the combination of switches S3 and S4. A signal received at output P1 can be routed to the receiver circuitry by closing switches S2 and S7 or by closing switches S6 and S8. A signal received at output P2 can be routed to the receiver circuitry by closing switches S4 and S8, or by closing switches S5 and S7. Also included in the switch bank 15 are two leakage networks LN1 and LN2. When a signal is transmitted to output P1 by closing switches S1 and S2, the leakage network LN1 provides a path for current to the receiver circuitry 20. This current produces the clock signal to the flip flop FF 2 in Fig. 1 to signal the start of one of the travel times T₁₂. Similarly, the leakage network LN2 will leak current to the receiver to signal the start of travel time T₂₁ when the transmission is routed through switches S3 and S4 to output P2. It should now be apparent how the microcomputer 16 controls the switch bank 15 from the outputs of the VIA and how confirmation signals are provided for each transmission signal by leakage through the switch bank 15 into the receiver. The VIA has a second I O port with terminals B0 B5 and B7 used as outputs and terminal B6 used as an input. Terminal B6 receives signals from the high resolution counter 25 as discussed above. Terminal B7 conveys an output signal from the microcomputer 16 at a signal frequency that is proportional to the flow rate calculated by the microcomputer 16. This signal is coupled through a buffer 41 to an isolation circuit ISO 1 which is also a frequency to voltage converter. The resulting DC voltage signal is fed to a two wire transmitter 42. The output from this transmitter 42 is a DC signal in the range of 4 20 milliamps, which corresponds to the range of flow rate from zero flow to a full scale flow for the flow meter. Other outputs from the VIA are used to send signals to various other portions of the meter display or other type of meter output, and these have been labeled with the term meter in Fig. 3. Still other VIA outputs control LED s 1 3 which are used as status indicators. Lastly, it should be noted that output A4 transmits a signal to the flip flop FF 1 as discussed above. Thus far the microcomputer 16 has been considered a single entity. In this example of the invention, the microcomputer 16 can be further described in terms of a microprocessor 43 seen in Fig. 4 with external memories 44 and 45. Also included in the microcomputer 16 are 1 a reset circuit 46, and 2 a chip select circuit 47 for generating control signals to other hardware in the signal processing circuit 10 of Fig. 1. Besides those circuits making up the microcomputer 16, Fig. 4 also shows a dual binary counter 48 and the details of the FIFO s. The microprocessor 43 in this example is the R6504 CPU available from Rockwell International. This processor generates addresses from outputs A0 A12. Ten of these outputs A0 A9 are connected to corresponding inputs on a scratchpad random access memory RAM 44, and twelve of these outputs A0 A11 are connected to corresponding inputs on a programmable read only memory PROM 45. The RAM 44 stores data that is stored and recalled by the microprocessor 43 as it executes a program of instructions stored in the PROM 45. Because the PROM 45 is encoded with these instructions in a way that is not usually changed without replacing the circuits constituting the PROM 45, the encoded instructions are referred to as firmware . In this example, the PROM 45 is provided by a single memory circuit for storing 4k bytes of program information. The RAM and the PROM are enabled through the chip select circuit 47 which receives and decodes signals from address outputs A9 A12 to generate signals to the CS1 and CS2 enable inputs of the RAM and to the CE enable input on the PROM. A read write R W control signal is coupled to the chip select circuit 47 to control the state of the signal to the WE data direction input on the RAM. Data is read from and written to the RAM over lines D0 D7 of a byte wide data bus 17 connecting corresponding terminals on the RAM and the microprocessor 43. The data bus 17 also connects to terminals D0 D7 on the PROM. The chip select circuit 47 also decodes address signals to read accumulated values from the VIA T2 counter and the transmission time counter 25 and to reset the counter to zero. Another address is decoded to strobe data to the outputs of the shift register 36 in the gain control circuit 33 seen earlier in Fig. 3. And other addresses are decoded to read data or clear the FIFO s 1 3 through control lines going to those circuits as seen in Fig. 4. The FIFO s are enabled by a signal to their EN enable inputs, and this signal is provided from the NAND gates 23, as discussed in the description of Fig. 1. The first and second FIFO s each receive four bits of data from the A to D converter 21, while the third FIFO receives an overflow OV bit and a timing mark TM for each conversion. Bits D0 D3 are handled by FIFO 1, bits D4 D7 are handled by FIFO 2, and the OV and TM bits are handled by FIFO 3. This results in each FIFO having a four bit nibble of data to be read by the microprocessor 43. The two data nibbles are read from FIFO 1 and FIFO 2 in one read operation, and the third nibble is read as part of a second read operation. Fig. 4 also shows several other details related to the microprocessor 43. A clock signal for the micropro cessor 43 is derived from the OSCILLATOR 1 circuit in Fig. 2 and divided by ten through a decade counter 48. This counter 48 receives the signal at the frequency 8k f The reset circuit 46 is one of many known, suitable circuits for providing the reset signal at the R input on the microprocessor 43 when power is first applied. The reset circuit 46 is connected to the power supply V through a pull up resistor 49. The power supply is also connected to a VCC input on the microprocessor 43. For further information on interfacing the R6504 CPU and the R6522 VIA to external circuitry, reference is made to the R6500 Microcomputer System Hardware Manual, which is available from Rockwell International, Anaheim, California. For further information on the other circuitry, reference is made to Appendix A and the commercial literature available from the respective vendors listed therein. The remaining portion of the description concerns the program of instructions that are stored in the PROM 45 and read and executed by the microprocessor 43 to direct the sequencing of the signals that have been discussed above. For background on programming, reference is made to the R6500 Microcomputer System Manual available from Rockwell International. The circuitry which has been described is capable of generating multiple signal transmission sequences for different pairs of probes in a system with more than one pair of probes. In its broadest application, the inven tion requires only one pair of probes and two signal transmission sequences, and therefore the discussion of the program will be directed to such a system. For one pair of probes, a first transmission is sent from the upstream probe PROBE 1 in Fig. 1 to the downstream probe PROBE 2 in Fig. 1 , and a second transmission is sent in the opposite direction from PROBE 1 to PROBE 2 in Fig. 1 . To carry out this operation a data variable referred to as the SEQUENCE word is stored at location 0082 hex in the RAM 44. This byte is binary coded in its two least significant bits as shown in Table 1 to select either the downstream or upstream direction for transmission of the ultrasonic signal. where The program provides instructions to read the above SEQUENCE word and to connect the probes to the alternate signal paths through the switch bank 15. The program provides further instructions to change the settings of the switch bank for transmission and reception, respec tively. The SEQUENCE bits B1 and B0, the selected PROBE, the mode of transmission or reception, and the setting of the switches S1 S8 are correlated in Table 2 below. Also shown are FIFO states in which the FIFO s are receiving either wave data extracted from a signal sent downstream FIFO DN or wave data extracted from a signal sent upstream FIFO UP in the pipe 11. Referring to Fig. 5 and the above Table 2, it will be seen that during XMIT portion of SEQUENCE 0 the switch bank 15 is enabled for transmission through terminal P1 and PROBE 1. During the RCV portion of SEQUENCE 0, the switch bank is enabled for reception through PROBE 2 and terminal P2. In SEQUENCE 1, the switch bank 15 is enabled for transmission through terminal P2 and PROBE 2 and reception through PROBE 1 and terminal P1. Figs. 7 and 8 provide an overview of the organization and sequencing of the program. The program is organized in a MAIN LOOP sequence with a series of calls to subrou tines of instructions that perform the detailed circuit functions. The flow chart in Figs. 7 and 8 parallels the MAIN LOOP except that several of the subroutines are described in relation to more than one program block to emphasize key points in the flow of the program. Referring to Fig. 7, the start of the program is represented by a start block 60. An INITIALIZATION subroutine represented by process block 61 is executed to select functions for the I O ports of the VIA, to set initial values of gain for the gain control circuit 33, and to initialize the counters in the VIA. A pointer is set to a location in memory where data will be received from the FIFO s. Next, as represented by process block 62, the SEQUENCE variable is provided with an initial value of zero to signal a transmission sequence according to the data in the first line of Table 2 above. Block 62 also represents a RSTART re entry point where the program will return under certain conditions to be discussed below. Process block 63 represents the execution of the first operational subroutine, which is XMIT subroutine. First, the gain for the receiver is fetched and sent out to the VIA to control the signal amplification of the RF gain amplifier 32. Then the FIFO s and the travel time counters are reset to zero. The T2 counter in the VIA is initialized to count down from zero during the transmis sion. Control data is then sent to the VIA to enable the switch bank 15 through I O port A according to the first line in Table 2 above. Before sending out the transmission pulse train, a time out counter is set up to count the number of times that the microprocessor 43 can look for a signal leaked back through the receiver to confirm the transmission. This signal is detected by determining that the high resolution counter 25 has started counting and has reached a certain number of counts. Remember that the high resolution counter 25 only starts counting when flip flop FF 2 is set by the confirm signal. The microprocessor 43 then starts the transmitter 14 by loading the appropriate data in the VIA to set the flip flop FF 1 and enable the transmitter 14 at its XEN input. Assuming that the confirm signal has been received and the high resolution counter 25 has started counting, the microprocessor 43 will detect the count and then load the appropriate data in the VIA to reset the flip flop FF 1 and disable the transmitter at its XEN input. Finally, other instructions are executed to load further data into the VIA to open circuit all of the switches in the switch bank 15. Referring to decision block 64, the MAIN LOOP includes several instructions after the return from the XMIT subroutine to provide a delay before the receiver RCVR subroutine can be called. The effect of this is seen in Fig. 5, where the switch bank select signals are off for a time between transmissions XMIT s and receptions RCV s . This allows any delayed signals in the receiver to dissipate before measurement of the reception signal is attempted. This delay is provided by checking the T2 counter in the VIA to see if it has counted down to a certain predetermined constant. Assuming that it has, the delay is complete represented by the YES branch from block 64 in Fig. 7 and the sequence proceeds to the RCVR subroutine represented by process block 65. The first function during the RCVR subroutine is the output of appropriate data to the VIA to set the switches in the switch bank to the states in the second line of Table 2 above. The reception signal is detected by circuitry, notably the flip flop FF 2, so the micropro cessor 43 executes a timing sequence corresponding to the longest expected travel time, and at the end of this sequence, disables the switch bank 15 and resets the flip flop FF 2. After disabling the receiver, the microprocessor 43 executes a TLS590 subroutine represented by blocks 66 68 in Fig. 7. First, as represented by process block 66, the microprocessor 43 reads the travel time, T₁₂ or T₂₁, depending on which sequence, SEQ 0 or SEQ 1, is being executed. This involves reading the accumulated count from the high resolution counter 25 and the count from the VIA T2 counter. Since the T2 counter has been count ing down, its count must be complemented to find the actual number of counts. The combined sixteen bit count is then compared with high and low limits to see whether the travel time was outside the range in which the ultra sonic signal is shifted 360 or less. This test is represented by decision block 67. If the answer is YES, an error bit referred to as a flag is set in an ERROR byte stored in the RAM 44, and this is represented by process block 68. The microprocessor 43 next processes the data stored in the FIFO s as the result of the transmission across the flow stream. Process block 69 in Fig. 7 represents the calling of an FIFOC8 subroutine to sort out the data that will be used to determine a phase difference. Fig. 6 illustrates the type of data that is stored in the FIFO s. Each line of data contains one of the sixteen bytes sampled over two cycles of the f Extra data is collected in the FIFO s, so that the data at the beginning and the data at the end of each set can be discarded, and the most reliable data can be used in the phase determination. At the start of the FIFOC8 subroutine the first four samples are discarded. Then the first byte of data is stored at location 00C0 hex in the RAM 44, and the timing mark and overflow flag are stored in the following location at 00C1 hex . The wave data and timing mark data is interleaved in this fashion so as to occupy sixteen bytes in memory from 00C0 hex to 00CF hex . The FIFO data is also loaded into another area of memory from 0029 hex to 003F hex for processing in a smoothing operation to be explained below. The first table of data is then tested to determine if four samples with timing marks of 1 are stored in sequence. If not, their positions are adjusted to achieve this result. This has the same effect as cutting off a section of the wave in Fig. 6 and rotating it to the other end of the remaining portion of the wave. In this way the eight selected samples can be shifted so that the timing marks for each set of data are aligned, and a common reference can be provided for waves represented by the different sets of data. As shown in the right half of Fig. 6, the two wave samples are ninety degrees apart in phase, and this will be detected by executing the microprocessor program. Besides using the timing marks, the program also incorporates Fourier mathematical methods. The wave data from the FIFO s is analyzed in two ways using Fourier mathematical methods. With these methods, the periodic signal of frequency f The above series may also be expressed in a number of alternative ways, one of which is obtained by recogniz ing that for all n, The coefficient c Referring to process block 70 in Fig. 7, the Fourier coefficients are first calculated to determine amplitude. To obtain the Fourier coefficients, the sine and cosine values for the various harmonics are stored as constants in the PROM 45. An FIFM subroutine is executed to multi ply each of the eight samples from the FIFO s by the sine and cosine values for the fundamental frequency to obtain the a₁ and b₁ coefficient. These are each squared and the square is summed according to equation 12 to obtain the square of the c₁ coefficient. This process is carried out by executing an FIFOC2 subroutine represented by process block 71 in Fig. 7. The microprocessor 43 next calls a GAIN CONTROL subroutine represented by process block 72. This routine compares the sum of the squares of the Fourier coefficients to certain predetermined constants to evaluate the strength of the signal being received through the RF gain amp 32. If the signal is too weak, certain gain control variables will be incremented, and when these are coupled to the gain control circuit, the gain will be increased. If the signal is too strong, the gain control variables are decremented and when these are coupled to the gain control circuit, the gain will be decreased. To prevent constant changing of the gain, a certain tolerance is programmed into the routine, so that minor adjustments will not be put into effect immediately. Next, an ERROR HANDLER subroutine is called to perform the test represented by decision block 73 to determine whether there has been a confirmation signal confirming a transmission. This test is performed by examining the ERROR byte in which the flag bit is set in process block 68, although this is examination of a different bit. If the flag bit for no transmission confirmation is set, the microprocessor 43 returns to the RSTART entry point for the MAIN LOOP. If this bit is not set, the microprocessor 43 executes further instructions represented by decision block 74 to examine the bits that would have been set if a timing error was detected in block 67. Assuming no timing errors are detected, the travel time data will be processed as represented by process block 75 in preparation for calculation of fluid flow later in the program. Process block 75 represents the execution of an SMOT subroutine in which the travel time data for T₁₂ and T₂₁ is transferred to a final location used by a calculation sequence. The travel time data is not merely transferred, but it is also blended with travel time data accumulated from previous transmission sequences according to a smoothing function. The actual smoothing calculation is performed by calling a further subroutine SMOA. Since this smoothing operation is applicable to other key data such as phase angle data and gain data, a short explanation will be made here. If the accumulated value for the travel time T₁₂ were 0.5X, and in the next transmission sequence a value of 1.0X was detected, the accumulated value for T₁₂ would not be changed immediately to 1.0X. Instead, a portion of the change would be added to bring the accumulated value up to 0.75X, for example. On the next cycle through the program the accumulated value might be changed to 0.87X, and the accumulated value would be adjusted in succeeding cycles to approach 1.0X as an asymptope. In this way the smoothing function implements changes in a digital system over a number of cycles. The smoothing function is analagous to an RC circuit as it charges to the applied voltage over a period of time determined by the timing constant for the circuit. After the travel time data has been smoothed into the designated memory locations, a check is made for other types of errors, as represented by decision block 76, these errors being of the type that would affect the integrity of the FIFO data. FIFO data is smoothed with accumulated FIFO data from previous transmissions as represented by process block 77. Next, the microprocessor 43 fetches the SEQUENCE data word to determine the transmission sequence. As represented by decision block 78, it first checks for SEQUENCE 0. If this is the sequence being executed, a FIFM1 routine is called, as represented by process block 79, to calculate the Fourier coefficients for finding the phase angle Φ₁₂ according to equation 12 above. As represented by the next process block 80, the phase angle is actually calculated by calling a QUAD subroutine. The QUAD subroutine performs the inverse tangent calculation by dividing a circle into octants of 45 each and by shifting the angle to one of the quadrants where the range of values for the inverse tangent function are between zero and one. The magnitude of the inverse tangent function is then calculated and stored in memory. Next, as represented by process block 81, a smoothing function is applied to blend the most recent value of Φ₁₂ with a history of values accumulated for that angle. After this operation, the microprocessor 43 increments the SEQUENCE number as represented by process block 82 and loops back to the MAIN LOOP entry point. Returning to decision block 78, if a check of the SEQUENCE word for SEQUENCE 0 results in a negative answer, as represented by the NO branch, further instructions represented by decision block 83 are executed to check the SEQUENCE word for SEQUENCE 1. If SEQUENCE 1 is detected the Fourier coefficients for the angle Φ₂₁ are calculated by executng a FIFM2 subroutine represented by process block 84. The QUAD subroutine is then called to calculate the angle Φ₂₁ as represented by process block 85. This result is then smoothed into another location for Φ₂₁ by calling a SMA1 smoothing subrou tine represented by process block 86. The sequence then proceeds through process block 82 and loops back to the MAIN LOOP entry point as described above. Returning to decision block 83, if neither SEQUENCE 0 nor SEQUENCE 1 are detected, further instructions in the MAIN LOOP are executed to test for the presence of bits for SEQUENCE 2 in the SEQUENCE word, as represented by decision block 87. If this sequence is detected, it implies that SEQUENCE 0 and SEQUENCE 1 have been executed and that data for Φ₁₂ and Φ₂₁ has been accumulated. Therefore, a DELA subroutine represented by process block 88 is called to calculate the difference between the phase angles, and the result is smoothed into a location in memory that will be accessed for the flow rate calcula tion. Next, a DIRECT subroutine represented by process block 89 is executed to determine the direction of flow in the pipe 11 and to set or clear a bit that will later be used in signaling the direction of the flow. Then, as shown by process block 90, the flow rate calculation is performed according to equation 9 . This results in a number from zero to one that is a fraction of the full scale flow. The next time through the MAIN LOOP a program SEQUENCE 3 will be implied by the non detection of numbers 00 , 01 and 02 in executing the instructions repre sented by decision blocks 78, 83 and 87. Then a process block 91 will be executed to call a NORMAL 2 subroutine to determine a frequency for an output signal that is based on the fraction of full scale flow calculated by executing process block 90. The result is stored as data that is accessible by an OUTPUT subroutine that is called next as represented by process block 92. By executing this routine, the microprocessor 43 sets up the VIA to generate an output signal from output B7 at the desired frequency. This frequency is then converted by the ISO 1 circuit in Fig. 3 to a DC signal that is transmitted by the two wire transmitter 42 to the meter display. At the end of SEQUENCE 3, the program proceeds through process block 82 to turn over the sequence number to SEQUENCE 0 and return to MAIN LOOP re entry point. A further note covering the program is that if a timing error is detected in executing decision block 74 in Fig. 7, the sequence number is fetched as represented by process block 93 in Fig. 8, and examined as represented by decision block 94. If the error is detected during SEQUENCE 0, the program will execute SEQUENCE 2 before returning to the MAIN LOOP re entry point. If the timing error is detected during SEQUENCE 1, the program will execute the SEQUENCE 3 blocks 91 and 92 before returning to the MAIN LOOP re entry point. Thus, it can be seen how the microprocessor 43 controls the signal processing circuit 10. The details of this description have been provided to describe a specific example, but those skilled in the art will recognize that these details may be varied while still practicing the basic concepts of the invention. There fore, to distinguish that which has been given by way of example, from that which is basic to the invention, the following claims are made.