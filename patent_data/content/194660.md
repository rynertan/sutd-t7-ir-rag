# ELECTRONIC POSTAGE METER HAVING A MEMORY MAP DECODER AND AN ILLEGAL MEMORY ACCESS WARNING SIGNAL, RESPECTIVELY

## Claims
Elektronische Frankiermaschinenvorrichtung mit

## Description
The invention relates to microcomputer systems and to electronic postage meters having microcomputer control of printing and accounting functions. Devices of this type are generally known, and are discussed for example in US A 3,978,457. This patent discloses a system for a postage meter which includes a keyboard for the manual introduction of data corresponding to the postage to be printed in a Random Access Memory for real time operation. Data is stored in a nonvolatile memory upon power down and read into the Random Access Memory upon power up. US A 4,481,604 describes an electronic postage meter having a redundant memory system in which for each postal printing operation identical data is stored, respectively, in two separate but identical CMOS battery backed nonvolatile memories. In these known devices, there have been found to be times when essential data has not properly been stored in the nonvolatile memory of the meter. It has been found that one reason might be the improper selection of access to a particular device. One means for overcoming such illegal access is described in US A 3,478,342. The system taught by this reference includes means for detecting an illegal code such as an improper command and providing an illegal action pulse as well as a code indicating the type of illegal action. In a further document, GB A 2 101 370, memory interrogation to prevent data transfer to a potentially non existent memory unit is shown. In known electronic postage meters, the microprocessor high order address bits or combination thereof are utilized in a standard decoder for selecting or enabling a particular memory or peripheral device to be accessed in accordance with the microcomputer instructions. While this normally works well, in many cases of improper operation of the microcomputer or failure of one of the address lines of the bus, an improper bit may be decoded and the select logic gate which then enables the wrong device may cause wrong data to be read from memory or in the worst case cause data to be written into an unknown memory or peripheral with no indication of any malfunction. When this happens there is a strong possibility of service personnel s not being able to recover essential information from the nonvolatile memory in the postage meter when the postage meter fails. It is accordingly a first object of the invention to provide a decoded output which provides the proper select signal only when the appropriate addresses are communicated from the microprocessor so as to particularly insure the reading and writing of the appropriate data into the appropriate location. It is another object of the invention to provide a warning signal which indicates that an appropriate address has not been communicated from the microprocessor so as to particularly insure the reading and writing of the appropriate data into the appropriate location. It is further object of the invention to provide in an electronic postage meter a microprocessor interrupt signal from an address decode logic arrangement so as to provide a warning signal that an illegal address access has been attempted. In accordance with one aspect of the invention, there is provided an electronic postage meter device comprising Further, in accordance with another aspect of the invention, there is provided a microcomputer system comprising Other features and objects of the invention will become apparent in conjunction with the description of the drawing wherein Referring now to FIG. 1 which is a block diagram of a meter in which the invention may be incorporated. Such meters are known and are described for instance in US A 3,978,457, specifically incorporated herein by reference. In this referenced patent, the working memory under control of the CPU is a Random Access Memory from which data must be transferred to a nonvolatile memory upon loss or shutdown of power to the meter. US A 4,481,604 discloses an electronic postage meter where the Random Access Memory and the nonvolatile storage memories are combined in battery backed CMOS RAMs which are used both for the real time operation and for long term storage of information in postal registers. European Patent EP A 0 085 385 discloses an improved dual non memory system and is specifically incorporated by reference. It will be appreciated by those skilled in the art that such a device may be combined with the electronic postage meter described in US A 3 978 457 and is also suitable for the invention disclosed herein. The decoder arrangement disclosed herein is conveniently used to provide a method and apparatus for further protecting essential postal data in conjunction with the circuit described in copending European Patent Application EP A 0 194 663 claiming priority from US Patent Application No. 710 802, entitled POSTAGE METER WITH NON VOLATILE MEMEORY SECURITY CIRCUIT. Still referring to Fig. 1, the heart of the general functional arrangement of the system is the CPU which is utilized with specific instructions programmed in the Read Only Memory PM , for the performance of control of the basic meter functions, for the performance of calculations based on any input data and for controlling the flow of data into the various memories. The system may operate in accordance with data applied from an appropriate input means I or from a communications means C such as described for instance in US A 4,301,507 also specifically incorporated herein by reference. The data is fed into the CPU under control of the program in Read Only Memory and at any time during the operation of the system, should the contents of the memory storing the appropriate credit debit balances or other cumulations in accordance with various features of the system be desired to be displayed, appropriate instructions provided by the input means I cause the CPU to access the desired locations in memory which store the information requested. The information may be displayed on an output unit O . As well known, the input and output units may be multiplexed by a suitable multiplex unit MP for transferring data to and from the CPU. FIG. 2 is a block diagram of a specific arrangement of a processor interface circuit in accordance with the invention and comprises an address decoder and associated selection circuitry for the selection and control of various elements of the Electronic Postage Meter. It will be appreciated that the circuit arrangement herein described is preferably embodied in a custom LSI microchip, however, it will be understood that the use of conventional logic components is also contemplated. Turning now to FIG. 2, the overall block diagram of the circuit is shown generally at 10. The demultiplexer 12 in conventional manner demultiplexes the address data bus 14 of a microprocessor not shown in FIG. 2 , suitably an 8085 series microprocessor available from the Intel Corporation or an NSC800 Series microprocessor available from the National Semiconductor Corporation. The bus 14 communicates with the demultiplexer 12 on communication lines 16 through a conventional transceiver circuit arrangement 18. For best results the ADDRESS LATCH ENABLE ALE signal 20 from the microprocessor is anded with the microprocessor read strobe signal 22 to provide the latching signal for latching the address information for the demultiplexer 12. The demultiplexed address information is fed out on lines 24 for use in other parts of the EPM and are internally connected at 26 to the decoder section 28. The high order address signals directly from the microprocessor are communicated on lines 30 to the decoder section 28. An external decode signal, The decoder section 28 receives and decodes a complete input address received at 26 and 30 to provide select outputs for the various parts of the system. The low order demultiplexed address lines A , A1 and A2 are utilized as inputs to control flip flops 32 along with the microprocessor write strobe Outputs from the decoder 28 are provided to NVM output control block 36. This control block 36 in accordance with the invention provides a fail safe NVM device selection. The selection of either NVM is disabled if the NVM write line is shorted to the active state. The NVM write strobe is disabled whenever the other devices are selected or in the event that both NVMs are simultaneously selected. In accordance with the invention, an illegal address control block 38, in conjunction with the decoder 28 detects when the microprocessor read or write strobes attempt to access an illegal, i.e. unused, memory space and, as discussed below, provides a signal output for interrupting the processor. Status and control block 40 monitors the outputs from the control Flip Flop section and provides a control port to generate a decoder reset and to control the selection of an internal or external communication through an Echoplex I O section 42. Preferably the section also includes an 8 bit timer to set the Transmit Baud rate for the serial communications. Dual Timer section 44 provides two programmable 16 bit timers. Preferably the system clock is the clock input to the timers. Suitably each is programmable for continuous or for one shot operation for generating an interrupt when the programmed count is completed. Conveniently an 8 bit counter divider can be selected to prescale the clock input or the ripple output of the first timer may be selected as the clock input to the second timer. Conveniently serial I O block 46 and parallel I O block 48 are utilized for communication with a keyboard and display and for motor control, sensing postal value and miscellaneous control functions. For best results, an Interrupt Status and Control Block 50 is provided along with an interrupt mask control port for enabling selected interrupts to interrupt the systems processor. FIG. 3 shows a schematic of an embodiment of a decoder block for providing a decoded memory map in accordance with the invention. The crossed lines with a circle superposed are used to indicate the preferred conductive path in a customized chip arrangement. It will be appreciated that the illustrated arrangement is extremely convenient in that the decoded memory map as described below may be modified easily with only a few mask changes. The various addresses communicated in known manner from the microprocessor and demultiplexer as described previously are each fed to leads A1 through A15 of the decoder block 28. The address bits on address lines A11 through A15 are supplied to NAND gates 52, 54, 56, 58, and 60 and inverted at inverters 62, 64, 66, 68, and 70 and applied as illustrated to the NAND gates 52, 54, 56, and 58. An external decode signal 72 see also FIG. 2 is applied to NAND gate 60. The output of NAND gate 60 is NOR D with the outputs of gates 52, 54, and 56. The EXTDEC signal is also applied directed to gate 58. It will be noted that when active this signal will disable the decode function. The decoded outputs from the connections illustrated in FIG. 3 for the preferred embodiment are as shown in Table I and in FIG. 4. It will be noted that in accordance with the invention, an active DVOID output is provided from NAND gate 74 when none of the system s blocks are selected. It will also be clear to one skilled in the art that the address bits, when appropriately decoded as in the illustrated circuit by NAND gates 76, 78, 80, 82, 84, and 86 and inverters 88, 90, 92, 94, and 96 provide an active output IO whenever any of the I O functions is selected and an active I O read output whenever any of the internal circuit functional blocks are selected. Address bits A3 and A4 are applied to 2 to 4 demultiplexer 98 and decoded with other low order address bits for providing output signals as defined in Table I for selecting the appropriate blocks. It will be understood that the signal DVOID is not necessarily limited to its previously described function. For instance, in the illustrated embodiment, a signal VINT from the control flip flop block further described below may be used to convert this DVOID signal to another decode output. This signal shown as ECHO VOID in FIG. 3 is available if the circuits internal ECHOPLEX block 42 is utilized. Alternatively it will be seen that if an external echoplex section is utilized, that is, when the signal EXTECHO is active the ECHO VOID output becomes the select signal for the external block and the select signal for the internal echoplex section, ECHO S is disabled. As mentioned previously, the Control Flip Flop section 32, more particularly shown in FIG. 5, generates four control output signals and their complements for controlling the generation of an illegal address interrupt signal to the processor, to provide an independent enable disable for the access to two separate NVM storage devices, to enable and disable meter postage printing and access to nonvolatile storage. As best seen in FIG. 5 the low order address signals A0, A1, and A2 are fed to a 3 to 8 Line Decoder Multiplexer 102 equivalent to a 74HC138 available from RCA to set and reset flip flops 104, 106, 108, and 110. The processor strobe signal The decoder reset signal The outputs from flip flop 104 designated UNLOCK are preferably active to enable postage printing and for NVM access. For best results, the preset value is inactive to prevent printing and NVM access. The signal WR1 EN and WR2 EN are active for write access to respective NVM devices 1 and 2. Again, for best results the preset values are inactive . The output VINT which as previously discussed is fed to the decoder section 28 is active to enable an interrupt generation whenever an illegal memory access is attempted. It will be appreciated that this is preferred since in the inactive state it may be used to reset the generated interrupt signal or to disable the interrupt so that it may be used as a spare decode output. The VINT preset signal is active to enable the interrupt. The illegal address control block 38 is shown more particularly in FIG. 6. This circuit is used to provide an indication of when access to unused memory space is attempted. The Thus, depending upon the status of the signal VINT as discussed previously, the decoded void memory space indication will be latched at the lead edge of either the read or the write strobe of the microprocessor to provide the output INT VOID from the Q terminal of flip flop 108. In accordance with the invention, the INT VOID signal is provided to the system microprocessor as an interrupt signal. Preferably this indication will remain latched until reset by the reset signal from the microprocessor. Conveniently as seen in FIG. 2 the output is inverted at inverter 116 and supplied at 118 at For best results, this Turning now the FIG. 7, the NVM Output Control Block 36 is shown in greater detail. In order to insure secure accounting in the NVM the WRITE access to the two independent NVM devices is independently enabled and disabled under software control. The NVM OUTPUT CONTROL will block the microprocessor write strobe WR unless either of the NVM decoded select signals SEL1 and SEL2 is available and the appropriate write enable signal from the control flip flops are available at NAND gates 118 and 120. The output of these gates are inputs to NAND gate 122 whose output is applied to NAND gate 124. The output of this gate is inverted and supplied to NAND gate 126. The other signals applied to NAND gate 124 are the decoded select signals NVM1, NVM2, ROM, RAM and VOID are taken from the output drivers and applied to NAND gate 124, with NVM 1 and NVM2 being NOR D at NOR gate 128 and inverted before being applied to 124. It will be appreciated that the write strobe WR is blocked if the appropriate memory space is not selected. It will also be appreciated that if both NVMs are selected simultaneously the write strobe will also be blocked. A further protection feature is provided in the event that the NVM write strobe output is shorted active . The address enable strobe at 20 is applied as the clock signal to a D flip flop 130. If the FIG. 8 is a schematic of the status and control block. The block comprises a status port to allow monitoring of the control flip flop outputs. The outputs of the control flip flop block 32 are applied to buffer 136 for output to data bus 138, see also FIG. 2. The system clock input from 140 see FIG. 2 is used in conventional fashion for timing the internal reset output by counting through D flip flops 142, 144, and 146 to provide signal IRST which is the control signal for resetting all of the flip flops in the circuit and is applied along with the System Reset to AND gate 148, see FIG. 2 . The block select signal The Interrupt Controller block 50 is shown in more detail in FIG. 9. The interrupt controller in accordance with the invention provides great flexibility in the servicing of the various interrupt signals to the microprocessor. The signal INT VOID from the illegal address control block 38, signals INT TO and INT TI generated by the time out of timers in timer block 44, signal INT ECHO from the ECHOPLEX block 42 which is active to indicate the start of an echoplex message, signal INT SERIAL from serial I O block 46 which is active when new data is received or when the port is read for sending data, and signal INT MOTOR from PARALLEL I O block 48 which is preferably active when an illegal motor control output has been communicated are each input to the INTERRUPT CONTROLLER block 50. The status of each of these signals may be read out directly from buffer 154 when the Signal Preferably, as shown, there is also included a vectored interrupt for the handling of service requests. As discussed previously, a non masked interrupt results in the generation of an interrupt request signal to the systems microprocessor. For best results, the microprocessor upon receiving this signal will transmit an interrupt acknowledge signal The Echoplex circuits suitable for use in block 42 are discussed in U.S. Patent No. 4,301,507 incorporated by reference herein. Serial I O and parallel I O port circuits are well known and will not be discussed further herein. FIG. 10 and FIG. 11 are timing diagrams showing the interrelationship of signals previously discussed. The designated parameters and preferred timing are shown in TABLE III. It is believed that these diagrams will be readily understood by those skilled in the art so they will not be further described except with regard to the operation of the circuit. The operation of the circuit has been particularly described with respect to each of the functional units. Broadly, however, the circuit 10 in accordance with the invention receives and decodes the periodic address signals communicated from the microprocessor and received at decoder block 28 and control flip flop block 32. The address signals are decoded to provide an active selection signal for each of the various blocks of the circuit 10 and the memory devices of the electronic postage meter depending upon the communication of the appropriate addresses for the particular device. In the event that an illegal address is communicated either because of a microprocessor or software failure or because of a failure in the instant circuit, the As discussed previously, further protection is provided in the event that both nonvolatile memories are selected. As seen in FIG. 7, if both the Protection is also provided during system power up with the use of the unlock control flip flop signal. It is a master control of access to the NVM s and postage printing which will disable these functions until the software operating system is ready to enable them. In order to assure that signal If