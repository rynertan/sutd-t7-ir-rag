# An electronic musical instrument having an internal fault detection feature.

## Abstract
An electronic organ having an internal system for fault detection is disclosed. Information regarding the actuated keys, tab switches, and control switches of the organ is read into a microprocessor 50 which controls tone generators, filters 230, 240 and the like in response thereto. Upon actuation of a unique set of input switches 130 , the microprocessor branches into a diagnostic routine. In the diagnostic routine, all of the input and output circuits are sequentially tested so that any faults can be isolated. A lighted display associated with one set of the switches provides visual output as to the progress of the test sequence. In addition, when a fault is detected, this lighted display provides information regarding the location of the fault. Through use of this system, a test of an electronic organ can be performed rapidly, and the test protocol can ensure that no switches or output circuits are accidentally omitted. In addition, because selection among comparable circuits is accomplished internally by the microprocessor, technician control is permitted over aspects of the organ operation which are normally inaccessible to a musician performing on the organ. The diagnostic sequence automatically resets when the organ is turned off so that even if a performer accidentally entered the diagnostic mode, the organ would readily return to normal operation. The test sequence can be caused to proceed on an automatic or a semi automatic basis at the option of the test technician.

## Claims
CLAIMS 1. An electronic musical instrument comprising manually operable input means including a keyboard output means including electronically switchable audio tone producing means and control means responsive to the input means for controlling the output means, said control means further being responsive to the actuation of certain of the input means to initiate and control a predetermined sequential diagnostic mode of operation whereby the control means will test each component of the input means and each component of the output means. 2. An electronic musical instrument according to claim 1, wherein certain of the components of the input means and output means are tested in more than one combination. 3. An electronic musical instrument according to claim 1 or 2, wherein the output means further comprises a plurality of electronically switch able lights which are operated by the control means in the diagnostic mode so as to indicate the current status of the diagnostic sequence. 4. An electronic musical instrument according to claim 3, wherein the predetermined sequence of the diagnostic mode of operation carried out by the control means is selected so that a fault is manifested other than by the absolute pitch of the tone produced by the tone producing means. 5. An electronic musical instrument according to claim 3 or 4, wherein the plurality of electronically switchable lights is operated by the control means in the diagnostic mode so as to identify the source of a fault when a fault is detected. 6. An electronic musical instrument according to claim 5, wherein the control means carries out the diagnostic mode of operation in an automatic sequence which can be stopped and started by operation of certain of the input means. 7. An electronic musical instrument according to claim 5 or 6, wherein the control means carries out the diagnostic mode of operation in a predetermined sequence which is incremented by manual operation of certain of the input means. 8. An electronic musical instrument according to any preceding claim, wherein the operation of the diagnostic mode is automatically discontinued when power to the instrument is interrupted. 9. An electronic musical instrument according to any preceding claim, wherein the diagnostic mode of operation is initiated by the actuation of a unique combination of the input means, selected so as not to arise in normal operation of the organ. 10. An electronic musical instrument according to any preceding claim, wherein the input means comprises voice selection switches. 11. An electronic musical instrument according to any preceding claim, wherein the input means comprises function selection switches. 12. An electronic musical instrument according V to any preceding claim, wherein the output means comprises tone colour filters. 13. An electronic musical instrument according to any preceding claim, wherein the output means comprises sustain controls. 14. An electronic musical instrument according to any preceding claim, wherein the output means comprises programmable generators.

## Description
AN ELECTRONIC MUSICAL INSTRUMENT HAVINGAN INTERNAL FAULT DETECTION FEATURE The present invention relates to an electronic musical instrument, such as an organ, having an internal fault detection feature. Prior to the advent of a microprocessor controlled organ system, electronic organs did not possess any centralized control. Accordingly, prior art electronic organs do not inherently possess any means for sequencing through a check of each organ component, other than by manual operation of the organ. To the extent that aspects of the organ are not under direct user control, these aspects of organ operation cannot be tested from the keyboard of the organ, since it is necessary to manually over ride the automatic controls. Accordingly, a substantial amount of test equipment would ordinarily be necessary to test the organ. As a result of these factors, it is very difficult to test the operation of a prior art electronic organ in the owner s home.Further, because prior art organs are generally tested manually, the test procedures are very lengthy, and there is a significant potential for skipping or missing one or more components in the test procedures. The prior art shows microprocessor controlled electric appliances wherein a microprocessor supervises a self test operation, using indicator lights on the appliance to provide feedback regarding the functioning of various components. The prior art also shows the use of fault diagnosis programs as a part of an electronic computer system. According to the present invention there is provided an electronic zustcxl instrument comprising manually operable input means including a keyboard output means including electronically switchable audio tone producing means and control means responsive to the input means for controlling the output means, said control meansfurther being responsive to the actuation of certain of the input means to initiate and control a predetermined sequential diagnostic mode of operation whereby the control means will test each component of the input means and each component of the output means. The present invention will now be described by way of example with reference to the accompanying drawings, in which Figures 1A and 1B constitute a block diagram of a microprocessor controlled organ system in accordance with a preferred embodiment of the present invention and Figure 2 is a flow chart for the fault detection system of the organ system. Electronic organs are among the most complex devices purchased by consumers for home use. However, because of their complexity, the identification of operating faults is extremely time consuming and difficult, and has heretofore required specialized equipment. Accordingly, it would be a desirable advance in the art to develop an electronic musical instrument such as an organ wherein the apparatus which controls the organ has the additional ability of cycling the organ through a variety of test procedures in a clearly defined sequence, thereby enabling a service technician or the owner to localize the fault quickly, and without diagnostic equipment. A microprocessor controlled organ system in accordance with the embodiment of the present invention scans all of the keys, tab switches, and other controls such as function and fill in selection switches and reads this data into memory.The microprocessor then uses this information to assign frequencies to programmable generators, and to control the passage of those frequency signals through suitable tone color filters and other modulating circuitry for sustain, reverberation, and other effects. Upon actuation of a unique combination of input keys a combination particularly selected as one which would not be encountered by the instrumentalist in the ordinary course of using the instrument the microprocessor s operating program branches into a diagnostic routine which causes each and every switch and circuit of the organ to he tested in a specified sequence, and in either an automatic or semi automatic mode. The diagnostic routine is specifically designed so that the testing of individual circuits cannot be accidentally bypassed.In addition, because the microprocessor is capable of automatically selecting from among equivalent programmable circuitry such as programmable generators the diagnostic control program has a provision for automatically cycling through all optional circuitry within the organ, even thaugh the selection is not ordinarily under the control of the instrumentalist. The service technician is provided with audible feedback via the loudspeakers, as well as visual feedback via musical function indicator lights. The musical function indicator lights can be used to provide information as to the status of the test routine and the location of faults. In the preferred embodiment, two microprocessors are used. Each of the microprocessors includes a random access memory. A portion of the random access memory is used by one of the microprocessors to store informatlon regarding the identity ot notes to be sounded by the organ. This microprocessor stores a 1 in its memory at the location allocated to a particular note if the key on the keyboard corresponding to that note is actuated, and a O in the memory location corresponding to each key on the keyboard which is not actuated. The status of the various keys of the keyboard as well as the status of tab switches and mode selector switches is ascertained by addressing the location of these keys and switches, and loading this information into designated portions of the memory.This operation is performed under thecontrol of the microprocessors, and at intervals selected so as to eliminate any audible delay in the response of the instrument to a change in the status of a key or switch. Programmable signal generators are then assigned to produce tones corresponding to notes to be sounded and these tones are transmitted to an appropriate output system. As shown in Figure 1A, a microprocessor controlled organ system includes a master clock 40 which clocks a first microprocessor 50 and a second microprocessor 60. First microprocessor 50 includes a strobe 52, two output ports 54 and 55, and two input output ports 56 and 57. Slave microprocessor 60 includes an input output port 62 which is connected to input output port 56 of microprocessor 50, and three output ports 64. Other conventional features of the microprocessors 50 and 60 such as the random access memory are not shown. Strobe 52 of microprocessor 50 is connected to a strobe expander 70 by a line 71. Strobe expander 70 is connected in turn to a latch array 90 via 12 lines 72. An output bus 80 connects the output port 54 of microprocessor 50 to the rest of the organ system via the eight lines which comprise output bus 80 as follows four lines of output bus 80 are connected to strobe expander 70 three lines of output bus 80 are connected to latch array 90 and six lineS of output bus 80 are connected to a decoder 110. Five of the six lines connected to decoder 110 are also connected to strobe expander 70 or latch array 9Q. However, no ambiguity arises from this overlap because, as described below, the strobe expander 70 and latch array 90 are only addressed during operations affecting the output system e.g.gates 140, a sustain device 150, data selectors 180, etc. whereas the decoder 110 is only addressed when the status of the switches in a switch matrix 130 is being read into the memory of microprocessor 50. Decoder 110 is connected to switch matrix 130 by a decoder bus 111 which comprises 32 lines which are addressed sequentially by decoder 110. Each of the 32 lines 111 addresses eight switches of the.switch matrix and the status of the 32 sets of eight switches per set is thereby read into microprocessor 50 via the eight lines of an input output I O bus 131, as a series of 32 8 bit words.In this manner, the microprocessor 50 ascertains the condition of each of the switches in the switch matrix 130. The switch matrix 130 includes a switch for each key of the keyboard s as well as each of the tab switches i.e. voice selection controls and function selection switches e.g. automatic fill in, automatic chording, and sustain . This information is read into the microprocessor 50 for further processing in accordance with the instructions called for by the switches. Slave microprocessor 60 is provided in order to increase the computing power available. Slave microprocessor 60 communicates with microprocessor 50 via data bus 41. Since output ports 64 are not necessary for communication with microprocessor 50, they are available for use in directly controlling output systems, and perform a function analogous to latches 90.Depending on the amount of processing power needed, slave microprocessor 60 might be omitted in some embodiments of the present invention, or additional slave microproces sors might be necessary. As explained in detail in our co pendingEuropean Patent Application No. filed and entitled Electronic Musical InstrumentHaving a Tone Generator system, strobe expander 70 is addressed by four lines of output bus 80 from the output port of microprocessor 50. This address selects one of the twelve strobe output lines 72, so that when strobe expander 70 receives a signal on strobe line 71, that signal will be passed to the selected one of the twelve output lines 72. Thus, the strobe output on line 71 is expanded into a strobe signal on one of the twelve lines 72 in accordance with the addresses on four of the lines of output bus 80. As also described in detail in our above mentioned co pending European patent application, an address supplied to decoder 110 on six lines of output bus 80 causes one of the thirty two lines 111 to be pulsed.Each of the thirty two lines 111 is connected to eight switches of the organ, such as key switches, tab voicing switches, function control switches, and the like. Each of the weight switches in a group is connected through suitable isolation circuitry to input output bus 131 which is in turn connected to the input output port 57 of microprocessor 50. In this manner, as each of the thirty two lines 111 is pulsed, eight of the switches of the organ are interrogated, and their status is fed into microprocessor 50. Thus, by choosing an appropriate address on the six lines of output bus 80, the microprocessor 50 can select any of the thirty two outputs 111 of decoder 110.The selected output interrogates eight switches of the organ, and reads them into the microprocessor 50 via input output bus 131 as an 8 bit word. In this manner, the microprocessor is able to ascertain the status of up to 256 key switches, control switches, and tab voicing switches by interrogating each of the thirty two groups of 8 switches in any sequence desired. While a capacity of 256 switches will be adequate for most applications, this capacity can readily be expanded by making additional lines available for addressing decoder 110, for example from ports 55 or 64. Referring to Figure 1A, a master oscillator 160 and a top octave frequency generator 170 are both known in the art. For example, as shown in vendor Mostek data sheet IC Type MK50240N, the top octave frequency generator 170 processes the signal from master oscillator 160 to produce twelve signals corresponding to the twelve notes of the musical scale, and located at or above the highest octave in which that note can be played on the keyboard. U.S. Patent No. 3,816,635 also teaches a top octave generator structure. The signals produced by the top octave frequency generator 170 are provided to a plurality of data selectors 180 which pass the tone signals to a series of dividers 190 in accordance with control signals provided by microprocessor 50 via latch array 90, and responsive to the played keys of the keyboard and selected control functions. Each of the dividers 190 divides its input frequency by two, thereby making available all the lower octaves of the tones produced by the top octave frequency generator 170 which can be called for by played keys of the keyboard. Accordingly, a data selector and its associated dividers and gates function as a programmable signal generator under the control of microprocessor 50. The structure and operation of the gates 140, sustain device 150, data selector5 180 and dividers 190 are described in detail in our abovementioned co pending European patent application. Referring to Figure 1B, the frequency outputs from gates 140 are provided to headers 220 and the analogue switches for steering to common headers 210 via gate output lines 142. Headers 220 sum all oi the gate outputs in groups corresponding to each footage and provide these combined signals to a series of tone color filters 240. The output of the tone color filters 240 will include signals corresponding to every played note in every available voice. Analog switching 250 will then pass selected ones of these signals to the modulation expression steering control 270 in accordance with the selected tabs of the organ. This selection process is controlled by latch information communicated to analogue switching 250 via latch output 100.These latch outputs reflect the selected tab switches as identified by the microprocessor in accordance with the procedure described below. In certain instances, most notably with respect to flute voices, certain economies can be achieved by using common headers for notes in the same frequency range, even though they are associated with different iootages. In particular, while most tone color filters such as those included in tone color filters 240 can encompass the entire range of a particular voice, the tone color filters associated with the flute stop are limited to a span of less than an octave. Accordingly, it is desirable from an economic standpoint to steer all frequency signals within the effective range of a particular filter to that filter. While this increases the cost of the analog switching necessary to steer the signals, at least in the case of the flute stop this cost is more than offset by the savings in the number of filters required. Accordingly, in response to control signals on latch outputs 100, the analog switches for steering to common headers 210 steer frequency signals from gate outputs 142 to a series of common headers in accordance with their pitch, regardless of footage. With respect to the flute stop, the selection oi notes to be sounded irom among the available footages is accomplished by the analog switches for steering to common headers 210, before the signals are filtered by shared tone color filters 230. The structure of such filters is for example, as shown in our United StatesPatent Application Serial No. 33,097 filed April 25, 1979 for Active Ladder Filter. These filtered signals are then provided to modulation expression steering control 270. Control signals from latches 90 via latch output 100 also direct the operation of a rhythm percussion voice generator 260. Rhythm percussion voice generator 260 is conventional in design, and simply produces percussion effects such as cymbals, snare, etc. in response to a trigger from the microprocessor via latch output 100. These percussion voices are provided to modulation expression steering control 270 which is controlled by signals from latches 90 via latch outputs 100. The manner in which the modulation expression steering control 270 operates is conventional in nature as described for example in U.S. Patent No. 4,031,795 and U.S. Patent No. 3,999,149. The signals thus produced are then supplied to a conventional audio output system 280. The latch outputs 100 are connected to the gate arry 140, the sustain array 150, data selector array 180, divider array 190, analogue switch steering to common headers 210, analogue switching 250, rhythm percussion voice generator 260 and modulation expression steering control 270, which collectively control the transmission of generator signals from the top octave frequency generator 170 to the audio output 280. In a preferred embodiment as described in greater detail in our above mentioned co pending European Patent Application , the microprocessor 50 can control the state of each of 96 latches in latch array 90, each of the 96 latches in turn having eight outputs. In the present embodiment of the subject invention, there are also 32 bits of unused port capacity associated with output ports 55 and 64.Accordingly, microprocessor 50 can control a total of up to 768 latch bits plus 32 output bits, or a total of 800 control bits. These control bits are used to control the production of sound in accordance with the keys and functions selected by the user of the instrument as described below. The latches in latch array 90 stay set until a switch scan detects a change, whereupon the microprocessor 50 addresses the appropriate latches of latch array 90 in order to effect the change called for by the change in the status of the switches of switch matrix 130.It should be noted that since the microprocessor 50 controls the various inputs to the latch array 90 i.e. the address applied to the latches 92, the data input to the latches 92, and which of the lines of the strobe output bus 72 is pulsed , the microprocessor 50 can signal individual gates, in any desired sequence, and as necessary to update gate status, without counting through all 768 outputs of latch array 90. The data on output ports 55 and 64 can be controlled directly, without the need for addressing the latches at all. As noted above, the microprocessor continuously tests the status of the various switches of the organ.If it detects the simultaneous operation of a unique predetermined combination of the input switches of the organ,the microprocessor branches into its diagnostic routine. In one embodiment of the present invention, entry into the diagnostic routine is accomplished via the simultaneous operation of six lighted function switches for more than 2.5 seconds. Entry via these switches was chosen since the functions called ior by these switches are mutually exclusive, at least in part, and therefore they are not likely to be selected by a performer as a musically useful combination. The diagnostic routine then proceeds in sections as described below.The test technician can control the progress of the diagnostic program through the various sections in this embodiment by operation of the minor bar or by touching a minor touch electrode strip , since it is not required to control other aspects of the organ during the test. Any other switch could also be used for this purpose, if desired. The function indicator lights present in this embodiment of the present invention may be used to provide the technician or owner with binary visual feedback as to the progress of the diagnostic program, and as to the location of any detected faults as described below. Thus, the test technician has both aural and visual feedback in carrying out the test routine. As described in our above mentioned copending European patent application, certain aspects of the operation of a microprocessor controlled organ are not accessible to the instrumentalist. In particular, the assignment of programmable generat ors to played notes will ordinarily be carried out automatically in a manner beyond the control of the instrumentalist. Because the diagnostic routine is under the direct control of the microprocessor, each of the programmable generators can be separately tested, even though a test technician playing at the keyboard could not readily control the assignment of the generators. Each time the organ is turned on, the microprocessor is caused to enter the program at a predetermined address as shown in Figure 2 at 302. The memory is initialized to the diagnostics off condition at step 304. All keyers are initialized to the off condition step 306 and the standard generator assignments are made step 308 . In an organ system with seven generators, each generator would be assigned to the seven natural notes in order, as explained in greater detail in our above mentioned co pending European patent application. While these generator assignments are subject to change in the course of normal organ operation, the making of initial assignments reduces processing time.At step 310, the program checks to see whether the organ is in the diagnostic mode. Since step 304 has just initialized the organ to the diagnostics off condition, the program will find that the organ is not in the diagnostic mode and will proceed to the normal program shown schematically as step 312.The normal organ program 312 continually scans the switch matrix 130 for any change in the status of the switches, as described above. After each scan of the switches in a normal musical performance, the normal organ program will conduct a test 314 to see whether the status of the switches indicates that the diagnostic mode is to be entered. If this test proves negative, the program returns to step 310. As explained above, diagnostics is entered by the operation of a unique combination of switches on the organ. When this combination of switches is detected during a scan, test 314 directs the program to step 316 which sets diagnostics on and the diagnostic section number to zero. Step 318 then initializes the various mode conditions of the organ for diagnostics. By setting a binary mode code in the RAM memory which is tested before each entry into the generator assignment program, the generators can operate in three modes as follows a Normal mode which responds to the keys played b Standard mode which leaves the generators unchanged from standard assignment and c Generator test mode which exercises each frequency address of each of the data selectors 180, as explained below . Steps 306 and 308 are repeated to turn all of the keyers off. and implement the standard generator assignment since the actual generator assignments may have changed from their initialized condition . Step 310 now determines that the organ is in the diagnostic mode and step 320 will indicate that the minor bar switch has not been actuated since the last cycle. Step 322 causes the organ to check the switch status.Since the switches were just initialized at step 318, no new switches will be detected and no update will be made. The program will therefore cause the scan routine to continue with step 312. Following each scan of the control switches of the organ, the program will proceed through steps 314, 310, 320, 322 and back to 312. If step 322 detects that one of the keys involved in an active test sequence has been added, it will cause the normal organ program 312 to compute and output the data called for by that test, rather than the actual key played. For example, as indicated above, one test required to be performed is to test generator operation for all possible assignment. In this mode generator test mode step 318 initializes one of the keyers of each of the generators to be turned on by any key of the upper manual. Then the key is released and replayed, the frequency address of the corresponding generator is decremented by step 322, and the keyer is again turned on. After all possible frequencies have been selected, one of the keyers of. the next generator is assigned to be turned on by any key of the upper manual, and the sequence is repeated. The updating of the test condition is done by step 322. All that is required is that the frequency address code be decremented as described above. When the address reaches zero, it is set back to seven, and the generator number is decremented.The keyer data need not be tested since the same data will output the appropriate keyer when assigned by the normal program to a different generator. In a similar manner, when the keyers themselves are being tested, the generator number is decremented by step 322 with the generators left in their standard frequency assignments. When all generators have been exercised the generator number being accessed by the test sequence key has been decremented to zero the first generator is again accessed, and the octave of the keyer data is decremented. As a result, the simplest possible program causes the keyers to sequence through a frequency pattern that can be recognized by a musically unskilled technician. In certain portions of the diagnostic routine, it is necessary to sequence through a large number of gates and keyers. In these stages of diagnostics, if a test sequence key is held down, then the portion of the program which updates the test condition step 322 will automatically advance the diagnostic routine to each successive test at one second intervals, and will cause the program to compute and output the appropriate test data.During the diagnostic procedure, the normal program also causes the address of the test in progress to be output via lighted push button or digital displays ii such features are available on the organ. When it is desired to proceed to the next phase of diagnostics, the minor bar can be actuated and this will be detected by test 320, and step 324 will. cause the diagnostic routine to initialize to the next section. By use of the minor bar to increment from section to section, portions of the diagnostic routine can be bypassed and repeated as desired. When the diagnostic test has been completed, the organ can be returned to normal operation by turning the power off and then back on again. As described above, the normal organ program ordinarily detects switch data which it uses to compute output information for control of the various keyers and generators. In the diagnostic mode, switch information is intercepted and causes the norma,loorgan program to compute test data instead of more conventional output data. Because the diagnostic program operates through the normal organ program, the diagnostics feature can be implemented using.relatively little typically 5 of the program memory. Various steps in the diagnostic routine for a typical organ are described below by way of example. The first step in the diagnostic routine is to check the.operation of each of the input switches.To do this, the diagnostic routine will cause all of the indicator lights to light whenever any key or tab switch is actuated. Simultaneous key and tab actuation will turn all of the indicator lights off. The next step is to check for proper operation of all of. the tab switches. To do this, each generator is assigned to one key. For convenience, the diagnostic routine will simulate a played key on each manual. This key will sound as each tab is operated in sequence. The voice outputs canbe monitored as each tab is operated to confirm proper operation. Similarly, operation of a rhythm pattern tab automatically starts the rhythm pattern on the down beat, without the need for manual operation of other tabs or keys. The indicator lights can also be used to provide feedback in this mode. Finally, the programmable generators and gates must be tested. In this phase of the diagnostic routine, all oi the programmable generators are sequenced through all possible address combinations to the data selectors as described above. In a similar manner, all of the sustain keyers are sequenced with both sustain and damped envelopes, all of the output switching paths controlled by the tab switches are sequenced, and all of the rhythm output lines are sequenced. In this manner, the diagnostic routine can automatically check each and every path through every component of the organ.Because of the large number of possible combinations, and the complexity of the priorities pursuant to which generators and keyers are assigned in the normal organ mode, it would be extremely difficult to sequence through all possible combinations without the help of the diagnostic system. As the diagnostic system sequences through these various components, fault detection is accomplished by listening for departures from the prevailing tone pattern. The absence of a tone or some other depature from a regular pattern such as an arpeggio can readily be detected even by a technician without musical skill. Furthermore, the indicator lights provide a means of communication between the microprocessor and the technician.These indicator lights will ordinarily be caused to indicate the section oi the diagnostic routine presently under way. However, when the diagnostic routine is interrupted, these indicator lights can be used to output an address which can enable the service technician to identify in the service manual the location of the fault. While certain preferred embodiments of the present invention have been illustrated and described, a number of modifications and variations are possible. In particular, it should be clear that the present invention is not limited to microprocessor controlled organ systems, but is applicable to any organ system wherein programmable signal generators are used. The particular sequence in which the diagnostic routine is carried out, and the input switches used to initiate and control it, are obviously a matter of choice. Further, it can readily be seen that the present invention can function regardless of the word size of the digital logic device which is used. 1 e