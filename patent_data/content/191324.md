# Offline pin cryptographic validation.

## Abstract
A method of offline personal identification in and to a multiterminal data processing system, the method using an authentication tree with a one way authentication tree function, a stored global secret key, a stored global verification value of reference, a personal identification number entered directly by the potential user and a personal key and an index position number entered via a card previously issued to the potential user, the index position number representing the tree path for the user to whom the card was issued, by calculating an authentication parameter as a function of the personal key and the personal identification number mapping the parameter to a verification value using the index position number in the one way function to the root of the tree comparing the verification value obtained by the mapping with the stored global verification value of reference and enabling the system in respect of transaction execution if the comparison meets predetermined criteria.

## Claims
1. A method of offline personal identification in and to a multiterminal data processing system, the method using an authentication tree with a one way authentication tree function, a stored global secret key, a stored global verification value of reference, a personal identification number entered directly by the potential user and a personal key and an index position number entered via a card previously issued to the potential user, the index position number representing the tree path for the user to whom the card was issued, characterised in that

## Description
This invention is directed to a method of offline personal authentication involving a secret user personal identification number PIN , a secret key and other non secret data stored on a customer memory card, and a non secret validation value stored in each terminal connected in a network. Typically, the terminals are connected to a bank which issues the memory card and the terminals are automated teller machines ATM or point of sale POS terminals. By memory card , what is meant is a card which stores more binary data than currently used magnetic strips cards but is distinguished from so called smart cards in that it does not incorporate a microprocessor on the card. By offline is meant, the authentication is not part of the transaction being authenticated. It is usually a separate preliminary operation. The problem solved by the subject invention is that of authenticating a user of a memory card for electronic funds transfer EFT systems or point of sale POS terminals. The subject invention is based on a technique of tree authentication first suggested by Ralph Merkle. See for example, the following publications Ralph C Merkle, Secrecy, Authentication and Public Key Systems UMI Research Press, Ann Arbor, Michigan 1982. Ralph C Merkle, Secrecy, Authentication and Public Key Systems Technical Report No 1979 1, Information Systems Laboratory, Stanford University, June 1979. Ralph C Merkle, Protocols for Public Key Cryptosystems Technical Report, BNR, Palo Alto, CA, January 1980. Ralph C Merkle, Protocols for Public Key Cryptosystems , Proceedings of the 1980 Symposium on Security and Privacy, 122 134 April 14 16, 1980 . US Patent No 4,300,569 to Ralph C Merkle for Method of Providing Digital Signatures discloses a method of providing a digital signature for purposes of authentication of a message. This method utilises an authentication tree function or a one way function of a secret number. More specifically, the method according to Merkle provides a digital signature of the type which generates a secret number x The Merkle method is specifically intended to be an improvement over a public key cryptosystem proposed by Diffie et al in New Directions in Cryptography , IEEE Transactions on Information Theory, Volume IT 22, Number 6, November 1976, pages 644 to 654, as a means to implement a digital signature and authenticate the true content of a message. In the Diffie et al scheme, to sign a message m whose size is s bits, it is necessary to compute F x A major problem of the Diffie et al method addressed by Merkle was that it was only practical between a single pair of users. Accordingly, Merkle s approach provided a signature system of more general application and which rested on the security of a conventional cryptographic function. Moreover, Merkle s authentication tree required less storage than the Diffie et al method. Merkle showed that n values of m bits each could be authenticated on the basis of only m x log ₂ n bits of non secret information, where x denotes multiplication. The one way function that Merkle envisioned called for a value of m 1ØØ, although that is not significant in terms of the raw algorithm. The present invention adapts Merkle s idea of tree authentication to the area of offline EFT POS banking. It is therefor an object of the present invention to provide an improved offline PIN authentication technique which is particularly adapted for use in EFT POS terminals. According to the invention, there is provided a method of offline personal identification in and to a multi terminal data processing system, the method using an authentication tree with a one way authentication tree function, a stored global secret key, a stored global verification value of reference, a personal identification number entered directly by the potential user and a personal key and an index position number entered via a card previously issued to the potential user, the index position number representing the tree path for the user to whom the card was issued, by calculating an authentication parameter as a function of the personal key and the personal identification number mapping the parameter to a verification value using the index position number in the one way function to the root of the tree comparing the verification value obtained by the mapping with the stored global verification value of reference and enabling the system in respect of transaction execution if the comparison meets predetermined criteria. As described, an embodiment comprises a method of offline personal authentication in a multi terminal system using an improved authenti cation tree function comprising a one way function. A person to be authenticated enters his or her PIN and the memory card in a terminal in the multi terminal system. The information read from the memory card and the PIN are used to calculate an authentication parameter. The calculated authentication parameter is then mapped to a verification value or root of the authentication tree using the one way function. The verification value obtained by mapping the calculated authentication parameter is then compared with a global verification value stored at the terminal. In the following description of an embodiment of the present invention, a secure method of tree authentication is realised with a value of m 56 with the data encryption standard DES , i.e by making the work factor to break the system equivalent to that of DES key exhaustion. More specifically, if Y₁, Y₂, . . ., Y There are ways around this problem. If a bank, for example, is willing to assign a new ID to a customer in cases when his or her PIN and bank card has been compromised, then the original list of n values to be authenticated could include 1Ø or 2Ø percent extra IDs and associated values of Y to be authenticated. In that case, when a card and PIN are compromised, the ID is invalidated and a new ID is assigned to the customer and a new PIN and card are issued using one of the precalculated values already available. The old ID is then stored in a hot list at each terminal, and in the course of authenticating a user at a terminal, this hot list is checked to make sure that the ID being used is not invalid. On the other hand, if the bank cannot assign a new ID to a customer, i.e. the ID remains fixed for the life of that customer, then there can be provided two or more sets of n values and two or more global verification values are stored in the terminal. A user would be assigned a new PIN and a new card to work off the second verification value only if the PIN and card for the first verification value have been compromised. In turn, the user could get a PIN and card to work off a third verification value if the PIN and card for the first two verification values have been compromised. Again, a hot list is checked to make sure that the PIN being used and a calculated authentication parameter are not invalid. Yet another possibility is to have only two sets of values, one primary and one secondary. Since there are apt to be very few customers that would be issued more than two cards, these cases could be handled on an exception basis with an authentication table at each EFT POS terminal. The table, which might contain a few hundred entries, would consist of the user s ID and his authentication parameter, the latter of which would be calculated from the user s PIN, personal key and non secret data stored on the card, and the global secret key in the terminal. The method according to the invention also requires a large amount of storage on the card to store non secret data required by the authentication algorithm. Roughly, if there are 2 The present invention will be described further by way of example with reference to the aforesaid preferred embodiment of the invention as illustrated in the accompanying drawings, in which Consider first the question of PIN secrecy. Let the encrypted PIN denoted EPIN to be calculated as in Equation 1. EPIN E where PIN is the entered PIN, ID is the user identifier, and KGb1 is a global secret key stored in each EFT POS terminal. Let the authentication parameter AP be calculated as in Equation 2. AP Right56 E where KP is the user s personal key stored on the card, the symbol represents an Exclusive OR operation, and Right56 is a function that extracts the rightmost 56 bits in the binary variable denoted by the argument of the function. Equation 2 uses EPIN instead of PIN so that the PIN cannot be derived via trial and error at electronic speeds from a lost or stolen card using the public verification value in the EFT POS terminal. From Equation 2, it is apparent that a new PIN can be issued merely by calculating a new EPIN using Equation 1, calculating a new KP via the Equation KP The method of tree authentication makes use of a binary tree. In a tree with 2 If the left branch is denoted by Ø and the right branch by 1 , then the tree looks like this The path followed in the tree can be represented as a string of 1 s and Ø s . For example, starting from the root, if we go up to a left branch, then to a right branch, and then to a right branch again, the path is given by the number Ø11. If, on the other hand, we go up to a right branch, and then to a right branch again, and then up to a left branch, the path is given by the number 11Ø. Thus, the numbers ØØØ, ØØ1, . . ., 11 describe the eight paths in this binary tree. It should be apparent that these path numbers also represent the index positions, in binary numbers, of the values at the highest level of the tree. The index position always starts from level zero. Now, it is assumed that the problem to be resolved is to calculate a single non secret verification value V from a set of n predefined authentication parameters PA where Ci is a 64 bit variable computed using Equation 4 given hereinafter. At the first iteration, Equation 3 is used to map AP In the example where n 2 In a simple example where n 3, only three tables would be required. The values AP Each customer is issued a PIN and a bank card on which is recorded a user identifier ID, a unique secret personal key KP, and other information including information that allows a verification value V to be calculated from that customer s authentication parameter AP. The customer s AP value is a function of PIN, KP, ID, and KGb1 as described above, and is calculated via Equations 1 and 2. In the example given in Figure 2 where n 3, the other information stored on the bank card necessary to allow a verification value V to be calculated would consist of a 56 bit value selected from each of the three tables, i.e. Table 1, Table 2 and Table 3, and a 3 bit index position of the customer s AP value in Table 3. The rule for determining which 56 bit values must be selected from Tables 1, 2 and 3 for storage on the bank card depends on the index position of AP in Table 3. If, for example, AP₂ is the authentication parameter to be authenticated, then the 3 bit index position equals Ø1Ø in binary, and the values AP₃, AP Referring again to Figure 3, the calculation of the verification value V from AP, Y₃, Y₂, Y₁, and the index position number Ø1Ø in the example is as follows. This is the calculation performed in the EFT POS terminal to authenticate a cardholder. The information on the card is, of course, first read into the EFT POS terminal. If the rightmost bit of the index position is Ø, then Y The value C in Equation 3 is derived from the index position number stored on the bank card using the following algorithm. Let Q be a 64 bit constant and KA and KB two constant, non secret cryptographic keys. Q, KA and KB are stored in each EFT POS terminal and are universal constants whose values are established by the card issuer. If X₁, X₂, X₃, . . ., For example, if the index position number is 1Ø11Ø Ø11Ø1 1ØØØ1 11Ø1Ø, then the following 2Ø values of C are calculated and used with Equation 3 to calculated V Twenty encryptions are required to calculate the 2Ø values of C for a particular 2Ø bit index position number. C For the authentication step at the EFT POS terminal, assume that the information on the bank card is as follows The difference between secret and non secret with regard to card data refers to how that data is treated when it resides somewhere off the card. By definition, the card must be protected if any data stored on the card is defined as secret. Other non secret data on the card receives the same degree of protection as the secret data. It may be desirable to store a number of verification values and a positive file of PA values in each EFT POS terminal and to authenticate a card holder using one of these verification values which is selected on the basis of a verification selection number stored on the cardholder s card or to authenticated the card holder on the basis of a positive file of AP values. To account for the possibility that some customers will lose their cards or a compromise of either their card or PIN may occur, which will require a new card with a new AP value to be reissued to the card holder, it may be desirable to authenticate an AP value associated with a reissued card on the basis of a different verification value V. Each EFT POS terminal therefore stores a value T, which is interpreted as follows. If the verification selection number VS is less than or equal to T, then the value of Vs is used by the terminal to select the verification value V to be used to authenticate the card holder s AP value. Assume that the EFT POS terminal stores the following It should be noted that there may be multiple verification values depending on the particular implementation. The steps involved in the authentication process are illustrated in Figure 4. First, the card holder enters his or her PIN into the EFT POS terminal. The card holder also submits his or her bank card to the EFT POS terminal as depicted in block 1. Then, in block 2, the terminal reads the quantities stored on the card. Before proceeding with any calculations, a hot list is checked in block 3 to determine if the ID read from the card is valid. In decision block 4, a determination is made as to whether the Id is valid, and if it is not, then the reject indicator is set in block 5. An ID is invalid if a value equal to the value of the ID is found in the hot list . Otherwise, the process continues to block 6. At this point, the EPIN is calculated from the Id, PIN and secret KGb1 key using Equation 1. In addition AP is calculated from EPIN, KP and ID using Equation 2. A hot list , which may be the same hot list mentioned above, is also checked to determine if the PA is invalid. The AP is invalid if a value equal to the value of AP is found in the hot list . If the AP is invalid, then the reject indicator is set in block 5. Otherwise, the process continues to decision block 8 where a determination is made as to whether the verification selection number VS is greater than the value of T stored in the EFT POS terminal. If it is, then the card holder is authenticated on the basis of a positive file in block 9 instead of on the basis of a verification value V. Such a file can be implemented by storing in the positive file the values of ID and AP for each such user to be authenticated by the positive file. In decision block 1Ø, a determination is made as to whether a positive authentication is made from the file, and if not, then a reject indicator is set in block 5. More particularly, the card holder s ID is first used to access and obtain a corresponding AP value stored in the positive file, and the card holder is then authenticated by comparing this AP of reference value for equality with the AP value calculated om block 6. Returning to block 8, if the verification selection number is less than or equal to T, then the constants C₁, C₂, . . ., C Right56 Y The foregoing calculations are made in block 12. The verification selection number is decoded at block 13 to select a particular one of the T global reference values stored at the terminal. Then in decision block 14 a determination is made as to whether the calculated value of V is equal to the particular selected global reference value stored in the terminal. If it is not, then the reject indicator is set in block 5. Otherwise, accept indicator is set in block 11. Returning briefly to decision block 13, by way of example, let T 2. Then if the verification selection number is 1, a first global reference value is used in making the determination to authenticate the user. However, if the verification selection number is 2, then a second global reference value is used. As already described with reference to decision block 8, if the verification selection number is greater than 2, the user is authenticated on the basis of a positive file in block 9. Obviously, the numbers chosen here are governed by practical considerations, and those skilled in the art will recognise that these are open to modification. Summarising, the described method has the following security properties First, compromising a card does not compromise the PIN. Second, compromising the global secret key does not compromise the PIN nor does it allow someone to forge cards and defraud the system. The process of personal authentication is based on a non secret global value stored in each EFT POS terminal. Added PIN protection is achieved through the use of the global secret key also stored in each EFT POS terminal. Compromising this key does not by itself compromise PINs. The justification for employing a global secret key is that with short PINs, there is no way to maintain PIN secrecy if a user s card is compromised and the EFT POS terminal stores only non secret quantities. Although a global secret key has a decided disadvantage, it is better to employ such a key when there is no other alternative to strengthen PIN secrecy, especially when it can be anticipated that many user cards will be lost and thus fall into the hands of potential adversaries. As long as the integrity of the global non secret verification value in the EFT POS terminal is maintained, there is no global attach against the system. Even if the integrity of a terminal is compromised, then only that one terminal can be attacked. Since the global secret key does not lead to a global attack against the system, there is less motivation for an opponent to go after it. As described a hot list is required with the procedure according to the invention. THis is no different than what would be required with a public key solution or with a DES solution involving only a global secret key for user authentication. The hot list is needed because the bank has to have a way to invalidate an account. For example, an opponent could open an account under a phony name and then proceed to duplicate his card and sell the cards and PINs for profit. A user s PIN can be changed, but this involves reissuing the customer s bank card. Basically, when the PIN is changed, compensating changes must be made on the bank card which involves recalculation of an offset or certain non secret parameters on the card. If a user s card and PIN have been compromised, then a new card and PIN must be issued. In this case, an entry on the hot list must be made to effectively invalidate the authentication information stored on that card and the user s PIN. This does not necessarily mean that the ID is invalidated. The method is such that a customer s assigned ID can remain the same even if a new card and PIN are issued, although it is more efficient if a new ID is issued. While the invention has been described in terms of a preferred embodiment in the environment of a banking multi terminal network, those skilled in the art will recognise that the principles of the invention can be practiced in other environments where it is desired to provide for the offline personal authentication of users of a system. For example, the invention could be used in a security system that would allow access to secure areas only to users of the system who are properly authenticated at a terminal. The important feature of the invention is the use of an authentication tree with an authentication tree function comprising a one way function.