# Improvements in cryptographic communication.

## Abstract
A method for authenticating nodes users and in protecting data flow between nodes. This is facilitated by creating a dialogue involving authenticated encryption among the nodes. During each session, a key for use in cryptographic conversion is constructed among the node participants in order to permit symmetric authentication. The key is unique to the session. A different key is generated for each and every session. The building of the session key involves sharing of a minimal amount of information among the participants in the form of combining both a random number and authentication indicia.

## Claims
1. A method for establishing a session key for use for communication between remote locations and and for authenticating the node user identities, said key being valid only for the duration of a single cryptographic session, each node of the pair having a local cryptographic facility including a pre established cross domain key and an attribute associated with the other node user identity, comprising the steps at each node of

## Description
This invention relates to improvements in cryptographic communication and in particular to a method for establishing session keys that can be used for duplex transmissions between remote locations and for authentication of users or terminals at the remote locations. There are two general problems to be solved in providing secure communication between remote locations, the first is to defeat the eavesdropper who can obtain access to encoded messages and by a process of deduction establish the codes being used and thus the content of the messages, the second is for each location or node to know that it is communicating with a genuine user and not an imposter. In the prior art, several references illustrate protocols for forming composite keys between communicating nodes, and show authentication as a process independent of the establishment of session keys. These references include Ehrsam et al, US A 4,227,253, Cryptographic Communication Security for Multiple Domain Networks , issued October 7, 1980 Matyas etal, US A 4,218,738, Method for Authenticating the Identity of a User of an Information System , issued August 19, 1980 and Meyer and Matyas, Cryptography New Dimension in Computer Data Security , John Wiley Sons, pp. 293 299, 343 347, and 679 683, 1982. One method for penetrating even a cryptographically secure system is to record the cryptographic traffic used to access a target node and subsequently inject the playback into a path to said target node. One defense is to secure the change of the encrypting decrypting keys from session to session. Of course, such measures would not foil an unauthorized source in possession of the keys from accessing the target node. Thus, authentication may be considered to be a process which proves that someone or something is valid or genuine. Among the methods described in the book Cryptography by Meyer and Matyas is the use of a session key formed as a function of information independently furnished by each of the participating nodes. For example, if a pair of nodes exchanged encrypted random numbers and combined the received number with its locally generated number, they both could compute the same session key. Such a composite key would not permit key reconstruction by wiretap and playback of an encrypted random number in the designated node at a later time. The Ehrsam patent describes and claims one form of session key protocol in which an intermediate encryption mechanism cross domain keys is used for exchanging session key information between nodes on one hand and protecting the identity of the node master keys on the other. The Matyas patent involves a node sending a pattern to a terminal requiring the terminal to modify the pattern and remit its modification back to the host to permit a comparison match. It is an object of this invention to devise a method for establishing a common session key among nodes and users to a cryptographic communications session. It is a related object that such method concurrently authenticate the session participants such that the matching session keys will be generated only if all of the participants are authenticated. It is yet another object that the method should cover communications among nodes in the conference calling context. That is, the symmetry or commutivity of the cryptographic session key is not to be affected by the directionality of the conference calling net. The foregoing objects are satisfied by a method for establishing a key commutatively between a pair of cryptographically communicating nodes and for authenticating the node user identities. The key is valid only for the duration of a single cryptographic session. In this regard, each node possesses a local cryptographic facility including a pre established cross domain key, a node user identity, and indicia as to the identity of the other node or nodes. The method steps at each node comprise a generating a random number and encrypting said random number under the cross domain key, copying said encrypted number to the other node, and decrypting under the cross domain key any received encrypted random number from said other node b forming a parameter by combining the attributes derived or associated with the identities of both nodes users c forming an interim key from the composite of the local and received random numbers and d encrypting the parameter with the interim key to produce the session key. It should be observed that in steps c and d , the session key generation is combined with that of authentication. The invention reduces vulnerability to both playback and password attack. Playback attacks are prevented by the fact that a new session key is established for each session and the session key depends upon secret random numbers supplied by each node for each separate session. Password vulnerability is reduced by ensuring that passwords are combined into a complex function involving secret time variant random numbers, thus eliminating the possibility that password values could be deduced by tapping communication lines and accumulating encrypted values communicated from one node to another no encrypted passwords are transmitted among the nodes. User authentication is implicit and not explicit. That is, passwords are not exchanged and compared with similar password reference values stored in a data base as is the usual method of password authentication. The method of this invention advances the art provided by the aforementioned Ehrsam patent. Whereas Ehrsam describes a communication security system providing for the establishment of a session key and the concept of cross domain keys, he does not teach symmetric key formation as a function of random information generated at each node combined with the local node user identity or derivative thereof. Indeed, Ehrsam typifies the prior art by requiring asymmetrical relations in order to establish session keys. An example of asymmetrical relations would be where one node serves as a master with a second node serving as a slave. In such a system, the session key would be generated at the master node and sent to the slave node. Lastly, note that the aforementioned Meyer and Matyas references do not teach combining authentication with session key communications. In order that the invention may be fully understood a preferred embodiment thereof will now be described with reference to the accompanying drawings in which It should be appreciated that, where a secure data path may be desired between two nodes, only nonsecure interconnecting lines such as a public telephone network may be available. Although the nodes may be geographically dispersed, each may comprise a cluster of stored program control data processing and communication facilities. Embedded in each node is a security module. It is placed in the data path in each node at the point where the nodes interface to the nonsecure interconnecting paths. The security module encrypts and decrypts data such that only encrypted data is transmitted over the nonsecure facilities once a session between the nodes has been established. In subsequent paragraphs, there will be described a preferred implementation of the method of this invention for establishing a unique session key that is interchangeable between a pair of the communicating nodes and for simultaneously allowing each node to authenticate the identity of the other node, including the option of allowing each node to authenticate the identity of the user at that node. Referring now to Figure 1, there is shown a personal computer or terminal 21 with attached storage 37 desiring to communicate with a remote node 22. In this case, node 22 may be in the form of a mainframe computing system. A file, either disk or buffer stored and subject to a transmission or send protocol at node 21, is passed to communications adapter 23 for converting byte serial data to a bit serial datastream. The data passes through security module 24 and is encrypted in the process. From here, the data passes through modem 25, over the public switched network 26. At this point, the data is subject to eavesdroppers 28. Subsequently, the data passes through the modem 29 at the remote node. It then passes through a second security module 30. The security module 30 decrypts the datastream and the decrypted data is, in turn, put through switch 31 and then through a communications controller 32. The controller 32 converts the data from bit serial format to some other, byte serial format, which can be processed by the mainframe computer system 22. In a similar manner, data originating at the node, including mainframe computing system 22, sends data to the remote node, in this case, personal computer 21, using the same process but in the other direction. This is standard practice in the art. However, in order for the security modules 24 and 30 to encrypt and decrypt data in a manner where it is not available to eavesdroppers, a secret key must be generated and disclosed to both security modules in some way such that the secret key cannot be known by an eavesdropper 28 who perhaps was listening at a tap at the telephone network 26. Additionally, the method used in generating the secret key should be such that an impostor 27, who has access to the telephone network, cannot successfully impersonate either the terminal 21 or the mainframe computer system 22. The mainframe computer system also has a communications adapter 33, a multiplexor 34 and a security module controller 35 that control access to a disk storage device 36. There is a direct control path between the security controller 35 and the security module 30. Methods thathave been devised to generate such a secret key, but differ in the overall level of achievable security. In the preferred embodiment, the encryption decryption algorithm used in the security module is the Data Encryption Standard DES set in the cipher feedback mode. This algorithm standard was first published by the U.S. National Bureau of Standards in FIPS PUB 46 in January 1977. The cipher feedback mode of operation is described in U. S. National Bureau of Standards FIPS PUB 81, December 2, 1980. Referring now to Figure 2, there is shown the security module appearing as elements 24 and 30 in Figure 1. The security module is installed so that data passes through a security module at each end of the communications link. There are several functions in addition to encryption and decryption of a datastream which are performed by the module. For example, there is included battery maintained store 43, implementable, for example, in CMOS. Store 43 is capable of retaining a certain amount of information, among which is the node master key KMN . The security module is arranged such that KMN is destroyed in case penetration is made of said module. Thus, critical elements are protected by a tamper resistant container 45 and a tamper detector 44. At a minimum, tamper detector 44 would disconnect the battery 50 from the store 43 in the event that a penetration attempt was made. The security module includes the interface circuits 46, 47, and 48 respectively coupling the data path to the communications adapter 23, a control path to a node, and a data path to modem 25. This security module further includes a microprocessor 42 and an encryption module containing the DES algorithm 41. Referring now to Figure 3, there is shown the data flow for encryption and decryption within the security module. Note, the DES chip transforms shifted data under control of the contents of the key register for both encryption and decryption purposes. This process is well documented, the details of which may be found in the aforementioned National Bureau of Standards reference. Having described aspects of a physical system upon which the method of this invention may be practiced, attention is now directed to a description of the logical facilities. As previously mentioned, each security module has a tamper resistant area. This is also termed the cryptographic facility CF . Sensitive information is included within the battery supported RAM such that in any attempt to extract it, it will cause the RAM contents to be lost. Significantly, the RAM contains a master key, denoted by KMN. This key is used as a key encrypting key by protecting other keys and data stored outside the facility. KMN consists of two 64 bit DES keys, KMN and IMN. The encryption of a 64 bit value X under KMN is defined as encryption of X with KMN, decryption of the result with IMN, and encryption of that result with KMN. That is, E Decryption of X under KMN is defined as decryption of X with KMN, encryption of the result with IMN, and decryption of that result with KMN. That is, D Before a specific pair of nodes can communicate, a cross domain key, designated KNC, must be generated and installed at both nodes. KNC also consists of two 64 bit DES keys, KNC and INC. Encryption and decryption under KNC is defined in the same way as previously defined for KMN. A cross domain key is a key used to encrypt and transmit secret random numbers from one node to another in a network, or from one domain of one node to the domain of another node in the network. For purposes of this invention, the domain of a node refers to the set of resources managed by the node. Data communications involving only a single node are referred to as single domain communications, whereas those involving more than one node are referred to as multiple domain communications. The cross domain keys, installed at each node, are actually variants of one another. More particularly, for a pair of nodes x and y that desire to communicate, KNC is installed at one of the nodes, say node x, and the first variant of KNC is installed at the other node, node y. The notation KNCO will be used instead of KNC. KNC1 will therefore designate the first variant of KNC0. KNC1 consists of two 64 bit keys, KNC1 and INC1, where KNC1 KNC0 hex 8888888888888888 INC1 INC0 hex 8888888888888888 denotes the exclusive OR hex hexadecimal format. Each cross domain key shared with another node is stored either in the CF in the protected memory portion of security modules 24 and 30, or outside the CF in encrypted form under encryption of the master key or variant of the master key. Use of the cross domain key is such that when a communications session is established, each node can verify that it is communicating with an authentic other node of the pair rather than an impostor. This is referred to as node authentication, or terminal authentication, when the node being verified happens to be a terminal. When authentication is required for users at node x in the node x to node y session, a user password authentication value PWF must be installed at node y for each valid user ID and password PW allowed at node x. Similar to cross domain keys, password authentication values are available for user authentication. However, password values themselves are not extractable from these password authentication values. Password values entered into the password authentication process may be from 1 to 80 characters or bytes in length. Whenever necessary, passwords may be padded to the right with blanks to make every password 80 characters or bytes in length. The password is then encrypted with the DES using a cipher block chaining mode of encryption with a key and initialization vector of all zero bits. The hashed password, denoted KPW, is obtained by taking the rightmost 56 bits from the last block of produced ciphered text, and expanding these 56 bits to 64 bits by adding an 8th parity bit for each 7 bits in the 56 bit key. The parity bit is added on the righthand side such that, from left to right, the resulting key consists of 7 key bits, 1 parity bit, 7 key bits, l parity bit, etc. This result is designated as KPW. The password authentication values may be determined from KPW and the user ID UID by way of the relation PWF D Ordinarily, if a password authentication value is installed at node x for the user having the ID A, that same password is utilized by user A when establishing a path to x, irrespective of the node where A currently resides. Node x has a list of cross domain keys. That is, it has one key for each node authorized to communicate with x. Also, node x has a list of authorized user ID s and associated password authentication values. There is one value for each user authorized to communicate with x. A node does not normally store more than one password authentication value per user ID, even if that user ID can talk with that node by way of several different nodes. It is appreciated that procedures for installing cross domain keys and password authentication values at each node are well known to the art. Although the following example references two node interconnection, the method of session key generation contemplates any number of nodes participating. Thus, irrespective of the number of nodes involved, all nodes should generate the same session key. The session key is defined by KS E The R It is appreciated that the same goal could be achieved with two independent keys instead of variants of the same key. During the protocol which perceived the setting of the session key, user ID s should be exchanged so that the user at each node is identified. Encrypted PWF If three or more nodes and users are involved, each user must install the same PWF value at each of the other n 1 nodes for which an n way connection and encrypted session is desired. When only two nodes and users are involved, unique PWF values can be stored and used for authentication. For each node, the last term of both the R In the ensuing description, there is first set out a set of temporal and spatial definitions used in the example of the method of this invention. In this regard, the principal actions of the method are distributed over a timeline. These actions are symmetric such that each node mirrors the activity at the other node. The acronym references are defined in the ensuing paragraphs to furnish both a consistent and unambiguous description. In order to illustrate the use of the invention, a set of primitives e.g. a command set for the Cryptographic Facility is defined, and then the session initiation protocol in terms of those primitives is illustrated. In the design of a CF command set, one typically has a goal which is diametrically opposed to the normal goals of command set design. Namely, a major goal of the command set design is to limit what the user can do with the command set, whereas the more common goal is to maximize what the user can do with the command set. As a result, many of the commands perform multiple functions, and commands which perform the most basic operations possible are not available. The CF primitives may best be visualized with the aid of Figure 4. In Figure 4, the areas with the dashed boxes represent data flow within the Cryptographic Facility. Values appearing within the dashed boxes are not available outside of the CF, either to the owner of the node, or to an intruder who might have obtained temporary use of the CF in some manner. Although three dashed areas are shown, these are all within one CF. The different dashed areas pertain to three data manipulation sequences, each of which produces an output. Some facilities RANR, KNCR are shown more than once so that their use can be shown in each of the data manipulations, but the multiple illustrations of these facilities actually represent the same physical facility. Any of the encryption decryption operations described below might have argument sizes of either 8 bytes or 16 bytes, and might utilize a key size of either 8 bytes or 16 bytes including key parity bits . When the key size is 16 bytes, it is understood that three passes are made through the DES algorithm. The keys used for these three passes are the first 8, last 8, and first 8 bytes, respectively, of the 16 byte key. The operations used in the three passes are 8 byte key encryption, decryption, and encryption, respectively, when 16 byte key encryption is specified or 8 byte key decryption, encryption, and decryption, respectively, when 8 byte key decryption is specified. If the argument size is 16 bytes, then the first 8 bytes and then the second 8 bytes are encrypted on successive operations. Throughout, there is no particular logical difference between the use of 16 byte or 8 byte keys, except that greater security is obtained when the longer values are used. In the current design, the node master keys and cross domain keys are 16 bytes. The random numbers, password authentication functions, and session keys are 8 bytes. The following is a list of primitives and their defined function This example assumes that user U1 at a terminal node N1 wishes to communicate with a mainframe node N2 . There is no specific user at the mainframe node. The cryptographic subsystem at the mainframe serves as a gateway to the mainframe system, and is referred to in the example as the gateway . Further, node N1 will be referred to as the terminal . Figure references in this description are to Figure 4. It is assumed that unique master keys have previously been installed at the terminal and the gateway, and that correct entries have been inserted into the user table 215 and node table 226 at the gateway, and into the node table 226 at the terminal. To discuss the session key initiation protocol, it is assumed that the cross domain key at the terminal for this link has a value of hex 11111111111111111111111111111111 . At this point, the terminal and the gateway have generated matching session keys. Both the terminal and the gateway enter encrypted communications mode and pass some test patterns across the link as a test that the session keys do indeed match. If they do, then the node and user at the terminal have been authenticated to the gateway, and the gateway node has been authenicated to the terminal.