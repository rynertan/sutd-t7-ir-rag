# IC card system

## Claims
IC Kartensystem, umfassend eine IC Karte 11 und ein Kartenterminal 41 zur Verwendung in Kombination mit der IC Karte, worin die IC Karte 11 aufweist

## Description
This invention relates to an IC card system comprising an IC card and a card terminal for use in combination with the IC card. The recent years have been called the cashless era due to the use of cards issued by credit card companies and the like, which cards have made possible the purchase of goods without any cash. Up to now, plastic cards, embossed cards and magnetic strip cards have generally been used these, however, are easy to forge, and their misuse has been a problem. To solve this problem, an information card, called IC card, has been developed. This card contains an IC circuit in which a personal identification number is stored, which number cannot easily be read from the outside. This IC card is advantageous in that it is difficult to duplicate, its secrecy maintenance capability is excellent, and it is capable of storing a great amount of data. Since the personal identification number is input directly by the card user, third parties, for example a bank clerk, cannot find it out. In this respect, the card has a very high security factor. US A 4,310,720 discloses a communications link between a computer and a remote user effected by a portable access unit which generates a nonrecurring access code that is function of a password and a pseudorandomly generated number. The access code is transmitted and compared with an access code generated by a computer access controller. In addition to the access code, the pseudorandomly generated number provides an encryption key which is not transmitted but corresponds to a mating encryption key generated at the controller. The mating encryption keys are utilized to set up data transmission enciphering deciphering networks. Successive links are established by incremented pseudorandomly generated access codes. WO 83 03018 discloses a portable device for storing and transferring funds for use in a funds transfer system. Each portable device is card like and comprises a memory means for storing a monetary balance, for instance, and a plurality of identifying characteristics of the user Micro computer means in the card update the balance after funds transfer, and randomly select some of the identifying characteristics to query the user. The user s response is compared with the stored characteristics. Ultra sonic coupling means in the card permits coupling to another card through a coupling terminal. A keyboard and a digital display permit inspection of the balance. The micro computer date and time stamps each transaction. Therefore, this document discloses a technique for preventing the unauthorized use of an IC card by identifying an authentication of the user. With this system, it is not possible to check the compatibility of the IC card with the card terminal. If something is wrong with the internal circuit of the IC card which is essential to the data exchange between the IC card and the card terminal, an abnormality will occur in the data transfer. Therefore, erroneous data exchange and storage will take place, resulting in an error in the transaction. A Working Draft 7816 3 of ISO TC Standard IDENTIFICATION AND CREDIT CARD , Part 3 Electronic Signals and Exchange Protocols of 1984 06 discloses the prior art according to the preambles of the claims 1 and 8. Accordingly, it is an object of this invention to provide an IC card system which prevents errors in transaction at an earlier stage, i.e. when there is an abnormality in the internal circuit of the IC card or the card terminal, specifically in that such trouble can be detected before the actual data transfer occurs. According to one aspect of the present invention, there is provided an IC card system comprising an IC card and a card terminal for use in combination with the IC card, as set out in claim 1. According to another aspect of the preser invention, there is provided a method for checking the compatibility of IC cards with card terminals, as set out in claim 8. Further advantageous embodiments of the present invention are disclosed in the corresponding subclaims. This invention can be more fully understood from the following detailed description when taken in conjunction with the accompanying drawings, in which An embodiment of this invention will be described with reference to the accompanying drawings. In Fig. 1, there is shown a flowchart of the IC card and the card identification data in which the IC card is manufactured, then given to an issuer, for example a bank, and then issued to a card owner. The IC card manufacturer produces an IC card 11 by using card terminals 12, 22, 32, and 41 Fig. 2 . The card manufacturer, after producing IC card 11, writes a predetermined code into the card 11 by using IC card manufacturing terminal 12. As will be described in detail later, this IC card 11 contains an internal IC circuit and is provided with connector or connection terminals 11a on the surface of its case. When the card 11 is inserted in IC card manufacturing terminal 12, this connection terminal 11a makes contact with the internal circuits of terminal 12. The card manufacturing terminal 12 contains a card insertion slot 13, a keyboard 14, a display panel 15, and a printer section 16. With data input via keyboard 14 by an operator, the different kinds of codes, such as CA, PMK, and PRK, are written into IC card 11. The CA Card Authenticator is of a random 64 bit code and is used for the encryption and decryption of messages. PMK Production Master Key is a manufacturing number code, and the same PMK is used on all IC cards of one group, such as one lot unit, and is kept secret even in the factory. PRK Private Key is a decryption code, which, as will be explained later, corresponds on a one to one basis to the Public Key code, or an encryption code which is written into the card terminal 12. When a given code is written into the IC card 11 the IC card manufacturing terminal 12, the PMK only is printed on a security code printing paper 17 by printer section 16. Then, the manufacturer seals the IC card 11 and the security code paper 17 in the same envelope or in different envelopes, and mails them to the issuer. When IC card 11 and paper 17 are sealed in the same envelope, this envelope should be sent via a security mail such as a registered mail. The issuer inserts the IC card 11 as he received it from the manufacturer into IC card issuing terminal 22, then reads out the recorded PMK code on the security code paper 17, and inputs the corresponding PMK code into IC card issuing terminal 22. Also, the issuer inputs the primary account number PAN and IPIN initialization personal identification number for the IC card 11, into IC card issuing terminal 22. This IPIN is, for example, a 6 bit random code which is used as an identification number until a personal identification number PIN is used. IC card issuing terminal 22, like IC card manufacturing terminal 12, is provided with a card insertion slot 23, a keyboard 24, a display panel 25, and a printer section 26. The PMK code which has been written into IC card 11, and the PMK code input from keyboard 24 are compared for coincidence, and only if both codes coincide with each other, the account number PAN is written into IC card 11, and the input IPIN is printed on a security code paper 27. Then, the issuer places the IC card 11 with the PAN as written and the security code paper 27 with the printed IPIN in the same envelope or in separate envelopes, and sends them to the card user. When the card user receives the IC card 11 and the security code paper 27 from the issuer, he or she goes to the card issuing point, inserts his or her card into a IC card user terminal 32, which is installed there, and then reads the recorded contents from the security code paper 27 he or she received from the issuer, and code inputs them into IC card user terminal 32. The card receiver also inputs the personal identification number PIN of his or her choice into IC card user terminal 32. IC card user terminal 32, like the IC card issuing terminal 22, is equipped with a card insertion slot 33, a keyboard 34, a display panel 35, and a printer section 36. The IPIN written in IC card 11 and the IPIN input from keyboard 34 are compared for identification, and only if they coincide, the above mentioned PIN is written into IC card 11. As a result of the above procedure, the issuing of this IC card 11 is complete, and card 11 can now be put to actual use. Beyond this step, further details are referred to in US serial number 645,925 filed August 30th, 1984. No further explanation will be given here. Fig. 2 shows the outer appearance of a card terminal device 41 used for IC cards 11, which may be installed in a store, for example, when the terminal device for IC cards is realized according to this invention. This card terminal 41 is composed of a card insertion slot 42, a keyboard 43, and a display section 44. Fig. 2A shows a card receiving section 42a corresponding to card insertion slot 42, which is inside terminal 41. This card receiving section 42a uses a card insertion detector section 42b, a card lock detector 42c, and a card connection detector 42d. Card insertion detector section 42b contains a microswitch for detecting whether or not the IC card 11 is inserted into card insertion slot 42. Card lock detector 42c, containing a sensor not shown and a solenoid, reliably locks the inserted card 11, and senses the locked state by means of the sensor. Card connection detector 42d, containing a solenoid, detects whether a contact probe 41a of terminal 41 is reliably in contact with connector connection terminal 11a provided on the reverse side of IC card 11. The keyboard 43 uses numerical keys 45, yes key 46, and no key 47. The internal circuits of this card terminal 41 will be explained in detail later. The configuration of the internal IC circuits of the IC card 11 will be described referring to Fig. 3. In the figure, a system bus 51 is shown. A data ROM 52, an application ROM 53, a system program ROM 54, a working RAM 55, a system controller 56, a decryption arithmetic unit 57, and a read write controller 58 are all connected to the system bus 51. An input controller 60 is connected to this bus 51 via an input buffer 59, and an output controller 62 is connected to this bus 51 via an output buffer 61. A data input output terminal I O is connected to input controller 60 and output controller 62. The above mentioned ROM 52 stores all the operating conditions pertaining to the card 11 itself, such as data write applied voltage, its current tolerance value and maximum application time, maximum data transmission capacity, and maximum response waiting time. When the initialization of the card 11 itself is finished, this condition data, in conformance with a preset format, is sent to the terminal 41 side as answer to reset data. The above application ROM 53 stores card classification data APN application name , which shows the classification of this card 11. The card classifiation data is put into a specified format and sent out when the attribute exchange occurs with terminal 41, after initial parameters have been set in accordance with the answer to reset data. System program ROM 54 contains besides every kind of system program ACK and NAC codes, which show whether the signal transmitted from terminal 41 is correct or not. System controller 56 has an internal decision area, and outputs operating commands to related circuits in accordance with the data receive signal transmitted via input buffer 59 and operation status. Decryption arithmetic unit 57 performs decryption in accordance with the RSA algorithm, and decrypts input data supplied from the terminal 41 side via input buffer 59, by means of the decryption key code issuer s private key stored in key code memory ROM 57a, and outputs it to a comparator 63. The comparator output of this secret information comparator 63 is supplied to a system control line 56a of system controller 56. This system control line 56a is connected to a flag 64, which operates in accordance with the comparison results received from the comparator 63. Read write controller 58 controls the write in or read out of data relating to a data memory 65 in accordance with the commands from system controller 56. The memory data read out by this read write controller 58 is output to comparator 63, system bus 51, or a card status buffer 66. EEP ROM, for example, is used for this data memory 65. The codes CA, IPIN, PAN, CHN, EPD, PRK, and RTN, and status data ST are written into this memory area. The CHN is an abbreviation of card holder s name . EPD is an abbreviation of expiration date . RTN is the number of times that re entry has been performed when incorrect data was input. Also, ST shows the current status of card 11. For example, if the manufacturing process of this card 11 has been completed, manufacturing process data is written in, and even if the card 11 has been issued, and the PIN has not been entered, PIN not entered data is written in. The card status data ST, is arranged in the same format as the card classification data APN as stored in application ROM 53, and sent to the terminal 41 side. The above data memory 65 is not limited to use with EEP ROM, but as an alternative, may also use EP RO, for example. The system controller 56 is connected to a timer 67. This timer 67 counts a predetermined time during normal data exchange processing when a start data write voltage supply message is output by card terminal 41. During the count operation of this timer 67, if a positive response signal ACK is not supplied from terminal 41, system controller 56 will stop the data input output for this card 11. An address comparator 68 is connected to the bus line which connects read write controller 58 and system bus line 51. This address comparator 68 always compares the unused specific address entered in a fixed address unit 69 at the end of the test following completion of manufacture, and the specific address specified via system bus 51. The result of the comparison by comparator 68 is supplied to read write controller 58. In this way, only when the comparing output is the address coincident signal due to unauthorized use of the terminal, it clears all of the data in data memory 65, thereby preventing secret data from being read out of the card 11. In a situation that the IC card 11 is coupled with card terminal 41, terminal 41 supplies a reset signal RESET and a system clock signal clock through connector connection terminal 11a to the IC card 11. Vcc and Vpp power supplies are also supplied to it. Vcc power source is a system drive power source, and Vpp power supply is used for writing data to data memory 65. The power voltage is set up by terminal 41 side on the basis of the answer to reset data as stored in data ROM 52. The system operation signal based on the system clock is supplied through frequency divider 70. A circuit configuration of card terminal 41 will now be given referring to Figs. 4A, 4B. In the figures, a system bus 71 is coupled with a sound controller 72, a working RAM 73, a system program ROM 74, a terminal attribute ROM 75, an initial parameter RAM 76, a main controller 77, a display drive controller 78, a key controller 79, a read write controller 80, a comparator 81, an encrypting arithmetic unit 82 based on RSA algorithm, a latch circuit 83 for latching CA , an encrypting arithmetic unit 84 of the DES system based on data encryption standard, a decrypting arithmetic unit 85 of DES system, an input output I O controller 86, and an output buffer 88 through an output controller 87, and an input controller 90 through an input buffer 89. Sound controller 72 is coupled with a speaker 91 for sounding an alarm if such a situation occurs. The memory area of working RAM 73 stores PAN , CHN , and EPD as sent from IC card 11, and further various types of data processed in terminal 41. System program ROM 74 contains various types of system programs, and ENQ enquiry code for taking matching to IC card 11. Terminal attribute ROM 75 stores terminal code TC manufacturing code, issuing code, shop code, etc. , according to the use of the terminal 41. Terminal code TC is transmitted in a predetermined format, after the setting of the initial parameters according to the answer to reset data from card 11, and when an attribute exchange with the card 11 side is performed. Then, the answer to reset data from the IC card 11 side is stored in its entirety in initial parameter RAM 76. This initial RAM 76 is connected to output controller 87, input controller 90, a Vpp level latch unit 92, a Vpp timer latch unit 93, and an lpp level latch unit 94 via an initial data transmission line 76a. Also, each latch unit is connected to its corresponding Vpp power supply 95, Vpp timer 96, or lpp limiter 97 respectively. The output of the Vpp power supply 95 is connected to the Vpp output terminals by way of Vpp timer 96 and an lpp limiter 97 successively. The maximum data transmission capacity of card 11, which is controlled by main controller 77, the card data maximum write voltage by Vpp power supply 95, the write voltage supply time by Vpp timer 96, and the card data maximum write current by Ipp limiter 97 are all set by the answer to reset data as all set in initial parameter RAM 76. An IC card operating frequency selector 98 is connected to the data transmission line 76a. The oscillating signal from an oscillator 99 is supplied to this selector 98 via a frequency divider 100. The oscillating signal with a predetermined frequency is outputted from the clock terminals. Also, a timer 101 is connected to the above initial parameter RAM 76. This timer 101 counts the maximum response waiting time from an instance that an enquiry signal ENQ or other command signals is sent from the terminal 41 side to the the card 11 side, according to the answer to reset data as sent from the IC card 11 and stored in initial parameter RAM 76. During this waiting time, if some kind of response signal is not received from the card 11 side, main controller 77 again directs the transmission of the above ENQ or other command signal, or directs via reader writer controller 80 that a reader writer mechanism unit 102 be disconnected from card 11. It is assumed that the card receiving section 42a is included in the reader writer mechanism unit 102. System control line 77a of main controller 77 is connected to comparator unit 81, decryption arithmetic unit 82, latch circuit 83, and input output controller 86. According to the operation status of the system, control commands are sent to every circuit unit from main controller 77. Display drive controller 78 controls display section 44 and a back light 44a constructed with EL elements provided on the rear side of display section 44. This back light 44a only lights when IC card 11 is inserted into the read write mechanism 44. Key controller 79 provides a key sampling signal to keyboard 43, and detects the key input signal. Then, reader writer controller 80 controls the operation of reader writer mechanism unit 102. This reader writer mechanism unit 102 is provided with a card conveying motor, which conveys card 11 from card insertion slot 42 to a specified location, and after completion of the given processing, returns card 11 to card insertion slot 42. This unit 102 is further connected to output buffer 88, a reset controller 103, Ipp level latch 94, operation frequency selector 98, and a Vpp power supply 104. The terminals corresponding to these units, I O, Reset, Vpp, clock, and Vcc are set at high impedance only when IC card 11 is not inserted. In this case, when IC card 11 is inserted, first the supplying of power supply voltage is begun by Vcc power supply 104. At the start of this voltage supply, if an abnormal current with a value above a certain level flows, a card reject signal is output to reader writer mechanism unit 102 from an l Output controller 87, which is connected to input terminals I O via input controller 90 and output buffer 88, controls the transfer of data between card terminal 41 and IC card 11, according to the command received from main controller 77 via initial parameter RAM 76. The input controller 90 outputs the data from IC card 11 via input buffer 89 to memory device units, such as working RAM 73. Output controller 87 sends the data received from the memory device of terminal attribute ROM 75 to the IC card 11 side via output buffer 88. Data input from the IC card 11 via input buffer 89 is sent to comparator 81 via the bus line, and the output of that comparator 81 is supplied to main controller 77. Further, the above output controller 87 sends the decryption data as received from encrypting arithmetic unit 82, to IC card 11 via output buffer 88. Encrypting arithmetic unit 82 encrypts the data PAN from working RAM 73 received via system bus 71, according to the public key code received from an IPK Issuer s public key ROM 106 as data ROM. The public key code which corresponds to the PRK stored in data memory 65 of IC card 11, is already written into IPK ROM 106. In response to a command from main controller 77, this memory code is outputted. CA latched in latch circuit 83 is inputted to encrypting arithmetic unit 84 and decrypting arithmetic unit 85. Given data is inputted to encrypting arithmetic unit 84 via system bus 71. PAN stored in working RAM 73 is encrypted, with the key of CA , in response to the command from main controller 77, and outputted to input output controller 86. The data base, i.e. the encrypted data is output to the host computer, when it is connected in on line manner. This input output controller 86 outputs the data base, in other words, data which is encrypted when the host computer is on line, to the host computer. Input output controller 86 decrypts the crypted data from the host computer according to the CA by decrypting arithmetic unit 85, and outputs it to system bus 71. The operation of the IC card terminal device thus arranged will be explained. First, as shown in Fig. 1 above, the IC card 11 is manufactured and issued, and the PIN of the user has been registered. For purchasing goods from a store with this IC card 11, the user inserts the card 11 into a card terminal 41, as shown in Fig. 2. A processing operation based on the flowchart of Fig. 5 is started. In the description to follow, IC card 11 is a credit card. In case the card holder customer is making a shop purchase, he first inserts the card 11 into the card insertion slot 42 of the card terminal 41 installed in the shop s counter. In step S1 in the flowchart, card terminal 41 determines if IC card 11 is reliably inserted into card receiving section 42a in Fig. 2A. This determination is made by main controller 77 through reader writer mechanism unit 102 and reader writer controller 80. In step S1, the answer is YES, that is, the insertion detector unit 42b of card receiving section 42a operates. After the completion of the insertion of IC card 11 is verified, the control goes to step S2. In step S2, if the answer is YES, a card lock rod L1 of card receiving section 42a is turned in the direction of arrow a and a card lock detector 42c operates, and it is checked if the inserted card 11 is locked or not. Following the check, the control proceeds to step S3. In step S3, it is determined if connector unit 11a of IC card 11, which has been inserted and locked, is properly connected to contact probe 41a of the terminal 41 side or not. In this step S3, the answer is YES, contact load L2 of card receiving unit 42a turns in the direction indicated by the arrow b , a card connection detector 42d operates, and when the connection complete status of IC card 11 is verified, the control moves to step S4. After the card 11 is set to terminal 41, and its internal circuit is connected to that of the terminal 41, first of all, Vcc power supply 104 produces a test voltage much lower than a normal voltage for the initial setting given later , and supplies it to IC card 11. Then, in step S4, it is determined whether an overcurrent flows in the power Supply by an Icc limiter 105 of the terminal 41 side. Here, if the answer is NO, that is, the current flowing in the above Icc limiter 105 does not exceed a predetermined value, and the connection status of IC card 11 is verified to be proper, then the control goes to the steps following the next initialize reset. In step S4, if the answer is YES, it is detected that the value of the current supplied to Icc limiter 105 exceeds the predetermined value, and it is verified that the connection status of IC card 11 is not stable. Then, Icc limiter 105 supplies a card reject command signal to reader writer mechanism unit 102. Upon receipt of this, reader writer mechanism unit 102 performs the noncontact operation. The card lock is cancelled, and IC card 11 is flipped by a plunger not shown and rejected from terminal 41. Then, in steps S1 to S3, the setting status of card 11 to terminal 41 is observed. If a proper connection of IC card 11 in step S4 is again not obtained, the proceeding to the steps following the next step is prohibited. The prevention of the supplying of an operation signal in the unstable connection state of IC card 11 is accomplished. Further, undesirable effects from the bad connections of the card circuits are prevented. Through the card setting and connection status detection processes, if a stable connection state is obtained, a predetermined initializing signal, as shown in step A1 of Fig. 6A, is sent from card terminal 41 to IC card 11. This initialization signal, under control of main controller 77, sets the input output terminal I O to H high level, reset terminal from L low to H level, the Vcc and Vpp terminals each to 5 V, and the clock terminal clock to 4.9152 MHz. This initialization signal is sent to the card 11 side, and received by way of the corresponding terminals, I O, Reset, Vpp, Vcc and clock terminals. Then, in step B2, IC card 11 starts under operation conditions based on the initialization signal. In step B3, IC card 11 having started the initial operation in this way, under the control of system controller 56, reads out the answer to reset data already stored in data ROM 52, and sends it from I O terminal to the terminal 41 side via system bus 51, output buffer 61, and output controller 62. In this case, if it is determined by main controller 77 that the answer to reset data sent from terminal 41 to card 11 has been read into initial parameter RAM 76, main controller 77 distributes and sets this answer to reset data into each corresponding circuit, as operating conditions setting data. The operating frequency setting data for IC card 11 is set in operating frequency selector 98. The write voltage setting data for data memory 65 and the maximum tolerable write current setting data are set in Vpp level latch unit 92 and lpp level latch unit 94. The setting data for the maximum data transmission capacity for card 11 is set in main controller 77 itself, and the response signal waiting time setting data is set in timer 101. The voltage application time data is set in Vpp timer latch unit 93. Therefore, the maximum data transmission capacity controlled by main controller 77, the data write voltage determined by Vpp power supply 95, the data write continuous application time determined by Vpp timer 96, the data write tolerable current determined by lpp limiter 97, and the card operating frequency determined by operation frequency selector 98, are set to the values as specified by the operating conditions dedicatedly for card 11 now set, on the basis of the answer to reset data written in initial parameter RAM 76. The contents of the answer to reset stored in data ROM 52 and the details of the operation of the answer to reset will be described with reference to Figs. 7 through 16. Fig. 7 shows the overall configuration of the answer to reset data stored in data ROM 52. In the figure, the operation condition data for IC card 11 are expressed by interface bytes TA1, TB1, TC1, TA2, TB2, and TC2. The presence or not of these condition data is expressed by format byte TO. TD1 indicates the presence or not of the condition data succeeding to data TA2. Initial byte TS is the initialization data when these condition data are transferred. Complementary bytes T1, T2, ..., and TK are used when the condition data of this card 11 is increased. The initial byte TS, format byte TO, and the interface byte have each the 8 bit data format. Fig. 8 illustrates the code contents of initial byte TS. Of the eight bits codes a through h, As described above, the answer to reset data, composed of initial byte TS, format byte TO, interface bytes TA1, TB1, TC1, TD1, TA2, and TK, are received in the standby mode by the terminal 41 side. In this case, it is determined in step A2 if the answer to reset data was received within the data standby time 100 ms for instance initially set or not. In step A3, if the answer is YES, and main controller 77 determines that the answer to reset data has been written into initial parameter RAM 76 via I O terminal, input controller 90, input buffer 89, and system bus 71, the control moves to step A4 and main controller 77 further determines if the data written in initial parameter RAM 76 correctly corresponds to this terminal 41. When the answer to step S4 is determined to be NO, the control goes to step S5, and main controller 77 distributes and sets in all the interface bytes in initial parameter RAM 76 to each corresponding circuit, as operation condition setting data. In other words, the operation frequency setting data for IC card 11 which corresponds to interface byte TA1, is set into operation frequency selector 98 via data transfer line 76. Also, the write voltage data and maximum tolerable write current setting data for data memory 65, which correspond to interface byte TB1, are set respectively into Vpp level latch unit 92 and Ipp level latch unit 94. Then, the maximum data transmission capacity data for IC card 11 corresponding to interface byte TA2, is set into main controller 77 itself, and the response signal waiting time setting data corresponding to TB2, is set into timer 101. In this case, the predetermined data waiting time as set in timer 101 in step A2 is re written into an inherent waiting time for the IC card presently connected. Further, the write voltage application time setting data for data memory 65, which corresponds to interface byte TC2, is set into Vpp timer latch unit 93. Due to this, the maximum data transfer capacity controlled by main controller 77, the data write voltage determined by Vpp power supply 95, the data write voltage continuous application time determined by Vpp timer 96, the data write tolerable current determined by lpp limiter 97, and the card operation frequency determined by operation frequency selector 98, are all set into the values corresponding to the operating conditions specific to card 11, on the basis of the answer to reset data written into initial parameter RAM 76. As a result, even if the operation conditions of data write voltage Vpp and its continuous application time, the tolerable current lpp or data write capability, or response capabilities differ with each card, if card 11 has the data transfer function of the answer to reset data and the terminal 41 has the reset function of the condition data, conditions for cards of every kind of performance can be set. If an answer NO is obtained in step A3 or in step A4, the control goes to step A6, and it is determined whether or not the decision NO has occurred more than 3 times. In this case, the number of times this NO determination has occurred is recorded in the counter area of working RAM 73, and the value of this count data is checked by main controller 77, to perform the decision in step A6. In case an answer NO is determined in step A6, the control goes to step At and the initial data is sent to IC card 11. In step A6, if the answer YES is given, that is, it is determined that the answer to reset data generated from card 11 does not correspond to this terminal 41, main controller 77 sends a control command to reader writer controller 80. Then, the plunger in reader writer mechanism section 102 is pulled to release the card 11 from being locked, and the IC card 11 is discharged resulting in disconnection of the card 11 and the terminal 41. Therefore, if the IC card 11 is not compatible with this system or if it is impossible to set the operating conditions, in step A6, the system is disconnected from card 11. Trouble can be prevented from occurring. In step A5, after completion of setting an initial parameter in card 11 as set to the terminal 41, the control proceeds to the step S7 of Fig. 5, i.e. step S7 shown in Fig. 6B. Main controller 77 takes out ENQ code, that is, the code for enquiring whether the card 11 in the other party is normally operated under operating conditions as set in step A5, from program ROM 74. The code is then transferred to IC card 11 by way of system bus 71, output controller 87, output buffer 88 and I O terminal. Card 11 receives the ENQ signal from the I O terminal, through controller 60 and input buffer 59, and writes it into working RAM 56 step B4 . In this case, in step B5, input controller 60 performs the parity check of ENQ signal. If the answer in this step is YES indicating that the parity check of the input signal is OK, the control proceeds to step B6. In step B6, system controller 56 checks if the ENQ code written into working RAM 55 can be accepted as the normal ENQ code. In this step, if the answer is YES, that is, it is determined that the ENQ code can be accepted as the normal one in the normal operating condition, the control goes to step B7. On the basis of the decision that this card 11 is placed in the normal operating condition under the setting condition at terminal 41, system controller 56 takes out ACK code from system program ROM 54, and transfers it to terminal 41 via output buffer 61, output controller 62, and the I O terminal. In step B5 or B6, if the answer is NO, the control advances to step B8. In this step, the controller 56 determines that this card 11 does not operate normally under the conditions as set by terminal 41, or determines that there is some trouble in the transmission path between terminal 41 and card 11. On the basis of such determination, system controller 56 reads out NAC code from system program ROM 54, and transmits it to terminal 41 via output buffer 61, output controller 62 and the I O terminal. Upon receipt of this, terminal 41 receives ACK signal or NAC signal as sent from card 11 via the I O terminal, in the standby mode in step A8. In this case, in step A9, it is determined whether the signal ACK or NAC is received in the response wait time of 150 ms, for example, of IC card 11 as set in timer 101 in step A5. In step A9, the answer of YES is given. In other words, the main controller 77 decides whether the signal of ACK or NAC is written into working RAM 73 through I O terminal, input controller 90, input buffer 89, and system bus 71, within the wait time of IC card 11 as set in timer 101. Then, step A10 is executed. In this step, main controller 77 decides whether the data as written into working RAM 73 is proper, that is, corresponds to this terminal 41. If the answer of this step is YES, the next step All is executed. In this step, main controller 77 decides whether the code as written into working RAM 73 is ACK or not. If the step All gives the answer of YES, that is to say, if the signal from card 11 as received in step A8 is ACK , and card 11 normally operates under each operating condition as set in step A5, the decision is made that the transmission path between terminal 41 and card 11 is normal. The control flows to step A12. In this step, main controller 77 reads out the terminal code TC from terminal attribute ROM 75. The terminal code TC differs with the type of the terminal. The read out terminal code TC is latched in output buffer 88. The controller is set in standby state for the attribute exchange processing in the next step. In step A9, A10 or A11, if the answer of NO is given, the control proceeds to step A13. In this step, it is determined whether the number of the answers of NO reaches three. The number of the NO answers in step A9, A10 or A11 is stored in the count data area of working RAM 73. This count data is checked by main controller 77, to make the decision of step A13. In step A13, if the answer is NO, the step A7 is executed again to send the ENQ code to IC card 11. In step A13, if the answer is YES, main controller 77 sends a control command to read write controller 58, to drive the plunger in reader writer mechanism 102, to put out IC card 11 and to electrically disconnect it from the terminal 41. The answer YES in step A13 means that the signal sent from card 11 does not correspond to terminal 41, or that the signal sent from card 11 is the NAC signal, and IC card 11 does not operate normally under operating conditions as set in step A5, or that some trouble occurs in the transmission path between the terminal and the card. In this way, after setting of the initial parameter in step A5, if the IC card set to this terminal 41 will not operate normally, the decision is made whether the card improperly corresponds to the terminal or that the transmission path trouble occurs. Then, the card 11 is disconnected from the terminal 41. The trouble occurrence can be prevented beforehand. Next, the processing of the attribute exchange shown in step S8 of Fig. 5, or Fig. 6C will be explained. First, as explained in step A14, terminal 41 transfers the terminal code TC as latched and set into output buffer 88 in step A12, to the card 11 side via the I O terminal. In this case, terminal code TC is placed in a format as shown in Fig. 17, and transferred. The card 11 side, in step B9, receives the terminal code TC via input controller 60 and input buffer 59, and stores it in working RAM 55. In step B10, input controller 60 performs a parity check on the transfer signal incorporating the terminal code TC, and determines whether the data contents are correct or not. If the answer is YES, in other words if the parity check is determined as OK, the control moves to step B11. In this step, system controller 56 takes out the application name APN , which is stored in application RAM 53 and varies with the type of card, and latches it into output buffer 61, and the control goes to the next step. Then, in step B12, the application name APN which was latched into output buffer 61 in step B11, is transferred to the terminal 41 side via output controller 62 and the I O terminal. In this case, application name APN is arranged in a format such as that shown in Fig. 18, and is transferred as a card classification code. This name area is composed of 12 bytes, including the expansion byte 2 byte . Again, at the time of transfer of this code APN, the card status data ST stored in data memory 65 is transferred to the terminal 41 side via read write controller 58 and card status buffer 66, as the card classification code. In the above step B10, if the answer is NO, the control moves to step B13, system controller 56, based on the read in impossible decision, takes out the NAC code from system program ROM 54, and sends it to the terminal 41 side via output buffer 61, output controller 62, and the I O terminal. In step B10, data is checked by using the parity check system. The compatibility of the IC card 11 and the terminal 41 may also be checked by comparing the terminal code TC and the application name code which represents the attribute of the card 11. If the answer is NO in step B10, the control goes to step B13 and NAC code is outputted. Then, the terminal 41 side, in step A15, receives the card classification code and NAC signal that was sent from the card 11 side via the I O terminal, and stores it in working RAM 73. Then, the control goes to step A16, and main controller 77 determines whether the data written into working RAM 73 corresponds properly to this terminal 41 or not. If the answer in step A16 is YES, the control goes to step A17, main controller 77 determines whether the data written in working RAM 73 is NAC or not. If, in step A17, the answer is NO, that is to say, if the data sent from the card 11 side is not NAC , and it is determined that it is a card classification code including APN and card status data ST, and the control assumes a card classification decision flow shown in steps S18 and A19. On the other hand, if NO in step A16, or YES in step A17 is obtained, the control goes to step A20, and it is determined whether the number of occurrences of NO in step A16 and YES in step A17 exceeds a predetermined number or not for example, n 2 . In this case, the number of occurrences of the above NO and YES answers is recorded in the form of count data of working RAM 73, and the decision in Step A20 is accomplished by check of these count data values by main controller 77. Then, if the determination in step A20 is NO, the control returns to step A14, and the transfer of terminal code TC to IC card 11 is performed. If the answer in step A20 is YES, if it is determined that the contents of the signal as sent from the card 11 side do not correspond to this terminal 41, or if the signal sent from the card 11 side is an NAC signal, and terminal code TC is determined to be impossible to receive , main controller 77, by sending a control command to reader writer controller 80, drives the plunger of reader writer mechanism unit 102 to reject IC card 11 and disconnect it. Because of this, even in case the data transfer of terminal code TC and the card classification code cannot be done properly, at the step following the start of normal operation by the initial parameter settings of the terminal 41 side, the connection between the card terminal 41 and the unsuitable card 11 is broken, and trouble is prevented beforehand. Next, the card classification decision operation of steps A18 and A19 will be explained. Fig. 19 shows the above card classification decision operation in detail. First of all, in step B12, the card classification code, application name APN, that was sent from the card 11 side and stored in working RAM 73, is taken out by the main controller 77 in step A19a, and it is determined whether its application classification corresponds to that of the application name APN already stored in terminal attribute ROM 75 or not. Here, assuming that terminal code TC of this terminal 41 is a merchant code, that application name APN is, for example, abc bank counter installation , and that the application name APN of the card classification code sent from the card 11 side is, for example, savings withdrawals and deposits of the cd branch of abc bank , in step A19, both application names are judged to be the same, and the control moves to the data transfer processing following step A21. In step A21, based on the decision in step A19a that the classification of the currently connected card 11 corresponds to that of this terminal 41, and for the first time, a regular command is taken out of system program ROM 74, and transferred to the card 11 side. On the other hand, in case the application name of the card classification code sent to the terminal 41 side in step B12 is, for example, xy trust company general purchase card , the card classification in step A19a is determined not to be the same, and card rejection processing is implemented. In step A22, based on the decision that the classifications of the currently connected IC card 11 and this terminal 41 are not the same, main controller 77, by sending a control command to reader writer controller 80, drives the plunger of reader writer mechanism 102 to reject the IC card 11 and disconnect it. At the same time, it sends a control command to display drive controller 78, which causes a wrong type message to be displayed by display unit 44. In this embodiment, the application name APN is prestored in terminal attribute ROM 75, but, as an alternative, the application name APN can be written into working RAM 55 by inserting a starting card after the terminal power is turned on. As mentioned above, when the intended purpose of IC card 11 does not agree with the classification of terminal 41, due to the fact that the actual data transfer was not performed, the trouble caused by terminal misuse is prevented beforehand. The terminal command discriminating operation in which following the card classification discrimination operation, a command code is sent from the terminal 41 side to the card 11 side, and actual data transfer processing is performed, will be described. Fig. 20 shows the terminal command verification operation in detail. First, in step A14, the terminal code TC already sent from the terminal 41 side and stored in working RAM 55 of IC card 11, and the command code COM sent in step A21 of Fig. 19 the data exchange start step , are arithmetically processed according to a specified formula in step B14. Then, the arithmetically processed terminal code TC and its command code COM , are comparatively judged, to determine whether they have a properly corresponding relationship or not in step B15. If the terminal command code COM which was sent in step A21 is, for example, the comparison verification command PIN Compare of the personal identification number, terminal command code agreement TC PIN Compare is determined. If the terminal command code is, for example, the write command of the personal identification number PIN Write , it is determined in step B15 to be a terminal command code disagreement TC is not equal to PIN Write . In other words, the results of the comparative judgement of the terminal code TC and its command code COM , in step B15, conform with a terminal code and command code chart, as shown in Fig. 21. The coincidence decision is given only when the commands that should be present shown by a circle for each terminal are sent to the card side. When commands that should not be present are sent, the non coincidence decision is given. In step B15, if the coincidence decision between the terminal code TC and command code COM is given, the control moves to step B16. According to the command code whose conformance to terminal 41 has been identified, in this case, the personal identification comparison verification command , the personal identification number keyed in from the terminal 41 and the PIN stored in the data memory of card 11 are compared by comparator 63. Then, if the above PINs coincide, the data transfer exchange processing operation of the cash transaction is performed. On the other hand, if in step B15, the terminal code TC and the command code are determined to be noncoincident, the control moves to step B17. System controller 56 informs terminal 41 of the fact that command code as sent in step A21 is an error code which does not correspond to terminal code TC. Further, it locks system program ROM 54 or data memory 65, to prevent the incorrect reading out of data from the incorrect writing into the system program ROM 54. Therefore, if terminal 41 is modified with intention of improper use of card 11, it is impossible to execute the correct commands. Therefore, an IC card system with a high security factor can be realized. The registration of the card status in the IC card system will be described. Fig. 22 shows a flowchart for illustrating registration and check of card status. In step A101, at the time that manufacturing of IC card 11 is completed, the manufacturing end status is written into data memory 65 of IC card 11 at card manufacturing terminal 12 as shown in Fig. 1, for example. Following the end of the card manufacturing step, the control goes to the card issuing step. At this stage, if IC card 11 is set to card issue terminal 22, the terminal 22 reads in the status data ST in the data memory 65 of card 11, in step A102. In this step, it is determined whether the manufacturing end status is present or not. If the determination is YES, a predetermined card 11 is issued and step A103 is executed. This step is executed to write the issuing end status into the data memory 65 in card 11, by card issuing terminal 22. After the end of card issuing, the control advances to the PIN registration step. When IC card 11 is set to PIN registration user terminal 32, terminal 32 reads in, in step A104, the status data ST in the data memory 65 of card 11, and determines whether the issuing end status is present or not. If the answer in the step is YES, the control advances to step A105, following the end of a predetermined PIN registration step. The PIN registration status is written into the data memory 65 of card 11 by means of user terminal 32. After the end of PIN registration, the shop use step is executed in which IC card 11 is set to shop terminal 41 as shown in Fig. 2, for example, and terminal 41 in step A106 reads in the status data in the data memory 65 of card 11, to check whether the PIN registration status is present or not. In this step A106, if the answer of YES is given, step A107 is executed to allow purchasing of goods in a shop. Fig. 23 illustrates the card contents of card status data ST as stored in the memory 65 of IC card 11. In the 8 bit cord, small b indicates a bit representing the manufacturing end status written into in step A101. c is a bit indicating the PIN registration status written into in step A105. d is a bit representative of the issuing end status written into in step A103. The status data ST further contains a bit representing a mistaken entry of the verification number as made continuously three times, which is associated with the bit In steps A102 to A104, if the answer is NO, step A108 is executed. The answer N means that the manufacture step end status is not written into data memory 65 of IC card 11 when the control goes to the card issuance step, or 1 is raised in the bit area b in Fig. 23, or the issuing or issuance end status is not yet written into the data memory 65 in the PIN registration step, or 1 is raised in the bit area d in Fig. 23. In the step A108, it is determined whether the step which should have been terminated is not yet terminated, that is, decision is made of a possibility of misuse . On the basis of this decision, a flag is set in flag area 64 of IC card 11. The system controller 56 is made substantially impossible. With this, the card 11 is made invalid. In step A106, it is assumed that the answer is NO. In this case, in the store use step, the PIN registration status is not written into data memory 65 of IC card, viz. 1 is set in the bit area c in Fig. 23. Therefore, the terminal 41 in the store fails to identify the card holder using the PIN, and he or she cannot purchase goods. Then, the registration of PIN in the PIN registration step is required. In such a case, however, as described above referring to Fig. 1, for registering PIN by user terminal 32, the IPIN mailed from the issuer to the user is required for the PIN write key code. Therefore, if the IC card 11 is stolen, the registration of a false PIN is absolutely rejected. In this way, the misuse is prevented. If a person attempts to misuse an IC card which has not been subjected to the normal method of card manufacture, issuance, and PIN registration, the card status data ST in the data memory 65 of the card checks such IC card, to guard against card fraud. Further, if the bit areas As seen from the foregoing, with such an arrangement of the IC card system, in the sequence of the steps B3 A2 A5 in Fig. 6 A , the answer to reset data stored in data ROM 52 of card 11 is sent to terminal 41, and stored in initial parameter RAM 75. On the basis of the condition setting data as stored in RAM 76, it is possible to set the maximum data transfer capacity limited by main controller 77, the data write voltage set by Vpp power source 95, continuous application time of the data write voltage set by Vpp timer 96, and the like. Further, after the operating condition setting in the IC card 11, the ENQ signal is sent to IC card 11 in order to check the normal operation of the IC card 11. This is made in steps A7 to B4. For this operation check, a check is made whether the card 11 can normally receive this ENQ signal. If it is not normally received, step B8 executes the transmission of the NAC signal to terminal 41. Then, the control advances to the card rejection process after passing steps A11 to A13. When the IC card 11 does not operate normally under the operating conditions as set by terminal 41, the control does not move to the information exchange process, and the signal transmission between terminal 41 and card 11 is cancelled. As seen from the foregoing, according to this invention, the data representing the operating conditions of the IC card per se are stored in the card. In setting the card to the terminal, the IC card is operated by the card terminal on the basis of the operating conditions setting data as stored in the IC card. Then, the signal for checking the normal operation is transferred between the terminal and the card. This check signal is used for checking the compatibility of the IC card with the terminal. Therefore, if the operating conditions of the IC card are changed due to its improved performance, the operating conditions can be set by the terminal, according to the type of the IC card used. Further, the operation status of the IC card for which the new operating conditions have been set, can be checked, to prevent the occurrence of trouble before the information exchange process. Thus, the security of transactions using IC cards becomes very high.